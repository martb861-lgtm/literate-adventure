<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Salary Tracker">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="UK shift-based salary tracker with tax, NI, pension & overtime calculations">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Salary Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Geist+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#09090b;--s:#111114;--s2:#18181b;--s3:#222225;--bd:rgba(255,255,255,.06);--bd2:rgba(255,255,255,.1);
  --tx:#fafafa;--tx2:#a1a1aa;--tx3:#52525b;
  --bl:#6366f1;--bl2:#818cf8;--blg:linear-gradient(135deg,#6366f1,#8b5cf6);
  --gn:#22c55e;--gn2:#4ade80;--gng:linear-gradient(135deg,#22c55e,#10b981);
  --rd:#ef4444;--rd2:#f87171;
  --or:#f59e0b;--or2:#fbbf24;
  --pu:#a78bfa;--pu2:#c4b5fd;
  --yw:#eab308;
  --r:16px;--rs:10px;
  --glass:rgba(255,255,255,.03);--glass2:rgba(255,255,255,.05);
  --scheme:dark
}
html.light{
  --bg:#d5d7db;--s:#dddfe3;--s2:#d0d2d6;--s3:#c4c7cc;--bd:rgba(0,0,0,.12);--bd2:rgba(0,0,0,.18);
  --tx:#111114;--tx2:#3f3f46;--tx3:#71717a;
  --bl:#4338ca;--bl2:#4f46e5;--blg:linear-gradient(135deg,#4338ca,#6d28d9);
  --gn:#15803d;--gn2:#16a34a;--gng:linear-gradient(135deg,#15803d,#047857);
  --rd:#b91c1c;--rd2:#dc2626;
  --or:#b45309;--or2:#d97706;
  --pu:#6d28d9;--pu2:#7c3aed;
  --yw:#a16207;
  --glass:rgba(0,0,0,.03);--glass2:rgba(0,0,0,.06);
  --scheme:light
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;font-size:14px;-webkit-font-smoothing:antialiased;overflow-x:hidden}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 20%,rgba(99,102,241,.04) 0%,transparent 50%),radial-gradient(circle at 70% 80%,rgba(139,92,246,.03) 0%,transparent 50%);pointer-events:none;z-index:0}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:10px}
.ic{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;line-height:0}
.ic svg{width:18px;height:18px;stroke-width:1.8}
.ic-accent{width:32px;height:32px;border-radius:10px;background:var(--blg);display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
.ic-accent svg{width:16px;height:16px;stroke:white;stroke-width:2;fill:none}
.ic-accent-gn{background:var(--gng)}.ic-accent-rd{background:linear-gradient(135deg,#ef4444,#dc2626)}.ic-accent-or{background:linear-gradient(135deg,#f59e0b,#d97706)}.ic-accent-pu{background:linear-gradient(135deg,#a78bfa,#8b5cf6)}
.hd{background:rgba(17,17,20,.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--bd);padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top,12px));display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;z-index:50}
html.light .hd{background:color-mix(in srgb,var(--bg) 92%,transparent)}
.hd h1{font-size:16px;font-weight:700;letter-spacing:-.3px;display:flex;align-items:center;gap:8px;white-space:nowrap}
.hd h1 .logo{width:26px;height:26px;min-width:26px;border-radius:7px;background:var(--blg);display:flex;align-items:center;justify-content:center;box-shadow:0 0 16px rgba(99,102,241,.3)}
.hd h1 .logo svg{width:14px;height:14px;stroke:white;stroke-width:2.2;fill:none}
.hd-sub{font-size:11px;color:var(--tx3);margin-top:1px;font-family:'Geist Mono',monospace;letter-spacing:.3px}
.hd-r{display:flex;align-items:center;gap:6px;flex-shrink:0}.bdg-row{display:flex;gap:5px;flex-wrap:wrap}
@media(max-width:420px){.bdg-row{display:none}}
.bdg{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;font-family:'Geist Mono',monospace}
.bdg-g{background:rgba(34,197,94,.1);color:var(--gn2)}
.bdg-b{background:rgba(99,102,241,.1);color:var(--bl2)}
html.light .bdg-g{color:var(--gn)}html.light .bdg-b{color:var(--bl)}
.set-btn{background:var(--glass2);border:1px solid var(--bd);color:var(--tx2);width:36px;height:36px;border-radius:var(--rs);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;flex-shrink:0}
.set-btn svg{width:18px;height:18px;stroke-width:1.8}
.set-btn:hover{background:var(--glass);color:var(--tx);border-color:var(--bl)}
.nav{background:rgba(17,17,20,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--bd);position:fixed;bottom:0;left:0;right:0;z-index:50;padding:0;padding-bottom:env(safe-area-inset-bottom,0)}
.nav-s{display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:0 4px}
.nav-s::-webkit-scrollbar{display:none}
html.light .nav{background:color-mix(in srgb,var(--bg) 94%,transparent)}
.nb{flex:0 0 auto;min-width:72px;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 10px;border:none;background:0 0;color:var(--tx3);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer;transition:.2s;border-top:2px solid transparent}
.nb .ni{display:flex;align-items:center;justify-content:center}.nb .ni svg{width:20px;height:20px;stroke-width:1.8;transition:all .2s}
.nb.tab-hidden{display:none}
.nb.a{color:var(--bl2);border-top-color:var(--bl)}.nb.a .ni svg{stroke:var(--bl2)}.nb:hover:not(.a){color:var(--tx2)}
@media(min-width:769px){.nav{position:static;border-top:0;border-bottom:1px solid var(--bd)}.nav-s{padding:0 16px}.nb{flex-direction:row;gap:6px;padding:12px 16px;font-size:12px;border-top:0;border-bottom:2px solid transparent}.nb.a{border-top:0;border-bottom-color:var(--bl)}}
.main{max-width:1100px;margin:0 auto;padding:14px;padding-bottom:calc(80px + env(safe-area-inset-bottom,0));position:relative;z-index:1}
@media(min-width:769px){.main{padding:20px;padding-bottom:20px}}
.pn{display:none}.pn.a{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.cd{background:var(--s);border:1px solid var(--bd);border-radius:var(--r);padding:20px;margin-bottom:14px;position:relative;overflow:hidden}
.cd-bl{border-left:3px solid var(--bl)}.cd-gn{border-left:3px solid var(--gn)}.cd-rd{border-left:3px solid var(--rd)}.cd-or{border-left:3px solid var(--or)}.cd-pu{border-left:3px solid var(--pu)}
.cd h3{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.sg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
@media(min-width:640px){.sg{grid-template-columns:repeat(4,1fr)}}
.st{background:var(--s2);border:1px solid var(--bd);border-radius:var(--r);padding:14px;transition:all .2s}
.st:hover{border-color:var(--bd2)}
.st-l{font-size:10px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.st-v{font-size:20px;font-weight:800;font-family:'Geist Mono',monospace;letter-spacing:-.5px}
.st-s{font-size:10px;color:var(--tx3);margin-top:3px;font-family:'Geist Mono',monospace}
.fg{margin-bottom:14px}.fl{display:block;font-size:11px;font-weight:600;color:var(--tx2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
.iw{display:flex;align-items:center;background:var(--s2);border:1.5px solid var(--bd);border-radius:var(--rs);overflow:hidden;transition:.2s}
.iw:focus-within{border-color:var(--bl)}
.ip,.is{padding:8px 10px;color:var(--tx3);font-size:12px;font-weight:600;font-family:'Geist Mono',monospace;background:var(--s3);flex-shrink:0}
.ip{border-right:1px solid var(--bd)}.is{border-left:1px solid var(--bd)}
input.fi,select.fi{flex:1;padding:9px 12px;border:none;outline:none;font-size:13px;font-family:'DM Sans',sans-serif;color:var(--tx);background:0 0;min-width:0}
input[type="date"].fi{color-scheme:var(--scheme)}select.fi{cursor:pointer}
select.sf{width:100%;padding:8px 10px;background:var(--s2);border:1.5px solid var(--bd);border-radius:var(--rs);font-size:13px;font-family:inherit;color:var(--tx);cursor:pointer;outline:none}
.fh{font-size:10px;color:var(--tx3);margin-top:3px}
.btn{padding:8px 16px;border:none;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn svg{flex-shrink:0}
.bp{background:var(--blg);color:#fff;box-shadow:0 2px 10px rgba(99,102,241,.15)}.bp:hover{box-shadow:0 4px 16px rgba(99,102,241,.3);transform:translateY(-1px)}
.bdn{background:rgba(239,68,68,.1);color:var(--rd)}.bdn:hover{background:rgba(239,68,68,.18)}
.bg{background:var(--s2);color:var(--tx2);border:1px solid var(--bd)}.bg:hover{background:var(--s3);color:var(--tx)}
.bs{padding:5px 10px;font-size:11px}.bx{padding:4px 8px;font-size:10px}
.sr{display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:8px 10px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--s2);flex-wrap:wrap}
.sr.day{background:rgba(34,197,94,.04);border-color:rgba(34,197,94,.12)}.sr.night{background:rgba(99,102,241,.04);border-color:rgba(99,102,241,.12)}
.sr select,.sr input{padding:5px 8px;background:var(--s3);border:1px solid var(--bd);border-radius:5px;color:var(--tx);font-size:11px;font-family:inherit}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.dt{width:100%;border-collapse:separate;border-spacing:0;font-size:12px}
.dt th{padding:8px;background:var(--s2);font-weight:700;color:var(--tx3);text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--bd);white-space:nowrap;position:sticky;top:0;z-index:1}
.dt th.r{text-align:right}.dt td{padding:8px;border-bottom:1px solid var(--bd);white-space:nowrap}
.dt th.fr,.dt td.fr{position:sticky;left:0;z-index:2;background:var(--s)}.dt th.fr{z-index:3;background:var(--s2)}
.dt td.r{text-align:right;font-family:'Geist Mono',monospace;font-size:11px}
.dt tr:hover{background:rgba(99,102,241,.03)}.dt tr:hover td.fr{background:var(--s)}.dt tr.cu{background:rgba(99,102,241,.06)!important}.dt tr.cu td.fr{background:var(--s)!important}
.dt tfoot td{padding:10px 8px;font-weight:700;border-top:2px solid var(--gn);background:rgba(34,197,94,.04)!important}
.dt tfoot td.fr{background:var(--s)!important}
.dt input[type="number"],.dt input[type="date"]{padding:5px 8px;background:var(--s3);border:1px solid var(--bd);border-radius:5px;color:var(--tx);font-size:11px;font-family:inherit}
.dt input[type="number"]{width:60px;text-align:center}.dt input[type="date"]{width:130px;color-scheme:var(--scheme)}
.xr{display:none}.xr.sh{display:table-row}.xr td{background:var(--s2)!important;padding:14px!important}
.dg{display:grid;grid-template-columns:auto 1fr;gap:3px 12px;font-size:11px;max-width:250px}
.dg .dl{color:var(--tx3)}.dg .dv{text-align:right;font-weight:600;font-family:'Geist Mono',monospace;font-size:11px}
.ib{padding:10px 12px;background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.1);border-radius:var(--rs);font-size:11px;color:var(--bl2);line-height:1.5;margin-top:10px}
.ib.w{background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.1);color:var(--or2)}
html.light .ib{color:var(--bl)}html.light .ib.w{color:var(--or)}
.yb{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.yr{padding:7px 14px;border:1.5px solid var(--bd);border-radius:var(--rs);background:var(--s);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--tx2);transition:.2s}
.yr.a{border-color:var(--bl);background:rgba(99,102,241,.1);color:var(--bl2)}.yr:hover:not(.a){border-color:var(--tx3)}
.sg2{display:grid;grid-template-columns:auto 1fr;gap:3px 12px;font-size:12px}
.sg2 .sl{color:var(--tx3)}.sg2 .sv{text-align:right;font-weight:600;font-family:'Geist Mono',monospace;font-size:12px}
.l2{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:769px){.l2{grid-template-columns:1fr 1fr}}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:480px){.g2{grid-template-columns:1fr}}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:100;opacity:0;pointer-events:none;transition:.3s}.ov.o{opacity:1;pointer-events:all}
.dw{position:fixed;top:0;right:-100%;width:100%;max-width:480px;height:100%;background:var(--bg);z-index:101;overflow-y:auto;transition:right .35s cubic-bezier(.4,0,.2,1);padding:0;border-left:1px solid var(--bd)}.dw.o{right:0}
.dw-h{position:sticky;top:0;background:var(--s);border-bottom:1px solid var(--bd);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;z-index:5}
.dw-h h2{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.cb{background:var(--glass2);border:1px solid var(--bd2);color:var(--tx2);width:34px;height:34px;min-width:34px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.cb:hover{color:var(--tx);background:var(--s3);border-color:var(--bd2)}
.cb svg{width:18px;height:18px;stroke-width:2}
.dw-b{padding:16px}
.ss{margin-bottom:20px}
.ss h4{font-size:12px;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px}.mo.o{display:flex}
.ml{background:var(--s);border:1px solid var(--bd);border-radius:var(--r);width:100%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.3)}
.ml-h{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.ml-h h3{font-size:15px;font-weight:700}.ml-b{padding:16px}
.ml-f{padding:12px 16px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.ei{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:6px;font-size:12px;flex-wrap:wrap}
.tg{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
.tg-bo{background:rgba(234,179,8,.1);color:var(--yw)}.tg-ot{background:rgba(99,102,241,.1);color:var(--bl2)}.tg-bh{background:rgba(239,68,68,.1);color:var(--rd2)}
.ei .am{font-family:'Geist Mono',monospace;font-weight:600;margin-left:auto}
.ei .db{background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:4px;transition:.2s;border-radius:4px;display:flex;align-items:center;justify-content:center}.ei .db:hover{color:var(--rd);background:rgba(239,68,68,.08)}
.cc{display:flex;align-items:flex-end;gap:4px;height:100px;padding:12px 0;flex-wrap:wrap}
.cc-row{display:flex;align-items:flex-end;gap:4px;width:100%;height:100px}
.cw{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.cv{font-size:8px;font-weight:600;font-family:'Geist Mono',monospace;color:var(--tx2)}
.cb2{width:100%;max-width:40px;border-radius:4px 4px 0 0;min-height:3px;transition:.3s}
.cl{font-size:9px;color:var(--tx3);font-weight:500}
.pb{background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.12);border-radius:var(--rs);padding:12px;margin-top:8px}
@media(max-width:480px){.cd h3{font-size:12px;gap:6px}}

.ss-col{margin-bottom:4px;border:1px solid var(--bd);border-radius:var(--rs);overflow:hidden}
.ss-col-h{display:flex;align-items:center;gap:8px;padding:12px 14px;cursor:pointer;background:var(--s2);transition:.2s;user-select:none}
.ss-col-h:hover{background:var(--s3)}
.ss-col-h .ss-arr{font-size:10px;color:var(--tx3);transition:transform .2s;flex-shrink:0}
.ss-col-h .ss-arr.open{transform:rotate(90deg)}
.ss-col-h .ss-ttl{font-size:12px;font-weight:700;color:var(--tx);flex:1}
.ss-col-h .ss-desc{font-size:10px;color:var(--tx3);font-weight:400}
.ss-col-b{display:none;padding:14px;border-top:1px solid var(--bd)}
.ss-col-b.open{display:block}
.theme-toggle{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);cursor:pointer;transition:.2s;margin-bottom:14px}
.theme-toggle:hover{border-color:var(--bd2)}
.theme-toggle .tl{font-size:12px;font-weight:600;color:var(--tx2);flex:1}
.theme-sw{width:44px;height:24px;border-radius:12px;background:var(--s3);border:1px solid var(--bd2);position:relative;transition:.2s;flex-shrink:0}
.theme-sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:9px;background:var(--tx2);transition:.2s}
html.light .theme-sw{background:var(--bl)}
html.light .theme-sw::after{left:22px;background:white}
</style>
</head>
<body>
<div class="hd">
  <div>
    <h1>
      <span class="logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 19H6a4 4 0 0 0 4-4V9a4 4 0 0 1 7-2.6"/><line x1="7" y1="14" x2="15" y2="14"/></svg></span>
      Salary Tracker
    </h1>
    <div class="hd-sub" id="hSub"></div>
  </div>
  <div class="hd-r">
    <div class="bdg-row" id="hBdg"></div>
    <button class="set-btn" onclick="openS()" title="Settings">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
  </div>
</div>
<div class="nav"><div class="nav-s">
<button class="nb a" onclick="sw('dash')" id="t-dash"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg></span>Dashboard</button>
<button class="nb" onclick="sw('per')" id="t-per"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>Periods</button>
<button class="nb" onclick="sw('bd')" id="t-bd"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 19H6a4 4 0 0 0 4-4V9a4 4 0 0 1 7-2.6"/><line x1="7" y1="14" x2="15" y2="14"/></svg></span>Breakdown</button>
<button class="nb" onclick="sw('ann')" id="t-ann"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>Annual</button>
<button class="nb" onclick="sw('acc')" id="t-acc"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></span>Accounts</button>
<button class="nb" onclick="sw('spend')" id="t-spend"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></span>Spending</button>
<button class="nb" onclick="sw('pf')" id="t-pf"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></span>Pension</button>
<button class="nb" onclick="sw('cal')" id="t-cal"><span class="ni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="9" y1="16" x2="15" y2="16"/></svg></span>Calendar</button>
</div></div>
<div class="main">
<div class="pn a" id="c-dash"></div>
<div class="pn" id="c-per"></div>
<div class="pn" id="c-bd"></div>
<div class="pn" id="c-ann"></div>
<div class="pn" id="c-acc"></div>
<div class="pn" id="c-spend"></div>
<div class="pn" id="c-pf"></div>
<div class="pn" id="c-cal"></div>
</div>
<div class="ov" id="sOv" onclick="closeS()"></div>
<div class="dw" id="sDw"><div class="dw-h"><h2><span class="ic"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></span> Settings</h2><button class="cb" onclick="closeS()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="dw-b" id="sB"></div></div>
<div class="mo" id="eM"><div class="ml"><div class="ml-h"><h3 id="eMT">Add Payment</h3><button class="cb" onclick="cEM()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ml-b" id="eMB"></div><div class="ml-f"><button class="btn bg" onclick="cEM()">Cancel</button><button class="btn bp" id="eMSB" onclick="sEP()">Add Payment</button></div></div></div>
<div class="mo" id="acM"><div class="ml"><div class="ml-h"><h3 id="acMT">Add Account</h3><button class="cb" onclick="cAcM()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ml-b" id="acMB"></div><div class="ml-f"><button class="btn bg" onclick="cAcM()">Cancel</button><button class="btn bp" id="acMSB" onclick="sAcct()">Add Account</button></div></div></div>
<div class="mo" id="txM"><div class="ml"><div class="ml-h"><h3 id="txMT">Add Transaction</h3><button class="cb" onclick="cTxM()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ml-b" id="txMB"></div><div class="ml-f"><button class="btn bg" onclick="cTxM()">Cancel</button><button class="btn bp" id="txMSB" onclick="sTxn()">Add Transaction</button></div></div></div>
<div class="mo" id="spM"><div class="ml"><div class="ml-h"><h3 id="spMT">Add Expense</h3><button class="cb" onclick="cSpM()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ml-b" id="spMB"></div><div class="ml-f"><button class="btn bg" onclick="cSpM()">Cancel</button><button class="btn bp" id="spMSB" onclick="sExp()">Add Expense</button></div></div></div>
<div class="mo" id="wzM"><div class="ml" style="max-width:540px"><div class="ml-h"><h3 id="wzMT">Setup Wizard</h3><button class="cb" onclick="wzClose()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ml-b" id="wzMB" style="max-height:65vh;overflow-y:auto"></div><div class="ml-f" id="wzMF"></div></div></div>
<script>
// ═══ SVG ICON HELPERS ═══
var ICO={
  pin:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>',
  chart:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  cal:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  pound:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 19H6a4 4 0 0 0 4-4V9a4 4 0 0 1 7-2.6"/><line x1="7" y1="14" x2="15" y2="14"/></svg>',
  trend:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  clip:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  bank:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
  bldg:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>',
  dl:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  lock:'<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
  unlock:'<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
  plus:'<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  trash:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  warn:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  clock:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  refresh:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',
  edit:'<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  x:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
};
function ic(name,cls){return '<span class="ic'+(cls?' '+cls:'')+'" style="line-height:0">'+ICO[name]+'</span>'}

// ═══ THEME ═══
function initTheme(){try{if(localStorage.getItem('st7-theme')==='light'){document.documentElement.classList.add('light');applyLightScale();var mc=document.querySelector('meta[name="theme-color"]');if(mc)mc.setAttribute('content','#d5d7db')}else{applyDarkAccent()}}catch(e){}}
function toggleTheme(){
  document.documentElement.classList.toggle('light');
  var isLight=document.documentElement.classList.contains('light');
  try{localStorage.setItem('st7-theme',isLight?'light':'dark')}catch(e){}
  var mc=document.querySelector('meta[name="theme-color"]');
  if(mc)mc.setAttribute('content',isLight?'#d5d7db':'#09090b');
  if(isLight)applyLightScale();else clearLightScale();
  if(document.getElementById('sDw').classList.contains('o'))rS();
}

// Light theme customisation
var ltCfg={level:50,accent:'indigo',darkAccent:'indigo'};
function ldLtCfg(){try{var s=localStorage.getItem('st7-ltcfg');if(s)ltCfg=JSON.parse(s)}catch(e){}if(!ltCfg||typeof ltCfg!=='object')ltCfg={level:50,accent:'indigo',darkAccent:'indigo'};if(ltCfg.level===undefined)ltCfg.level=50;if(!ltCfg.accent)ltCfg.accent='indigo';if(!ltCfg.darkAccent)ltCfg.darkAccent='indigo'}
function svLtCfg(){try{localStorage.setItem('st7-ltcfg',JSON.stringify(ltCfg))}catch(e){}}
ldLtCfg();

var LT_ACCENTS={
  indigo:{bl:'#4338ca',bl2:'#4f46e5',blg:'linear-gradient(135deg,#4338ca,#6d28d9)',label:'Indigo'},
  blue:{bl:'#1d4ed8',bl2:'#2563eb',blg:'linear-gradient(135deg,#1d4ed8,#1e40af)',label:'Blue'},
  violet:{bl:'#6d28d9',bl2:'#7c3aed',blg:'linear-gradient(135deg,#6d28d9,#5b21b6)',label:'Violet'},
  teal:{bl:'#0d9488',bl2:'#14b8a6',blg:'linear-gradient(135deg,#0d9488,#0f766e)',label:'Teal'},
  rose:{bl:'#be123c',bl2:'#e11d48',blg:'linear-gradient(135deg,#be123c,#9f1239)',label:'Rose'},
  amber:{bl:'#b45309',bl2:'#d97706',blg:'linear-gradient(135deg,#b45309,#92400e)',label:'Amber'},
  slate:{bl:'#475569',bl2:'#64748b',blg:'linear-gradient(135deg,#475569,#334155)',label:'Slate'}
};
var DK_ACCENTS={
  indigo:{bl:'#6366f1',bl2:'#818cf8',blg:'linear-gradient(135deg,#6366f1,#8b5cf6)',label:'Indigo'},
  blue:{bl:'#3b82f6',bl2:'#60a5fa',blg:'linear-gradient(135deg,#3b82f6,#2563eb)',label:'Blue'},
  violet:{bl:'#8b5cf6',bl2:'#a78bfa',blg:'linear-gradient(135deg,#8b5cf6,#7c3aed)',label:'Violet'},
  teal:{bl:'#14b8a6',bl2:'#2dd4bf',blg:'linear-gradient(135deg,#14b8a6,#0d9488)',label:'Teal'},
  rose:{bl:'#f43f5e',bl2:'#fb7185',blg:'linear-gradient(135deg,#f43f5e,#e11d48)',label:'Rose'},
  amber:{bl:'#f59e0b',bl2:'#fbbf24',blg:'linear-gradient(135deg,#f59e0b,#d97706)',label:'Amber'},
  slate:{bl:'#64748b',bl2:'#94a3b8',blg:'linear-gradient(135deg,#64748b,#475569)',label:'Slate'}
};

function applyLightScale(){
  if(!document.documentElement.classList.contains('light'))return;
  var el=document.documentElement;
  var lv=ltCfg.level;// 0=brightest(white), 50=default, 100=darkest
  // Background scale: level 0 = hsl(228,8%,97%), level 50 = hsl(228,8%,85%), level 100 = hsl(228,8%,30%)
  var bgL=97-(lv/100)*67; // 97 down to 30
  var sL=bgL+3,s2L=bgL-1,s3L=bgL-4;
  // Text: darken as bg gets lighter, lighten as bg gets darker
  var txL=lv<50?8:Math.min(95,60+(lv-50)*0.7);
  var tx2L=lv<50?25:Math.min(85,40+(lv-50)*0.6);
  var tx3L=lv<50?45:Math.min(70,50+(lv-50)*0.4);
  // Border opacity scales with darkness
  var bdOp=0.12+(lv/100)*0.15;
  var bd2Op=bdOp+0.06;
  // Glass
  var glOp=0.03+(lv/100)*0.05;
  var gl2Op=glOp*2;
  el.style.setProperty('--bg','hsl(228,8%,'+bgL.toFixed(1)+'%)');
  el.style.setProperty('--s','hsl(228,8%,'+sL.toFixed(1)+'%)');
  el.style.setProperty('--s2','hsl(228,8%,'+s2L.toFixed(1)+'%)');
  el.style.setProperty('--s3','hsl(228,8%,'+s3L.toFixed(1)+'%)');
  if(lv>65){
    // Dark enough to need light text
    el.style.setProperty('--tx','hsl(0,0%,'+txL.toFixed(1)+'%)');
    el.style.setProperty('--tx2','hsl(0,0%,'+tx2L.toFixed(1)+'%)');
    el.style.setProperty('--tx3','hsl(0,0%,'+tx3L.toFixed(1)+'%)');
    el.style.setProperty('--bd','rgba(255,255,255,'+bdOp.toFixed(3)+')');
    el.style.setProperty('--bd2','rgba(255,255,255,'+bd2Op.toFixed(3)+')');
    el.style.setProperty('--glass','rgba(255,255,255,'+glOp.toFixed(3)+')');
    el.style.setProperty('--glass2','rgba(255,255,255,'+gl2Op.toFixed(3)+')');
  } else {
    el.style.setProperty('--tx','hsl(240,10%,8%)');
    el.style.setProperty('--tx2','hsl(240,4%,'+tx2L.toFixed(1)+'%)');
    el.style.setProperty('--tx3','hsl(240,3%,'+tx3L.toFixed(1)+'%)');
    el.style.setProperty('--bd','rgba(0,0,0,'+bdOp.toFixed(3)+')');
    el.style.setProperty('--bd2','rgba(0,0,0,'+bd2Op.toFixed(3)+')');
    el.style.setProperty('--glass','rgba(0,0,0,'+glOp.toFixed(3)+')');
    el.style.setProperty('--glass2','rgba(0,0,0,'+gl2Op.toFixed(3)+')');
  }
  // Green/red/etc also need adjusting at very dark levels
  if(lv>65){
    el.style.setProperty('--gn','#22c55e');el.style.setProperty('--gn2','#4ade80');
    el.style.setProperty('--gng','linear-gradient(135deg,#22c55e,#10b981)');
    el.style.setProperty('--rd','#ef4444');el.style.setProperty('--rd2','#f87171');
    el.style.setProperty('--or','#f59e0b');el.style.setProperty('--or2','#fbbf24');
    el.style.setProperty('--pu','#a78bfa');el.style.setProperty('--pu2','#c4b5fd');
    el.style.setProperty('--yw','#eab308');
  } else {
    el.style.setProperty('--gn','#15803d');el.style.setProperty('--gn2','#16a34a');
    el.style.setProperty('--gng','linear-gradient(135deg,#15803d,#047857)');
    el.style.setProperty('--rd','#b91c1c');el.style.setProperty('--rd2','#dc2626');
    el.style.setProperty('--or','#b45309');el.style.setProperty('--or2','#d97706');
    el.style.setProperty('--pu','#6d28d9');el.style.setProperty('--pu2','#7c3aed');
    el.style.setProperty('--yw','#a16207');
  }
  // Apply accent colour
  var ac=LT_ACCENTS[ltCfg.accent]||LT_ACCENTS.indigo;
  if(lv>65){
    // Brighten accents for dark backgrounds
    var acDark=LT_ACCENTS[ltCfg.accent+'_dark'];
    if(!acDark){
      // Use dark-mode-friendly versions
      var dkMap={indigo:['#818cf8','#a5b4fc'],blue:['#60a5fa','#93c5fd'],violet:['#a78bfa','#c4b5fd'],teal:['#2dd4bf','#5eead4'],rose:['#fb7185','#fda4af'],amber:['#fbbf24','#fde68a'],slate:['#94a3b8','#cbd5e1']};
      var dk=dkMap[ltCfg.accent]||dkMap.indigo;
      el.style.setProperty('--bl',dk[0]);el.style.setProperty('--bl2',dk[1]);
      el.style.setProperty('--blg','linear-gradient(135deg,'+dk[0]+','+dk[1]+')');
    }
  } else {
    el.style.setProperty('--bl',ac.bl);el.style.setProperty('--bl2',ac.bl2);
    el.style.setProperty('--blg',ac.blg);
  }
  // Theme-color meta
  var bgHex=hslToHex(228,8,bgL);
  var mc=document.querySelector('meta[name="theme-color"]');
  if(mc)mc.setAttribute('content',bgHex);
}

function clearLightScale(){
  var el=document.documentElement;
  ['--bg','--s','--s2','--s3','--bd','--bd2','--tx','--tx2','--tx3','--bl','--bl2','--blg','--gn','--gn2','--gng','--rd','--rd2','--or','--or2','--pu','--pu2','--yw','--glass','--glass2'].forEach(function(p){el.style.removeProperty(p)});
  applyDarkAccent();
}

function applyDarkAccent(){
  var el=document.documentElement;
  var ac=DK_ACCENTS[ltCfg.darkAccent];
  if(!ac||ltCfg.darkAccent==='indigo'){
    // Default — remove overrides so CSS :root applies
    el.style.removeProperty('--bl');el.style.removeProperty('--bl2');el.style.removeProperty('--blg');
    return;
  }
  el.style.setProperty('--bl',ac.bl);
  el.style.setProperty('--bl2',ac.bl2);
  el.style.setProperty('--blg',ac.blg);
}

function setDarkAccent(a){ltCfg.darkAccent=a;svLtCfg();applyDarkAccent();if(document.getElementById('sDw').classList.contains('o'))rS()}

function hslToHex(h,s,l){
  l/=100;s/=100;
  var a=s*Math.min(l,1-l);
  function f(n){var k=(n+h/30)%12;var c=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*c).toString(16).padStart(2,'0')}
  return'#'+f(0)+f(8)+f(4);
}

function setLightLevel(v){ltCfg.level=+v;svLtCfg();applyLightScale();if(document.getElementById('sDw').classList.contains('o'))rS()}
function setLightAccent(a){ltCfg.accent=a;svLtCfg();applyLightScale();if(document.getElementById('sDw').classList.contains('o'))rS()}
initTheme();

var HMRC={};
HMRC['2025/26']={pa:12570,bb:37700,pat:100000,nPT:242,nUEL:967,nM:8,nA:2};
HMRC['2026/27']={pa:12570,bb:37700,pat:100000,nPT:242,nUEL:967,nM:8,nA:2};
HMRC['2024/25']={pa:12570,bb:37700,pat:100000,nPT:242,nUEL:967,nM:8,nA:2};
// Scottish tax bands (applied when taxRegion=scotland)
var SCOT_TAX={'2025/26':{starter:{r:19,b:2306},basic:{r:20,b:11991},inter:{r:21,b:17911},higher:{r:42,b:62430},adv:{r:45,b:62430},top:{r:48}},'2026/27':{starter:{r:19,b:2306},basic:{r:20,b:11991},inter:{r:21,b:17911},higher:{r:42,b:62430},adv:{r:45,b:62430},top:{r:48}}};
// Student loan thresholds (annual)
var STLOAN={plan1:{thresh:22015,rate:9},plan2:{thresh:27295,rate:9},plan4:{thresh:27660,rate:9},plan5:{thresh:25000,rate:9},postgrad:{thresh:21000,rate:6}};
var DEFAULT_DATA={};
var years={},aYr='2025/26',cfg,tax,aTab='dash',eMI=-1,eEI=-1,perLocked=true;
var P='\u00A3';
function dCfg(){return{sal:0,shw:39,saPct:0,taxCode:'1257L',niCat:'A',otR:{'1.33':1.33,'1.5':1.5,'2.0':2},patternStart:'',sp:[{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'off'},{t:'off'}],midYearEnabled:false,midYearMonth:6,midYearSal:0,penTiers:[{emp:4,comp:8},{emp:5,comp:9},{emp:6,comp:10}],compMaxPct:10,profile:'office-regular',payFreq:'monthly',payBasis:'salaried',hourlyRate:0,taxRegion:'england',studentLoans:[],sacrifices:[],payMode:'arrears',otRules:[{days:[1,2,3,4,5],hours:0,rate:1,label:'None'}],shiftTypes:[{id:'day',label:'Day',hours:8,totalHours:8.5,allowancePct:0,color:'var(--gn)'},{id:'off',label:'Off',hours:0,totalHours:0,allowancePct:0,color:'var(--tx3)'}],unpaidBreak:0.5,setupDone:false,bhIncludeSA:false}}
function dPer(){var mo=['March','April','May','June','July','August','September','October','November','December','January','February','March'];return mo.map(function(m){return{m:m,mW:4,penPct:0,start:'',end:'',cutoff:'',payDate:'',extras:[]}})}
function dTax(){return JSON.parse(JSON.stringify(HMRC['2025/26']))}
function init(){
  try{var s=localStorage.getItem('st7');if(s)years=JSON.parse(s)}catch(e){}
  // Determine current tax year
  var now=new Date(),cy=now.getFullYear(),cm=now.getMonth()+1;
  var curTaxYr=cm>=4?cy+'/'+(String(cy+1).slice(2)):(cy-1)+'/'+(String(cy).slice(2));
  if(!Object.keys(years).length){
    // Brand new user - create empty year, will show wizard
    years[curTaxYr]={cfg:dCfg(),tax:dTax(),periods:dPer()};
    years[curTaxYr].cfg.setupDone=false;
    aYr=curTaxYr;
  }
  Object.keys(years).forEach(function(yr){if(years[yr].periods)years[yr].periods.forEach(function(p){if(!p.extras)p.extras=[];if(p.cutoff===undefined)p.cutoff='';if(p.payDate===undefined)p.payDate=''});if(years[yr].cfg){var c=years[yr].cfg;if(c.midYearEnabled===undefined)c.midYearEnabled=false;if(c.midYearMonth===undefined)c.midYearMonth=6;if(c.midYearSal===undefined)c.midYearSal=0;if(!c.salaryChanges)c.salaryChanges=[];if(!c.penTiers){c.penTiers=[{emp:4,comp:8},{emp:5,comp:9},{emp:6,comp:10}];if(c.compMatch!==undefined)delete c.compMatch;if(c.penPct!==undefined)delete c.penPct;if(c.penTier!==undefined)delete c.penTier}if(c.compMaxPct===undefined)c.compMaxPct=10;if(c.penMaxPct!==undefined){c.compMaxPct=c.penMaxPct;delete c.penMaxPct}
    // Profile migration — add new fields with backwards-compatible defaults
    if(!c.profile)c.profile='shift-rotating';
    if(!c.payFreq)c.payFreq='monthly';
    if(!c.payBasis)c.payBasis='salaried';
    if(c.hourlyRate===undefined)c.hourlyRate=0;
    if(!c.taxRegion)c.taxRegion='england';
    if(!c.studentLoans)c.studentLoans=[];
    if(!c.sacrifices)c.sacrifices=[];
    if(!c.payMode)c.payMode='arrears';
    if(c.midYearProfileEnabled===undefined)c.midYearProfileEnabled=!!c.midYearProfile;
    if(!c.otRules){
      // Migrate from old fixed OT: Mon-Thu=0.25h@1.33x, Fri=0.5h@1.33x, Sat=0.5h@1.5x, Sun=0.5h@2x
      c.otRules=[
        {days:[1,2,3,4],hours:0.25,rate:1.33,label:'Mon-Thu'},
        {days:[5],hours:0.5,rate:1.33,label:'Fri'},
        {days:[6],hours:0.5,rate:1.5,label:'Sat'},
        {days:[0],hours:0.5,rate:2.0,label:'Sun'}
      ];
    }
    if(!c.shiftTypes){
      // Migrate from old day/night/off to named shift types with individual allowances
      c.shiftTypes=[
        {id:'day',label:'Day',hours:11.25,totalHours:12,allowancePct:c.saPct||33.33,color:'var(--gn)'},
        {id:'night',label:'Night',hours:11.25,totalHours:12,allowancePct:c.saPct||33.33,color:'var(--bl)'},
        {id:'off',label:'Off',hours:0,totalHours:0,allowancePct:0,color:'var(--tx3)'}
      ];
    }
    // Ensure totalHours exists on all shift types
    if(c.shiftTypes)c.shiftTypes.forEach(function(st){if(st.totalHours===undefined)st.totalHours=12});
    if(c.unpaidBreak===undefined)c.unpaidBreak=0.5;
    if(c.bhIncludeSA===undefined)c.bhIncludeSA=false;
    if(!c.setupDone)c.setupDone=true; // Existing users have already configured
  }});
  try{var sy=localStorage.getItem('st7-yr');if(sy&&years[sy])aYr=sy}catch(e){}
  try{var st=localStorage.getItem('st7-tab');if(st&&document.getElementById('t-'+st))aTab=st}catch(e){}
  load(aYr);rAll();if(aTab!=='dash')sw(aTab);
  // Auto-show wizard for new users
  if(!cfg.setupDone){setTimeout(function(){wzOpen()},300)}
  applyTabOrder();applyTabVis();
}
function load(yr){aYr=yr;if(!years[yr])years[yr]={cfg:dCfg(),tax:dTax(),periods:dPer()};cfg=years[yr].cfg;tax=years[yr].tax}
function save(){years[aYr].cfg=cfg;years[aYr].tax=tax;try{localStorage.setItem('st7',JSON.stringify(years));localStorage.setItem('st7-yr',aYr)}catch(e){}}
function hr(){return cfg.sal/52/cfg.shw}
function gCM(empPct){var tiers=(cfg.penTiers||[]).slice().sort(function(a,b){return a.emp-b.emp});var comp=0;for(var i=0;i<tiers.length;i++){if(empPct>=tiers[i].emp)comp=tiers[i].comp}return comp}
function pTC(code){
  if(!code)return{pa:12570,mode:'L',desc:'Default: £12,570 personal allowance'};
  var c=code.toUpperCase().replace(/\s+/g,'').replace(/W1$/,'').replace(/M1$/,'').replace(/X$/,'');
  if(c==='NT')return{pa:0,mode:'NT',desc:'No tax deducted on this income'};
  if(c==='BR')return{pa:0,mode:'BR',desc:'All income taxed at basic rate (20%)'};
  if(c==='D0')return{pa:0,mode:'D0',desc:'All income taxed at higher rate (40%)'};
  if(c==='D1')return{pa:0,mode:'D1',desc:'All income taxed at additional rate (45%)'};
  if(c==='0T'||c==='S0T'||c==='C0T')return{pa:0,mode:'0T',desc:'No personal allowance \u2013 normal tax bands apply'};
  var km=c.match(/^K(\d+)/);if(km){var kv=parseInt(km[1])*10;return{pa:-kv,mode:'K',desc:'K code: £'+kv.toLocaleString()+' added to taxable income'}}
  var nm=c.match(/^S?C?(\d+)[LMNTY]?$/);if(nm){var pa=parseInt(nm[1])*10;return{pa:pa,mode:'L',desc:'Personal allowance: £'+pa.toLocaleString()}}
  return{pa:12570,mode:'L',desc:'Unrecognised code \u2013 using default £12,570 PA'}
}
function tcSel(){var v=document.getElementById('xTCS').value,cd=document.getElementById('tcCustom');if(v==='custom'){cd.style.display='';document.getElementById('xTC').focus()}else{cd.style.display='none';cfg.taxCode=v;save();rS()}}
function aPT(){cfg.penTiers.push({emp:0,comp:0});save();rS()}
function rPT(i){if(cfg.penTiers.length<=1){alert('Need at least one rule');return}cfg.penTiers.splice(i,1);save();rS()}

function fmt(v){return P+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}
function fmtNum2(v){return v%1===0?v.toString():v.toFixed(2).replace(/0+$/,'').replace(/\.$/,'')}
function fs(v){return P+Math.round(v).toLocaleString()}
function fd(d){if(!d)return'';var p=d.split('-');return p[2]+'/'+p[1]+'/'+p[0].substring(2)}
function sw(t){aTab=t;try{localStorage.setItem('st7-tab',t)}catch(e){}document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('a')});document.querySelectorAll('.pn').forEach(function(c){c.classList.remove('a')});var tb=document.getElementById('t-'+t);tb.classList.add('a');tb.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});document.getElementById('c-'+t).classList.add('a');rTab(t)}
function rTab(t){if(t==='dash')rDash();if(t==='per')rPer();if(t==='bd')rBD();if(t==='ann')rAnn();if(t==='acc')rAcc();if(t==='spend')rSpend();if(t==='pf')rPF();if(t==='cal')rCal()}
function rAll(){uHdr();rDash()}
function uHdr(){document.getElementById('hSub').textContent=aYr+' \u2022 Apr\u2013Mar';var r=hr();var bh='<span class="bdg bdg-g">'+fmt(cfg.sal)+'/yr</span>';if(cfg.salaryChanges&&cfg.salaryChanges.length>0){cfg.salaryChanges.forEach(function(sc){if(sc.sal>0)bh+='<span class="bdg bdg-g" style="background:rgba(91,138,245,.12);color:var(--bl)">'+fmt(sc.sal)+'/yr</span>'})}else if(cfg.midYearEnabled&&cfg.midYearSal>0){bh+='<span class="bdg bdg-g" style="background:rgba(91,138,245,.12);color:var(--bl)">'+fmt(cfg.midYearSal)+'/yr</span>'}bh+='<span class="bdg bdg-b">'+fmt(r)+'/hr</span>';document.getElementById('hBdg').innerHTML=bh}
function yBt(id){var c=document.getElementById(id);if(!c)return;var k=Object.keys(years).sort();c.innerHTML=k.map(function(y){return'<button class="yr'+(y===aYr?' a':'')+'" onclick="sYr(\''+y+'\')">'+y+'</button>'}).join('')+' <button class="btn bp bs" onclick="aYrF()">'+ICO.plus+' Year</button>'}
function dYr(yr){if(!confirm('Are you sure you want to delete '+yr+'?\n\nThis will permanently remove all data for this year.'))return;if(!confirm('This is permanent and cannot be undone.\n\nDelete '+yr+'?'))return;delete years[yr];var k=Object.keys(years).sort();if(k.length===0){years['2025/26']={cfg:dCfg(),tax:dTax(),periods:dPer()};k=['2025/26']}if(yr===aYr)load(k[0]);save();rAll();sw(aTab);if(document.getElementById('sDw').classList.contains('o'))rS()}
function resetAll(){
  var m1='⚠️ RESET EVERYTHING\n\nThis will permanently delete ALL your data:\n• All years & salary data\n• All accounts & transactions\n• All spending & budgets\n• All recurring expenses\n• All pension settings\n• All work profiles\n• All preferences\n\nHave you exported a backup?\nGo to Settings → Data Backup → Export first!\n\nThis CANNOT be undone.';
  if(!confirm(m1))return;
  if(!confirm('FINAL WARNING\n\nAre you absolutely sure?\nAll data will be permanently erased.\n\nClick OK to reset everything.'))return;
  // Clear all localStorage keys
  localStorage.clear();
  // Reload to fresh state — init() will see empty data and auto-show wizard
  location.reload();
}
function sYr(yr){load(yr);try{localStorage.setItem('st7-yr',yr)}catch(e){}rAll();sw(aTab);if(document.getElementById('sDw').classList.contains('o'))rS()}
function aYrF(){
  // Auto-calculate next year key
  var k=Object.keys(years).sort();var yr;
  if(k.length>0){
    var last=k[k.length-1];var parts=last.split('/');var startY=parseInt(parts[0]);
    yr=(startY+1)+'/'+(String(startY+2).slice(2));
  } else {
    var now=new Date();var cy=now.getFullYear();var cm=now.getMonth()+1;
    // Tax year starts April: if before April, current year is (cy-1)/cy
    if(cm>=4){yr=cy+'/'+(String(cy+1).slice(2))} else {yr=(cy-1)+'/'+(String(cy).slice(2))}
  }
  if(years[yr]){alert(yr+' already exists');return}
  var choice=prompt('Add '+yr+'?\n\nType COPY to copy settings from '+aYr+'\nType NEW to start fresh\nType WIZARD to start fresh with Setup Wizard\n\nOr press Cancel to abort.','COPY');
  if(choice===null)return;
  choice=choice.trim().toUpperCase();
  if(choice==='COPY'){var nc=JSON.parse(JSON.stringify(years[aYr].cfg));var nt=JSON.parse(JSON.stringify(years[aYr].tax));years[yr]={cfg:nc,tax:nt,periods:dPer()}}
  else if(choice==='NEW'){years[yr]={cfg:dCfg(),tax:dTax(),periods:dPer()}}
  else if(choice==='WIZARD'){years[yr]={cfg:dCfg(),tax:dTax(),periods:dPer()};save();sYr(yr);wzOpen();return}
  else{return}
  save();sYr(yr);
}
function isN(mn,sy){var now=new Date(),mi={January:0,February:1,March:2,April:3,May:4,June:5,July:6,August:7,September:8,October:9,November:10,December:11},m=mi[mn];if(m===undefined)return false;var yr=m<=2?sy+1:sy;return now.getMonth()===m&&now.getFullYear()===yr}
function gOM(ds){
  if(!ds)return 1.33;
  // Use configurable OT rules if available
  if(cfg.otRules&&cfg.otRules.length){
    var p=ds.split('-'),d=new Date(+p[0],+p[1]-1,+p[2]),w=d.getDay();
    for(var i=0;i<cfg.otRules.length;i++){
      if(cfg.otRules[i].days.indexOf(w)>=0)return cfg.otRules[i].rate||1.33;
    }
    return 1.33;
  }
  var p2=ds.split('-'),d2=new Date(+p2[0],+p2[1]-1,+p2[2]),w2=d2.getDay();return w2===0?2.0:w2===6?1.5:1.33;
}

function getShiftType(id){
  if(!cfg.shiftTypes)return null;
  for(var i=0;i<cfg.shiftTypes.length;i++){if(cfg.shiftTypes[i].id===id)return cfg.shiftTypes[i]}
  return null;
}

function cM(period,pIdx){
  // Get effective config (may be overridden by a work profile)
  var eCfg=getCfgForPeriod(pIdx);
  var useSal=eCfg.sal;
  // Multiple salary changes: find the latest one that applies to this period index
  if(eCfg.salaryChanges&&eCfg.salaryChanges.length>0&&typeof pIdx==='number'){
    var sorted=eCfg.salaryChanges.slice().sort(function(a,b){return a.month-b.month});
    for(var sci=0;sci<sorted.length;sci++){if(sorted[sci].sal>0&&pIdx>=sorted[sci].month)useSal=sorted[sci].sal}
  }
  // Legacy fallback
  else if(eCfg.midYearEnabled&&eCfg.midYearSal>0&&typeof pIdx==='number'&&pIdx>=eCfg.midYearMonth)useSal=eCfg.midYearSal;
  var r=eCfg.payBasis==='hourly'?(eCfg.hourlyRate||0):useSal/52/eCfg.shw;
  var bS=eCfg.payBasis==='hourly'?r*eCfg.shw*(52/12):useSal/12;
  var mH=eCfg.shw*period.mW;
  if(!period.start||!period.end){var cPct0=gCM(period.penPct*100);return{m:period.m,mW:period.mW,mH:mH,hW:0,bH:0,sHr:0,off:0,bS:bS,sOff:0,pP:period.penPct,pG:0,cPct:cPct0,cP:0,otBreak:[],otTotal:0,bHg:0,sA:0,holSup:0,bon:0,otX:0,gP:0,grossForHol:0,tx:0,ni:0,sl:0,sacT:0,tH:0,payDate:period.payDate||'',extras:period.extras||[],
  // Legacy compat
  o13h:0,o13g:0,o15h:0,o15g:0,o2h:0,o2g:0}};
  var s2=period.start.split('-'),e2=period.end.split('-');
  var sd=new Date(+s2[0],+s2[1]-1,+s2[2]),ed=new Date(+e2[0],+e2[1]-1,+e2[2]);
  var ps=new Date(eCfg.patternStart+'T00:00:00'),cl=eCfg.sp.length;
  var hW=0,cur=new Date(sd);
  var bhSet={};(period.extras||[]).forEach(function(ex){if(ex.type==='bh'&&ex.date)bhSet[ex.date]=ex});
  var otSet={};(period.extras||[]).forEach(function(ex){if(ex.type==='ot'&&ex.date)otSet[ex.date]=true});
  var bHtH=0,bHtP=0,exOTsH=0;
  // OT tracking per rule
  var otRules=eCfg.otRules||[{days:[1,2,3,4],hours:.25,rate:1.33},{days:[5],hours:.5,rate:1.33},{days:[6],hours:.5,rate:1.5},{days:[0],hours:.5,rate:2}];
  var otAccum={};otRules.forEach(function(rule,i){otAccum[i]={hours:0,gross:0,rate:rule.rate,label:rule.label||'OT'}});
  var unpaidBreak=eCfg.unpaidBreak!==undefined?eCfg.unpaidBreak:0.5;
  // Shift type lookup using effective config
  function eST(id){if(!eCfg.shiftTypes)return null;for(var i=0;i<eCfg.shiftTypes.length;i++){if(eCfg.shiftTypes[i].id===id)return eCfg.shiftTypes[i]}return null}
  // Track shift allowance per shift type
  var saByType={};
  // Holiday detection: build set of holiday dates with fraction info
  var holDaySet={};
  holidays.forEach(function(hol){
    if(!hol.startDate)return;
    var hStart=new Date(hol.startDate+'T00:00:00'),hEnd=new Date((hol.endDate||hol.startDate)+'T00:00:00');
    var hCur=new Date(hStart);
    while(hCur<=hEnd){
      var hDs=hCur.getFullYear()+'-'+String(hCur.getMonth()+1).padStart(2,'0')+'-'+String(hCur.getDate()).padStart(2,'0');
      // Use pre-computed fraction from holiday object
      var frac=hol.fraction!==undefined?hol.fraction:1;
      holDaySet[hDs]={fraction:frac,holId:hol.id};
      hCur.setDate(hCur.getDate()+1);
    }
  });
  while(cur<=ed){
    var ds=Math.round((cur-ps)/864e5),pos=((ds%cl)+cl)%cl,sh=eCfg.sp[pos];
    if(sh&&sh.t!=='off'){
      var dow=cur.getDay();
      var shType=eST(sh.t);
      var shTotalHrs=shType?shType.totalHours||12:12;
      var shPaidHrs=sh.h||(shType?shType.hours:11.25);
      var y=cur.getFullYear(),mo=cur.getMonth()+1,dd2=cur.getDate();
      var dStr=y+'-'+String(mo).padStart(2,'0')+'-'+String(dd2).padStart(2,'0');
      var holDay=holDaySet[dStr];
      var holFrac=holDay?holDay.fraction:0; // fraction of day on holiday
      var workFrac=1-holFrac; // fraction of day worked normally
      // Working hours = total shift length - OT deductions - unpaid break
      var otDayHrs=0;
      otRules.forEach(function(rule,i){
        if(rule.days.indexOf(dow)>=0){
          var oh=rule.hours||0;
          // Only accumulate OT for worked fraction (not holiday fraction)
          var effOH=oh*workFrac;
          otAccum[i].hours+=effOH;
          otAccum[i].gross+=effOH*r*rule.rate;
          otDayHrs+=oh; // full OT hours still deducted from shift length calc
        }
      });
      var wH=shTotalHrs-otDayHrs-unpaidBreak;
      if(bhSet[dStr]){
        var bx=bhSet[dStr];var bhDefH=shTotalHrs-unpaidBreak;
        var bhHrs=bx.hours||bhDefH;
        var bhBaseRate=r;
        // If bhIncludeSA, add shift allowance to base rate
        if(eCfg.bhIncludeSA&&shType&&shType.allowancePct>0){
          bhBaseRate=r*(1+shType.allowancePct/100);
        }
        // Multiplier: 2x means double normal pay, so pay = hours * rate * mult
        // This replaces normal pay, so we DON'T add base salary on top
        bHtH+=bhHrs;bHtP+=bhHrs*bhBaseRate*(bx.mult||1);
        hW+=wH;
      } else if(otSet[dStr]){
        exOTsH+=wH;
      } else {
        hW+=wH;
      }
      // Shift allowance per type - only for worked fraction (not holiday fraction)
      var saHrs=wH*workFrac;
      if(bhSet[dStr])saHrs=0; // No SA on BH
      if(shType&&shType.allowancePct>0&&!bhSet[dStr]){
        if(!saByType[sh.t])saByType[sh.t]={hours:0,pct:shType.allowancePct};
        saByType[sh.t].hours+=saHrs;
      }
    }
    cur.setDate(cur.getDate()+1);
  }
  var sHr=hW-bHtH,off=hW-mH,sOff=off*r;
  // Pension
  var pG=(bS+sOff)*period.penPct;
  // Salary sacrifice schemes (pre-tax)
  var sacT=0;
  (cfg.sacrifices||[]).forEach(function(sc){sacT+=sc.amount||0});
  // OT totals
  var otTotal=0;
  var otBreak=[];
  Object.keys(otAccum).forEach(function(k){var ot=otAccum[k];otTotal+=ot.gross;otBreak.push({label:ot.label,hours:ot.hours,rate:ot.rate,gross:ot.gross})});
  // Shift allowance total
  var sA=0;
  Object.keys(saByType).forEach(function(t){var sa=saByType[t];sA+=sa.hours*(r*sa.pct/100)});
  // Legacy single SA calc fallback
  if(!eCfg.shiftTypes)sA=sHr*(r*(eCfg.saPct||0)/100);
  var bon=0,otX=0,expAdd=0,expDed=0,expPreTax=0,mileage=0;
  (period.extras||[]).forEach(function(ex){
    if(ex.type==='bonus')bon+=ex.amount||0;
    else if(ex.type==='ot'){var m=gOM(ex.date);otX+=(ex.hours||0)*r*m}
    else if(ex.type==='expense'){
      var amt=ex.amount||0;
      if(ex.expType==='deduction'){if(ex.preTax)expPreTax+=amt;else expDed+=amt}
      else{expAdd+=amt}// reimbursement or allowance
    }
    else if(ex.type==='mileage'){mileage+=ex.amount||0}
  });
  var gP=bS+sOff-pG-sacT-expPreTax+otTotal+bHtP+sA+bon+otX+expAdd+mileage;
  // Gross for holiday pay 52-week reference: HMRC uses total earnings BEFORE pension & salary sacrifice deductions
  var grossForHol=bS+sOff+otTotal+bHtP+sA+bon+otX+expAdd+mileage;
  // Tax calculation
  var tc=pTC(cfg.taxCode),tx=0;
  if(tc.mode==='NT'){tx=0}
  else if(tc.mode==='BR'){tx=gP*.2}
  else if(tc.mode==='D0'){tx=gP*.4}
  else if(tc.mode==='D1'){tx=gP*.45}
  else if(cfg.taxRegion==='scotland'){
    // Scottish tax bands
    var sRates=SCOT_TAX[aYr]||SCOT_TAX['2025/26'];
    var annPA=tc.pa;
    if(annPA>0&&gP*12>tax.pat){annPA=Math.max(0,annPA-Math.floor((gP*12-tax.pat)/2))}
    var mPA=annPA/12,ti=gP-mPA;
    if(ti<=0)tx=0;
    else{
      var mS=sRates.starter.b/12,mB=sRates.basic.b/12,mI=sRates.inter.b/12;
      var mH2=sRates.higher.b/12;
      var rem=ti;
      if(rem<=mS){tx=rem*sRates.starter.r/100}
      else if(rem<=mS+mB){tx=mS*sRates.starter.r/100+(rem-mS)*sRates.basic.r/100}
      else if(rem<=mS+mB+mI){tx=mS*sRates.starter.r/100+mB*sRates.basic.r/100+(rem-mS-mB)*sRates.inter.r/100}
      else if(rem<=mS+mB+mI+mH2){tx=mS*sRates.starter.r/100+mB*sRates.basic.r/100+mI*sRates.inter.r/100+(rem-mS-mB-mI)*sRates.higher.r/100}
      else{tx=mS*sRates.starter.r/100+mB*sRates.basic.r/100+mI*sRates.inter.r/100+mH2*sRates.higher.r/100+(rem-mS-mB-mI-mH2)*sRates.top.r/100}
    }
  }
  else{
    var annPA=tc.pa,bbAnn=tax.bb;
    if(tc.mode==='K'){annPA=tc.pa}
    else if(annPA>0&&gP*12>tax.pat){annPA=Math.max(0,annPA-Math.floor((gP*12-tax.pat)/2))}
    var mPA=annPA/12,ti=gP-mPA;
    if(ti<=0)tx=0;
    else{var mBB=bbAnn/12;if(ti<=mBB)tx=.2*ti;else{var mHR=(150000-annPA-bbAnn)/12;if(mHR<0)mHR=0;if(ti<=mBB+mHR)tx=.2*mBB+.4*(ti-mBB);else tx=.2*mBB+.4*mHR+.45*(ti-mBB-mHR)}}
  }
  if(tx<0)tx=0;
  // NI - use configurable thresholds
  var mNPT=(tax.nPT||242)*52/12,mNUEL=(tax.nUEL||967)*52/12;
  var nMR=(tax.nM||8)/100,nAR=(tax.nA||2)/100;
  var ni=0;if(gP<=mNPT)ni=0;else if(gP<=mNUEL)ni=nMR*(gP-mNPT);else ni=nMR*(mNUEL-mNPT)+nAR*(gP-mNUEL);
  // Student loan deductions
  var sl=0;
  (cfg.studentLoans||[]).forEach(function(plan){
    var def=STLOAN[plan];
    if(def){var mThresh=def.thresh/12;if(gP>mThresh)sl+=(gP-mThresh)*def.rate/100}
  });
  var tH=gP-tx-ni-sl-expDed;
  var cPct=gCM(period.penPct*100),cP2=(bS+sOff)*(cPct/100);
  // Legacy OT fields for backward compat with breakdown display
  var o13h=0,o13g=0,o15h=0,o15g=0,o2h=0,o2g=0;
  otBreak.forEach(function(ob){if(ob.rate<=1.33){o13h+=ob.hours;o13g+=ob.gross}else if(ob.rate<=1.5){o15h+=ob.hours;o15g+=ob.gross}else{o2h+=ob.hours;o2g+=ob.gross}});
  // Compute holiday supplement total from extras
  var holSupTotal=0;
  (period.extras||[]).forEach(function(ex){if(ex.holidayId&&ex.type==='bonus')holSupTotal+=ex.amount||0});
  return{m:period.m,mW:period.mW,mH:mH,hW:hW,bH:bHtH,sHr:sHr,off:off,bS:bS,sOff:sOff,pP:period.penPct,pG:pG,cPct:cPct,cP:cP2,otBreak:otBreak,otTotal:otTotal,o13h:o13h,o13g:o13g,o15h:o15h,o15g:o15g,o2h:o2h,o2g:o2g,bHg:bHtP,sA:sA,holSup:holSupTotal,bon:bon,otX:otX,sacT:sacT,gP:gP,grossForHol:grossForHol,tx:tx,ni:ni,sl:sl,tH:tH,start:period.start,end:period.end,payDate:period.payDate||'',extras:period.extras||[]}
}
function cAll(){return(years[aYr].periods||[]).map(function(p,i){return cM(p,i)})}

// ═══ SETTINGS ═══
function openS(){document.getElementById('sOv').classList.add('o');document.getElementById('sDw').classList.add('o');rS()}
function closeS(){document.getElementById('sOv').classList.remove('o');document.getElementById('sDw').classList.remove('o');rAll();rTab(aTab)}
// ═══ TAB VISIBILITY ═══
var hiddenTabs=[];
function ldHiddenTabs(){try{var s=localStorage.getItem('st7-hidden-tabs');if(s)hiddenTabs=JSON.parse(s)}catch(e){}if(!hiddenTabs||!Array.isArray(hiddenTabs))hiddenTabs=[]}
function svHiddenTabs(){try{localStorage.setItem('st7-hidden-tabs',JSON.stringify(hiddenTabs))}catch(e){}}
ldHiddenTabs();
var defTabOrder=['dash','per','bd','ann','acc','spend','pf','cal'];
var tabOrder=defTabOrder.slice();
function ldTabOrder(){try{var s=localStorage.getItem('st7-tab-order');if(s){var o=JSON.parse(s);if(Array.isArray(o)&&o.length>0){tabOrder=o;defTabOrder.forEach(function(t){if(tabOrder.indexOf(t)<0)tabOrder.push(t)});tabOrder=tabOrder.filter(function(t){return defTabOrder.indexOf(t)>=0});if(tabOrder[0]!=='dash'){tabOrder=tabOrder.filter(function(t){return t!=='dash'});tabOrder.unshift('dash')}}}}catch(e){}}
function svTabOrder(){try{localStorage.setItem('st7-tab-order',JSON.stringify(tabOrder))}catch(e){}}
ldTabOrder();
function applyTabOrder(){
  var navS=document.querySelector('.nav-s');if(!navS)return;
  tabOrder.forEach(function(t){
    var btn=document.getElementById('t-'+t);if(btn)navS.appendChild(btn);
  });
}
function moveTab(tab,dir){
  var i=tabOrder.indexOf(tab);if(i<0)return;
  if(tab==='dash')return;
  var ni=i+dir;if(ni<1||ni>=tabOrder.length)return;
  var other=tabOrder[ni];if(other==='dash'&&dir===-1)return;
  tabOrder[i]=other;tabOrder[ni]=tab;
  svTabOrder();applyTabOrder();applyTabVis();rS();
}
function applyTabVis(){
  tabOrder.forEach(function(t){
    var el=document.getElementById('t-'+t);
    if(el){if(hiddenTabs.indexOf(t)>=0)el.classList.add('tab-hidden');else el.classList.remove('tab-hidden')}
  });
}
function tgTabVis(tab){
  var i=hiddenTabs.indexOf(tab);
  if(i>=0)hiddenTabs.splice(i,1);else hiddenTabs.push(tab);
  svHiddenTabs();applyTabVis();rS();
}

// ═══ COLLAPSIBLE SETTINGS ═══
var sOpenSections={};
try{var ss=localStorage.getItem('st7-s-open');if(ss)sOpenSections=JSON.parse(ss)}catch(e){}
function tgSS(id){sOpenSections[id]=!sOpenSections[id];try{localStorage.setItem('st7-s-open',JSON.stringify(sOpenSections))}catch(e){}rS()}
function ssOpen(id,h,desc,body){
  var isOpen=!!sOpenSections[id];
  return '<div class="ss-col"><div class="ss-col-h" onclick="tgSS(\''+id+'\')"><span class="ss-arr'+(isOpen?' open':'')+'">&#9654;</span><span class="ss-ttl">'+h+'</span>'+(desc?'<span class="ss-desc">'+desc+'</span>':'')+'</div><div class="ss-col-b'+(isOpen?' open':'')+'">'+body+'</div></div>';
}

function rS(){
  var r=hr();var h='';
  // ── WORK PROFILE (always visible) ──
  var wpH='';
  wpH+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px"><span style="font-size:13px;color:var(--tx)"><strong>'+(cfg.profile||'shift-rotating').replace(/-/g,' ').replace(/\\b\\w/g,function(c){return c.toUpperCase()})+'</strong></span>';
  wpH+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700;background:rgba(34,197,94,.1);color:var(--gn)">'+(cfg.payBasis==='hourly'?'HOURLY':'SALARIED')+'</span>';
  wpH+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700;background:rgba(245,158,11,.1);color:var(--or)">'+(cfg.payMode==='current'?'CURRENT':'ARREARS')+'</span>';
  if(cfg.taxRegion==='scotland')wpH+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700;background:rgba(99,102,241,.1);color:var(--bl2)">SCOTTISH TAX</span>';
  if(cfg.studentLoans&&cfg.studentLoans.length)wpH+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:700;background:rgba(167,139,250,.1);color:var(--pu)">STUDENT LOAN</span>';
  wpH+='</div>';
  wpH+='<button class="btn bp" onclick="wzOpen()" style="width:100%;justify-content:center;margin-bottom:10px">'+ICO.edit+' Run Setup Wizard</button>';
  h+='<div style="background:rgba(99,102,241,.04);border:1px solid rgba(99,102,241,.12);border-radius:var(--r);padding:14px;margin-bottom:14px">'+wpH+'</div>';

  // ── TAX YEAR (always visible) ──
  h+='<div class="yb" id="ys" style="margin-bottom:14px"></div>';

  // ══ SUB-MENU: Pay & Salary ══
  var payH='';
  payH+='<div class="g2"><div class="fg" style="margin-bottom:0"><label class="fl">Pay Basis</label><select class="sf" id="xPB" onchange="sU()"><option value="salaried"'+(cfg.payBasis==='salaried'?' selected':'')+'>Salaried (annual)</option><option value="hourly"'+(cfg.payBasis==='hourly'?' selected':'')+'>Hourly rate</option></select></div>';
  payH+='<div class="fg" style="margin-bottom:0"><label class="fl">Pay Mode</label><select class="sf" id="xPM" onchange="sU()"><option value="arrears"'+(cfg.payMode==='arrears'?' selected':'')+'>Arrears (period based)</option><option value="current"'+(cfg.payMode==='current'?' selected':'')+'>Current month</option></select></div></div>';
  payH+='<div class="fg"><label class="fl">Annual Salary</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="xS" value="'+cfg.sal+'" step=".01" onchange="sU()"></div></div>';
  payH+='<div class="fg"><label class="fl">Contracted Hours/Week</label><div class="iw"><input type="number" class="fi" id="xW" value="'+cfg.shw+'" onchange="sU()"><span class="is">hrs</span></div></div>';
  payH+='<div class="fg"><label class="fl">Hourly Rate (auto)</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" value="'+r.toFixed(2)+'" disabled></div><div class="fh">= salary ÷ 52 ÷ '+cfg.shw+'</div></div>';
  // Mid-year salary changes (multiple)
  if(!cfg.salaryChanges)cfg.salaryChanges=[];
  // Migrate legacy single mid-year to new array
  if(cfg.midYearEnabled&&cfg.midYearSal>0&&cfg.salaryChanges.length===0){
    cfg.salaryChanges.push({month:cfg.midYearMonth||6,sal:cfg.midYearSal});cfg.midYearEnabled=false;save();
  }
  var mym=['April','May','June','July','August','September','October','November','December','January','February','March'];
  payH+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)">';
  payH+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><label class="fl" style="margin:0">Salary Changes</label><button class="btn bp bx" onclick="addSalChange()" style="font-size:11px;padding:4px 10px">'+ICO.plus+' Add</button></div>';
  if(cfg.salaryChanges.length===0){payH+='<div style="font-size:11px;color:var(--tx3);padding:6px 0">No mid-year salary changes.</div>'}
  cfg.salaryChanges.forEach(function(sc,idx){
    var scr=sc.sal/52/cfg.shw;
    payH+='<div style="background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);padding:10px;margin-bottom:8px">';
    payH+='<div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">';
    payH+='<div class="fg" style="flex:1;min-width:90px;margin:0"><label class="fl" style="font-size:10px">From</label><select class="sf" onchange="cfg.salaryChanges['+idx+'].month=+this.value;save();rS()">';
    mym.forEach(function(m,i){payH+='<option value="'+(i+1)+'"'+((i+1)===sc.month?' selected':'')+'>'+m+'</option>'});
    payH+='</select></div>';
    payH+='<div class="fg" style="flex:2;min-width:110px;margin:0"><label class="fl" style="font-size:10px">New Salary</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" value="'+(sc.sal||'')+'" step=".01" onchange="cfg.salaryChanges['+idx+'].sal=+this.value||0;save();rS()"></div></div>';
    payH+='<button class="btn" onclick="cfg.salaryChanges.splice('+idx+',1);save();rS()" style="background:rgba(239,68,68,.08);color:var(--rd2);border:1px solid rgba(239,68,68,.15);padding:6px 8px;height:34px" title="Remove">'+ICO.trash+'</button>';
    payH+='</div>';
    if(sc.sal>0){payH+='<div style="font-size:10px;color:var(--tx3);margin-top:6px">New rate: <strong>'+fmt(scr)+'</strong>/hr</div>'}
    payH+='</div>';
  });
  payH+='</div>';
  h+=ssOpen('pay','Pay & Salary',cfg.sal>0?fmt(cfg.sal)+'/yr':'Not set',payH);

  // ══ SUB-MENU: Tax & NI ══
  var taxH='';
  var tcOpts=[{v:'1257L',l:'1257L — Standard (£12,570 PA)'},{v:'1185L',l:'1185L — Reduced (£11,850 PA)'},{v:'1100L',l:'1100L — Reduced (£11,000 PA)'},{v:'1000L',l:'1000L — Reduced (£10,000 PA)'},{v:'944L',l:'944L — Reduced (£9,440 PA)'},{v:'810L',l:'810L — Reduced (£8,100 PA)'},{v:'500L',l:'500L — Reduced (£5,000 PA)'},{v:'1293L',l:'1293L — Marriage Allowance received'},{v:'1194L',l:'1194L — Marriage Allowance transferred'},{v:'BR',l:'BR — All at basic rate (20%)'},{v:'D0',l:'D0 — All at higher rate (40%)'},{v:'D1',l:'D1 — All at additional rate (45%)'},{v:'0T',l:'0T — No personal allowance'},{v:'NT',l:'NT — No tax deducted'},{v:'custom',l:'✎ Custom...'}];
  var isCustom=!tcOpts.some(function(o){return o.v===cfg.taxCode&&o.v!=='custom'});
  taxH+='<div class="fg"><label class="fl">Tax Region</label><select class="sf" id="xTR" onchange="cfg.taxRegion=this.value;save();rS()"><option value="england"'+(cfg.taxRegion==='england'?' selected':'')+'>England / Wales / NI</option><option value="scotland"'+(cfg.taxRegion==='scotland'?' selected':'')+'>Scotland</option></select></div>';
  taxH+='<div class="g2"><div class="fg"><label class="fl">Tax Code</label><select class="sf" id="xTCS" onchange="tcSel()">';
  tcOpts.forEach(function(o){var sel=(isCustom&&o.v==='custom')||(!isCustom&&o.v===cfg.taxCode)?' selected':'';taxH+='<option value="'+o.v+'"'+sel+'>'+o.l+'</option>'});
  taxH+='</select>';
  taxH+='<div id="tcCustom" style="margin-top:6px;'+(isCustom?'':'display:none')+'"><div class="iw"><input type="text" class="fi" id="xTC" value="'+cfg.taxCode+'" placeholder="e.g. 1257L" onchange="sU()"></div></div>';
  var tcInfo=pTC(cfg.taxCode);taxH+='<div class="fh" style="margin-top:4px;color:'+(tcInfo.mode==='NT'?'var(--gn)':tcInfo.pa>0?'var(--bl)':'var(--or)')+'">'+tcInfo.desc+'</div></div>';
  taxH+='<div class="fg"><label class="fl">NI Category</label><select class="sf" id="xNI" onchange="sU()">';
  ['A - Standard','B - Married women','C - Over State Pension','M - Under 21'].forEach(function(o){var v=o[0];taxH+='<option value="'+v+'"'+(cfg.niCat===v?' selected':'')+'>'+o+'</option>'});
  taxH+='</select></div></div>';
  // HMRC rates inline
  taxH+='<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bd)"><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">';
  Object.keys(HMRC).forEach(function(y){taxH+='<button class="btn bg bs" onclick="iH(\''+y+'\')">Import '+y+'</button>'});taxH+='</div>';
  taxH+='<div class="g2"><div class="fg"><label class="fl">Personal Allowance</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="tPA" value="'+tax.pa+'" onchange="tU()"></div></div>';
  taxH+='<div class="fg"><label class="fl">Basic Rate Band</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="tBB" value="'+tax.bb+'" onchange="tU()"></div></div>';
  taxH+='<div class="fg"><label class="fl">PA Taper Starts</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="tPAT" value="'+tax.pat+'" onchange="tU()"></div></div></div>';
  taxH+='<div class="g2"><div class="fg"><label class="fl">NI Primary (Wk)</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="tNP" value="'+tax.nPT+'" onchange="tU()"></div></div>';
  taxH+='<div class="fg"><label class="fl">NI Upper (Wk)</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="tNU" value="'+tax.nUEL+'" onchange="tU()"></div></div>';
  taxH+='<div class="fg"><label class="fl">NI Main</label><div class="iw"><input type="number" class="fi" id="tNM" value="'+tax.nM+'" step=".1" onchange="tU()"><span class="is">%</span></div></div>';
  taxH+='<div class="fg"><label class="fl">NI Additional</label><div class="iw"><input type="number" class="fi" id="tNA" value="'+tax.nA+'" step=".1" onchange="tU()"><span class="is">%</span></div></div></div></div>';
  h+=ssOpen('tax','Tax & NI',cfg.taxCode+' • '+(cfg.taxRegion==='scotland'?'Scotland':'England'),taxH);

  // ══ SUB-MENU: Pension ══
  var penH='';
  penH+='<div class="ib" style="margin-top:0;margin-bottom:12px">Define company match rules. Your per-month sacrifice % on the Periods tab determines the company rate.</div>';
  penH+='<div class="fg"><label class="fl">Tier Rules</label>';
  (cfg.penTiers||[]).forEach(function(t,i){
    penH+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
    penH+='<span style="font-size:11px;font-weight:600;color:var(--tx3);white-space:nowrap">If you pay</span>';
    penH+='<div class="iw" style="width:90px"><input type="number" class="fi" value="'+t.emp+'" step=".5" style="text-align:center" onchange="cfg.penTiers['+i+'].emp=+this.value||0;save();rS()"><span class="is">%</span></div>';
    penH+='<span style="font-size:11px;color:var(--tx3);white-space:nowrap">→ Co. pays</span>';
    penH+='<div class="iw" style="width:90px"><input type="number" class="fi" value="'+t.comp+'" step=".5" style="text-align:center" onchange="cfg.penTiers['+i+'].comp=+this.value||0;save();rS()"><span class="is">%</span></div>';
    penH+='<button class="db" onclick="rPT('+i+')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;font-size:16px;padding:2px 4px">&times;</button></div>'});
  penH+='<button class="btn bp bs" style="margin-top:6px" onclick="aPT()">'+ICO.plus+' Add Rule</button></div>';
  h+=ssOpen('pen','Pension Match Rules',(cfg.penTiers||[]).length+' tier'+(cfg.penTiers.length!==1?'s':''),penH);

  // ══ SUB-MENU: Shift Types & Allowances ══
  var saH='';
  if(cfg.shiftTypes&&cfg.shiftTypes.length){
    cfg.shiftTypes.forEach(function(st,i){
      if(st.id==='off')return;
      saH+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;padding:8px 10px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--s2);flex-wrap:wrap">';
      saH+='<span style="font-weight:700;font-size:11px;min-width:50px">'+st.label+'</span>';
      saH+='<div class="iw" style="width:75px"><input type="number" class="fi" value="'+(st.totalHours||12)+'" step=".25" style="text-align:center" onchange="cfg.shiftTypes['+i+'].totalHours=+this.value||0;save();rS()"><span class="is">h</span></div>';
      saH+='<div class="iw" style="width:80px"><input type="number" class="fi" value="'+st.allowancePct+'" step=".01" style="text-align:center" onchange="cfg.shiftTypes['+i+'].allowancePct=+this.value||0;save();rS()"><span class="is">%SA</span></div>';
      saH+='<span style="font-size:10px;color:var(--tx3)">= '+fmt(r*st.allowancePct/100)+'/hr</span></div>';
    });
  }
  saH+='<div class="fg" style="margin-top:10px"><label class="fl">Unpaid Break per Shift</label><div class="iw"><input type="number" class="fi" id="xUB" value="'+(cfg.unpaidBreak!==undefined?cfg.unpaidBreak:0.5)+'" step=".25" onchange="cfg.unpaidBreak=+this.value||0;save();rS()"><span class="is">hrs</span></div></div>';
  h+=ssOpen('sa','Shift Types & Allowances',cfg.shiftTypes?cfg.shiftTypes.filter(function(s){return s.id!=='off'}).length+' types':'',saH);

  // ══ SUB-MENU: Overtime Rules ══
  var otH='';
  otH+='<div class="ib" style="margin-top:0;margin-bottom:12px">Compulsory OT deducted from each shift per day-of-week. These rates also apply when adding extra OT payments.</div>';
  var dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  (cfg.otRules||[]).forEach(function(rule,i){
    otH+='<div style="padding:10px;margin-bottom:8px;border:1px solid var(--bd);border-radius:var(--rs);background:var(--s2)">';
    otH+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">';
    otH+='<div class="iw" style="flex:1"><input type="text" class="fi" value="'+(rule.label||'')+'" placeholder="Rule label" style="font-weight:600" onchange="cfg.otRules['+i+'].label=this.value;save();rS()"></div>';
    otH+='<div class="iw" style="width:80px"><input type="number" class="fi" value="'+rule.hours+'" step=".25" style="text-align:center" onchange="cfg.otRules['+i+'].hours=+this.value||0;save();rS()"><span class="is">h</span></div>';
    otH+='<span style="font-size:10px;color:var(--tx3)">@</span>';
    otH+='<div class="iw" style="width:80px"><input type="number" class="fi" value="'+rule.rate+'" step=".01" style="text-align:center" onchange="cfg.otRules['+i+'].rate=+this.value||0;save();rS()"><span class="is">x</span></div>';
    otH+='<button class="db" onclick="cfg.otRules.splice('+i+',1);save();rS()" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">&times;</button></div>';
    // Day-of-week checkboxes
    otH+='<div style="display:flex;gap:4px;flex-wrap:wrap">';
    dayNames.forEach(function(dn,di){
      var active=(rule.days||[]).indexOf(di)>=0;
      otH+='<label style="display:flex;align-items:center;gap:3px;font-size:10px;padding:3px 6px;border-radius:4px;cursor:pointer;background:'+(active?'rgba(99,102,241,.15)':'var(--s3)')+';color:'+(active?'var(--bl2)':'var(--tx3)')+';border:1px solid '+(active?'rgba(99,102,241,.3)':'var(--bd)')+';user-select:none"><input type="checkbox" '+(active?'checked':'')+' onchange="tgOTDay('+i+','+di+')" style="display:none"> '+dn+'</label>';
    });
    otH+='</div></div>';
  });
  otH+='<button class="btn bp bs" style="margin-top:6px" onclick="cfg.otRules.push({days:[1,2,3,4,5],hours:0,rate:1.33,label:\'New Rule\'});save();rS()">'+ICO.plus+' Add OT Rule</button>';
  // Standard OT rates section
  otH+='<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--bd)"><label class="fl">Standard Overtime Rates (for extra OT)</label>';
  otH+='<div class="fh" style="margin-bottom:8px">When adding extra overtime, the rate is determined by the day of week using the rules above. Rates shown when adding OT.</div></div>';
  h+=ssOpen('ot','Overtime Rules',(cfg.otRules||[]).length+' rule'+(cfg.otRules.length!==1?'s':''),otH);

  // ══ SUB-MENU: Shift Pattern ══
  var spH='';
  spH+='<div class="fg"><label class="fl">Pattern Start Date (Cycle Day 1)</label><div class="iw"><input type="date" class="fi" id="xPSD" value="'+cfg.patternStart+'" onchange="sU()"></div></div>';
  spH+='<div id="spC"></div>';
  spH+='<div style="display:flex;gap:6px;margin-top:8px"><button class="btn bp bs" onclick="aSP()">'+ICO.plus+' Add Day</button><button class="btn bdn bs" onclick="rSP()">- Remove</button></div>';
  h+=ssOpen('sp','Shift Pattern',cfg.sp.length+'-day cycle',spH);

  // ══ SUB-MENU: Student Loans ══
  var slH='';
  slH+='<div class="ib" style="margin-top:0;margin-bottom:12px">Select active student loan plans. Deductions calculated automatically above threshold.</div>';
  var slPlans=['plan1','plan2','plan4','plan5','postgrad'];
  var slLabels={plan1:'Plan 1 (pre-2012)',plan2:'Plan 2 (post-2012)',plan4:'Plan 4 (Scottish)',plan5:'Plan 5 (post-2023)',postgrad:'Postgraduate'};
  slPlans.forEach(function(p){
    var active=(cfg.studentLoans||[]).indexOf(p)>=0;
    var def=STLOAN[p];
    slH+='<div style="margin-bottom:6px"><label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer"><input type="checkbox" '+(active?'checked':'')+' onchange="tgSL(\''+p+'\')" style="accent-color:var(--bl);width:16px;height:16px"> '+slLabels[p]+'</label>';
    slH+='<div class="fh">Threshold: '+fmt(def.thresh)+'/yr • Rate: '+def.rate+'%</div></div>';
  });
  h+=ssOpen('sl','Student Loans',(cfg.studentLoans||[]).length>0?(cfg.studentLoans||[]).join(', '):'None',slH);

  // ══ SUB-MENU: Salary Sacrifice Schemes ══
  var sacH='';
  sacH+='<div class="ib" style="margin-top:0;margin-bottom:12px">Pre-tax deductions beyond pension (e.g. Cycle to Work, EV car scheme).</div>';
  (cfg.sacrifices||[]).forEach(function(sc,i){
    sacH+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    sacH+='<div class="iw" style="flex:2"><input type="text" class="fi" value="'+sc.name+'" placeholder="Scheme name" onchange="cfg.sacrifices['+i+'].name=this.value;save();rS()"></div>';
    sacH+='<div class="iw" style="flex:1"><span class="ip">'+P+'</span><input type="number" class="fi" value="'+sc.amount+'" step="1" onchange="cfg.sacrifices['+i+'].amount=+this.value||0;save();rS()"></div>';
    sacH+='<span style="font-size:10px;color:var(--tx3)">/mo</span>';
    sacH+='<button class="db" onclick="cfg.sacrifices.splice('+i+',1);save();rS()" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">&times;</button></div>';
  });
  sacH+='<button class="btn bp bs" style="margin-top:6px" onclick="cfg.sacrifices.push({name:\'\',amount:0});save();rS()">'+ICO.plus+' Add Scheme</button>';
  h+=ssOpen('sac','Salary Sacrifice',(cfg.sacrifices||[]).length+' scheme'+((cfg.sacrifices||[]).length!==1?'s':''),sacH);

  // ══ SUB-MENU: Saved Work Profiles ══
  var wpH2='';
  wpH2+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span style="font-size:11px;font-weight:600;color:var(--tx2)">Manage saved profiles</span>';
  wpH2+='<button class="btn bp bx" onclick="promptSaveProfile()">'+ICO.plus+' Save Current</button></div>';
  if(workProfiles.length===0){wpH2+='<div style="font-size:11px;color:var(--tx3);padding:8px">No saved profiles. Save your current setup to reuse later.</div>'}
  else{workProfiles.forEach(function(wp,i){
    wpH2+='<div style="display:flex;align-items:center;gap:6px;padding:10px;margin-bottom:4px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--s2);flex-wrap:wrap">';
    wpH2+='<div style="flex:1;min-width:120px"><div style="font-weight:700;font-size:12px">'+wp.name+'</div>';
    wpH2+='<div style="font-size:10px;color:var(--tx3)">'+(wp.profile||'').replace(/-/g,' ')+' • '+wp.sp.length+'-day cycle</div></div>';
    wpH2+='<div style="display:flex;gap:4px;flex-wrap:wrap">';
    wpH2+='<button class="btn bg bx" onclick="loadProfile(\''+wp.id+'\')">Load</button>';
    wpH2+='<button class="btn bp bx" onclick="openEditProfile(\''+wp.id+'\')">'+ICO.edit+'</button>';
    wpH2+='<button class="btn bx" onclick="updateProfile(\''+wp.id+'\')" style="background:rgba(245,158,11,.08);color:var(--or);border:1px solid rgba(245,158,11,.15)">'+ICO.refresh+'</button>';
    wpH2+='<button class="btn bdn bx" onclick="deleteProfile(\''+wp.id+'\');rS()">'+ICO.trash+'</button></div></div>'});
  }
  // Mid-year profile switch
  var myProfEnabled=!!(cfg.midYearProfile||cfg.midYearProfileEnabled);
  wpH2+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)">';
  wpH2+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="xMYP" '+(myProfEnabled?'checked':'')+' onchange="cfg.midYearProfileEnabled=this.checked;if(!this.checked){cfg.midYearProfile=\'\';cfg.midYearProfileMonth=0}save();rS()" style="accent-color:var(--bl);width:16px;height:16px"> Mid-year profile switch</label></div>';
  if(myProfEnabled){
    var mym2=['April','May','June','July','August','September','October','November','December','January','February','March'];
    wpH2+='<div class="g2">';
    wpH2+='<div class="fg"><label class="fl">Switch From</label><select class="sf" id="xMYPM" onchange="cfg.midYearProfileMonth=+this.value;save();rS()">';
    mym2.forEach(function(m,i){wpH2+='<option value="'+(i+1)+'"'+((i+1)===(cfg.midYearProfileMonth||6)?' selected':'')+'>'+m+'</option>'});
    wpH2+='</select></div>';
    wpH2+='<div class="fg"><label class="fl">To Profile</label><select class="sf" id="xMYPP" onchange="cfg.midYearProfile=this.value;save();rS()">';
    wpH2+='<option value="">— None —</option>';
    workProfiles.forEach(function(wp){wpH2+='<option value="'+wp.id+'"'+(cfg.midYearProfile===wp.id?' selected':'')+'>'+wp.name+'</option>'});
    wpH2+='</select></div></div>';
  }
  wpH2+='</div>';
  h+=ssOpen('profiles','Work Profiles',workProfiles.length+' saved',wpH2);

  // ══ SUB-MENU: Display, Tabs & Theme ══
  var dispH='';
  // Theme toggle
  var isLight=document.documentElement.classList.contains('light');
  dispH+='<div class="theme-toggle" onclick="toggleTheme()" style="margin-top:0"><span class="ic" style="line-height:0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span><span class="tl">Light Theme</span><div class="theme-sw"></div></div>';
  // Theme appearance controls
  dispH+='<div style="background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:12px 14px;margin-bottom:14px">';
  dispH+='<div style="font-size:12px;font-weight:700;margin-bottom:10px">'+(isLight?'Light':'Dark')+' Theme Appearance</div>';
  if(isLight){
    dispH+='<div style="margin-bottom:12px">';
    dispH+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><label style="font-size:11px;font-weight:600;color:var(--tx2)">Brightness</label><span style="font-size:10px;color:var(--tx3);font-family:\'Geist Mono\',monospace">'+ltCfg.level+'%</span></div>';
    dispH+='<input type="range" min="0" max="100" step="1" value="'+ltCfg.level+'" oninput="setLightLevel(this.value)" style="width:100%;accent-color:var(--bl);height:6px;cursor:pointer">';
    dispH+='<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--tx3);margin-top:3px"><span>Bright</span><span>Default</span><span>Dark</span></div>';
    dispH+='</div>';
  }
  var acMap=isLight?LT_ACCENTS:DK_ACCENTS;
  var curAccent=isLight?ltCfg.accent:ltCfg.darkAccent;
  var setFn=isLight?'setLightAccent':'setDarkAccent';
  dispH+='<div><label style="font-size:11px;font-weight:600;color:var(--tx2);display:block;margin-bottom:6px">Accent Colour</label>';
  dispH+='<div style="display:flex;gap:6px;flex-wrap:wrap">';
  Object.keys(acMap).forEach(function(k){
    var ac=acMap[k];
    var sel=curAccent===k;
    dispH+='<button onclick="'+setFn+'(\''+k+'\')" style="width:32px;height:32px;border-radius:8px;border:'+(sel?'2.5px solid var(--tx)':'2px solid var(--bd)')+';background:'+ac.bl+';cursor:pointer;position:relative;transition:.15s" title="'+ac.label+'">';
    if(sel)dispH+='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="width:16px;height:16px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"><polyline points="20 6 9 17 4 12"/></svg>';
    dispH+='</button>';
  });
  dispH+='</div></div>';
  dispH+='</div>';
  // Tab visibility & order
  var tabDefs=[{id:'dash',l:'Dashboard'},{id:'per',l:'Periods'},{id:'bd',l:'Breakdown'},{id:'ann',l:'Annual'},{id:'acc',l:'Accounts'},{id:'spend',l:'Spending'},{id:'pf',l:'Pension'},{id:'cal',l:'Calendar'}];
  var tabLookup={};tabDefs.forEach(function(td){tabLookup[td.id]=td.l});
  dispH+='<div style="font-size:11px;font-weight:700;margin-bottom:8px;color:var(--tx2)">Tab Visibility & Order</div>';
  dispH+='<div class="ib" style="margin-top:0;margin-bottom:12px">Show/hide and reorder tabs. Dashboard always stays first.</div>';
  tabOrder.forEach(function(tid,idx){
    var vis=hiddenTabs.indexOf(tid)<0;
    var isDash=tid==='dash';
    var lbl=tabLookup[tid]||tid;
    dispH+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;padding:6px 8px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs)">';
    dispH+='<div style="display:flex;flex-direction:column;gap:1px;opacity:'+(isDash?.2:1)+'">';
    dispH+='<button class="btn bx" style="padding:1px 4px;min-width:0;font-size:10px;line-height:1" '+(isDash||idx<=1?'disabled':'')+' onclick="moveTab(\''+tid+'\',-1)">▲</button>';
    dispH+='<button class="btn bx" style="padding:1px 4px;min-width:0;font-size:10px;line-height:1" '+(isDash||idx>=tabOrder.length-1?'disabled':'')+' onclick="moveTab(\''+tid+'\',1)">▼</button>';
    dispH+='</div>';
    dispH+='<label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:'+(isDash?'default':'pointer')+';flex:1;opacity:'+(isDash?.5:1)+'"><input type="checkbox" '+(vis?'checked':'')+' '+(isDash?'disabled':'onchange="tgTabVis(\''+tid+'\')"')+' style="accent-color:var(--bl);width:16px;height:16px"> '+lbl+'</label>';
    dispH+='</div>';
  });
  h+=ssOpen('disp','Display & Tabs','',dispH);

  // ══ SUB-MENU: Data Backup ══
  var dataH='';
  dataH+='<p style="font-size:12px;color:var(--tx3);margin-bottom:12px">Data is stored in this browser only. Export regularly.</p>';
  dataH+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">';
  dataH+='<button class="btn bp" onclick="exportData()" style="flex:1;justify-content:center">'+ICO.dl+' Export All</button>';
  dataH+='<button class="btn bg" onclick="document.getElementById(\'impFile\').click()" style="flex:1;justify-content:center">'+ICO.refresh+' Import</button></div>';
  // Selective export
  dataH+='<div style="margin-bottom:12px;padding:12px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs)">';
  dataH+='<div style="font-size:11px;font-weight:700;margin-bottom:8px;color:var(--tx2)">Selective Export</div>';
  dataH+='<div style="font-size:10px;color:var(--tx3);margin-bottom:8px">Choose what to include in your export file.</div>';
  var expOpts=[
    {id:'exp_years',lbl:'Salary & Periods (all years)',key:'years'},
    {id:'exp_accounts',lbl:'Accounts & Transactions',key:'accounts'},
    {id:'exp_spending',lbl:'Spending & Budgets',key:'spending'},
    {id:'exp_recurring',lbl:'Recurring Expenses',key:'recurringExpenses'},
    {id:'exp_pension',lbl:'Pension Config',key:'pensionCfg'},
    {id:'exp_holidays',lbl:'Holidays & Calendar',key:'holidays'},
    {id:'exp_profiles',lbl:'Work Profiles',key:'workProfiles'},
    {id:'exp_settings',lbl:'Settings & Preferences',key:'settings'}
  ];
  expOpts.forEach(function(o){
    dataH+='<label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;margin-bottom:4px;padding:4px 0"><input type="checkbox" id="'+o.id+'" checked data-expkey="'+o.key+'" style="accent-color:var(--bl);width:16px;height:16px"> '+o.lbl+'</label>';
  });
  dataH+='<div style="display:flex;gap:8px;margin-top:8px">';
  dataH+='<button class="btn bp" onclick="exportSelective()" style="flex:1;justify-content:center;font-size:11px;padding:8px">'+ICO.dl+' Export Selected</button>';
  dataH+='</div></div>';
  dataH+='<button class="btn bg" onclick="exportCalICS()" style="width:100%;margin-top:0;margin-bottom:10px;justify-content:center">'+ICO.dl+' Export Shifts to .ics (Calendar)</button>';
  dataH+='<div style="padding-top:12px;border-top:1px solid var(--bd)">';
  dataH+='<div style="font-size:11px;font-weight:700;margin-bottom:6px;color:var(--tx2)">Periods Only ('+aYr+')</div>';
  dataH+='<div style="display:flex;gap:8px">';
  dataH+='<button class="btn" style="flex:1;justify-content:center;font-size:11px;padding:8px;background:var(--glass2);border:1px solid var(--bd);color:var(--tx)" onclick="exportPeriods()">'+ICO.dl+' Export Periods</button>';
  dataH+='<button class="btn" style="flex:1;justify-content:center;font-size:11px;padding:8px;background:var(--glass2);border:1px solid var(--bd);color:var(--tx)" onclick="document.getElementById(\'impPerFile\').click()">'+ICO.refresh+' Import Periods</button>';
  dataH+='</div>';
  dataH+='<div style="font-size:10px;color:var(--tx3);margin-top:4px">Export/import just the period dates, extras and pension % for '+aYr+'</div>';
  dataH+='<input type="file" id="impPerFile" accept=".json" style="display:none" onchange="importPeriods(this)">';
  dataH+='</div>';
  dataH+='<input type="file" id="impFile" accept=".json" style="display:none" onchange="importData(this)">';
  h+=ssOpen('data','Data Backup','',dataH);

  // ══ SUB-MENU: Help & Manual ══
  var helpH='';
  helpH+='<div style="font-size:12px;color:var(--tx3);margin-bottom:12px">Quick reference guide for all app features.</div>';
  helpH+='<button class="btn bp" onclick="downloadManualPDF()" style="width:100%;justify-content:center;margin-bottom:14px">'+ICO.dl+' Download Full Manual (PDF)</button>';
  helpH+=buildHelpContent();
  h+=ssOpen('help','Help & Manual','',helpH);

  // ══ Danger Zone (always at bottom) ══
  h+='<div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(239,68,68,.15)">';
  h+='<button class="btn" style="background:rgba(239,68,68,.08);color:var(--rd2);border:1.5px solid rgba(239,68,68,.15);width:100%;padding:10px;font-size:12px;font-weight:700;margin-bottom:8px" onclick="dYr(\''+aYr+'\')">'+ICO.trash+' Delete '+aYr+'</button>';
  h+='<button class="btn" style="background:rgba(239,68,68,.15);color:var(--rd2);border:1.5px solid rgba(239,68,68,.25);width:100%;padding:10px;font-size:12px;font-weight:700" onclick="resetAll()">'+ICO.trash+' Reset Everything</button>';
  h+='</div>';

  document.getElementById('sB').innerHTML=h;rSPat();yBt('ys');applyTabOrder();applyTabVis();
}
function sU(){cfg.sal=+document.getElementById('xS').value||0;cfg.shw=+document.getElementById('xW').value||39;var saEl=document.getElementById('xSA');if(saEl)cfg.saPct=+saEl.value||0;cfg.patternStart=document.getElementById('xPSD').value;var tcs=document.getElementById('xTCS');if(tcs&&tcs.value!=='custom')cfg.taxCode=tcs.value;else{var tci=document.getElementById('xTC');if(tci)cfg.taxCode=tci.value}cfg.niCat=document.getElementById('xNI').value;
  var pbEl=document.getElementById('xPB');if(pbEl)cfg.payBasis=pbEl.value;
  var pmEl=document.getElementById('xPM');if(pmEl)cfg.payMode=pmEl.value;
  save();rS()}
function addSalChange(){if(!cfg.salaryChanges)cfg.salaryChanges=[];cfg.salaryChanges.push({month:6,sal:0});save();rS()}
function tgSL(plan){
  if(!cfg.studentLoans)cfg.studentLoans=[];
  var idx=cfg.studentLoans.indexOf(plan);
  if(idx>=0)cfg.studentLoans.splice(idx,1);else cfg.studentLoans.push(plan);
  save();rS();
}
function tgOTDay(ruleIdx,dayIdx){
  var rule=cfg.otRules[ruleIdx];if(!rule.days)rule.days=[];
  var i=rule.days.indexOf(dayIdx);
  if(i>=0)rule.days.splice(i,1);else rule.days.push(dayIdx);
  rule.days.sort();
  save();rS();
}
function tU(){tax.pa=+document.getElementById('tPA').value||0;tax.bb=+document.getElementById('tBB').value||0;tax.pat=+document.getElementById('tPAT').value||0;tax.nPT=+document.getElementById('tNP').value||0;tax.nUEL=+document.getElementById('tNU').value||0;tax.nM=+document.getElementById('tNM').value||0;tax.nA=+document.getElementById('tNA').value||0;save()}
function iH(yr){if(HMRC[yr]){tax=JSON.parse(JSON.stringify(HMRC[yr]));years[aYr].tax=tax;save();rS()}}

function exportData(){
  save();
  var data=JSON.stringify(years,null,2);
  var fullExport={years:years,accounts:accts,spending:spending,pensionCfg:penCfg,recurringExpenses:recurDefs,workProfiles:workProfiles,holidays:holidays,holidayCfg:holCfg,tabOrder:tabOrder,lightThemeCfg:ltCfg};
  data=JSON.stringify(fullExport,null,2);
  var blob=new Blob([data],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  var d=new Date();
  a.href=url;
  a.download='salary-tracker-backup-'+d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
function exportSelective(){
  save();
  var exp={};var count=0;
  var chk=document.querySelectorAll('[data-expkey]');
  chk.forEach(function(el){
    if(!el.checked)return;
    var k=el.getAttribute('data-expkey');
    count++;
    if(k==='years')exp.years=years;
    else if(k==='accounts')exp.accounts=accts;
    else if(k==='spending'){exp.spending=spending;exp.recurringExpenses=recurDefs}
    else if(k==='recurringExpenses')exp.recurringExpenses=recurDefs;
    else if(k==='pensionCfg')exp.pensionCfg=penCfg;
    else if(k==='holidays'){exp.holidays=holidays;exp.holidayCfg=holCfg}
    else if(k==='workProfiles')exp.workProfiles=workProfiles;
    else if(k==='settings'){exp.tabOrder=tabOrder;exp.lightThemeCfg=ltCfg}
  });
  if(count===0){alert('Please select at least one category to export.');return}
  exp._selectiveExport=true;
  var data=JSON.stringify(exp,null,2);
  var blob=new Blob([data],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  var d=new Date();
  a.href=url;
  a.download='salary-tracker-selective-'+d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
function downloadManualPDF(){
  var b64='JVBERi0xLjQKJZOMi54gUmVwb3J0TGFiIEdlbmVyYXRlZCBQREYgZG9jdW1lbnQgKG9wZW5zb3VyY2UpCjEgMCBvYmoKPDwKL0YxIDIgMCBSIC9GMiAzIDAgUgo+PgplbmRvYmoKMiAwIG9iago8PAovQmFzZUZvbnQgL0hlbHZldGljYSAvRW5jb2RpbmcgL1dpbkFuc2lFbmNvZGluZyAvTmFtZSAvRjEgL1N1YnR5cGUgL1R5cGUxIC9UeXBlIC9Gb250Cj4+CmVuZG9iagozIDAgb2JqCjw8Ci9CYXNlRm9udCAvSGVsdmV0aWNhLUJvbGQgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcgL05hbWUgL0YyIC9TdWJ0eXBlIC9UeXBlMSAvVHlwZSAvRm9udAo+PgplbmRvYmoKNCAwIG9iago8PAovQ29udGVudHMgMjAgMCBSIC9NZWRpYUJveCBbIDAgMCA1OTUuMjc1NiA4NDEuODg5OCBdIC9QYXJlbnQgMTkgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjUgMCBvYmoKPDwKL0NvbnRlbnRzIDIxIDAgUiAvTWVkaWFCb3ggWyAwIDAgNTk1LjI3NTYgODQxLjg4OTggXSAvUGFyZW50IDE5IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iago2IDAgb2JqCjw8Ci9Db250ZW50cyAyMiAwIFIgL01lZGlhQm94IFsgMCAwIDU5NS4yNzU2IDg0MS44ODk4IF0gL1BhcmVudCAxOSAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKNyAwIG9iago8PAovQ29udGVudHMgMjMgMCBSIC9NZWRpYUJveCBbIDAgMCA1OTUuMjc1NiA4NDEuODg5OCBdIC9QYXJlbnQgMTkgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjggMCBvYmoKPDwKL0NvbnRlbnRzIDI0IDAgUiAvTWVkaWFCb3ggWyAwIDAgNTk1LjI3NTYgODQxLjg4OTggXSAvUGFyZW50IDE5IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iago5IDAgb2JqCjw8Ci9Db250ZW50cyAyNSAwIFIgL01lZGlhQm94IFsgMCAwIDU5NS4yNzU2IDg0MS44ODk4IF0gL1BhcmVudCAxOSAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKMTAgMCBvYmoKPDwKL0NvbnRlbnRzIDI2IDAgUiAvTWVkaWFCb3ggWyAwIDAgNTk1LjI3NTYgODQxLjg4OTggXSAvUGFyZW50IDE5IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iagoxMSAwIG9iago8PAovQ29udGVudHMgMjcgMCBSIC9NZWRpYUJveCBbIDAgMCA1OTUuMjc1NiA4NDEuODg5OCBdIC9QYXJlbnQgMTkgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjEyIDAgb2JqCjw8Ci9Db250ZW50cyAyOCAwIFIgL01lZGlhQm94IFsgMCAwIDU5NS4yNzU2IDg0MS44ODk4IF0gL1BhcmVudCAxOSAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKMTMgMCBvYmoKPDwKL0NvbnRlbnRzIDI5IDAgUiAvTWVkaWFCb3ggWyAwIDAgNTk1LjI3NTYgODQxLjg4OTggXSAvUGFyZW50IDE5IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iagoxNCAwIG9iago8PAovQ29udGVudHMgMzAgMCBSIC9NZWRpYUJveCBbIDAgMCA1OTUuMjc1NiA4NDEuODg5OCBdIC9QYXJlbnQgMTkgMCBSIC9SZXNvdXJjZXMgPDwKL0ZvbnQgMSAwIFIgL1Byb2NTZXQgWyAvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJIF0KPj4gL1JvdGF0ZSAwIC9UcmFucyA8PAoKPj4gCiAgL1R5cGUgL1BhZ2UKPj4KZW5kb2JqCjE1IDAgb2JqCjw8Ci9Db250ZW50cyAzMSAwIFIgL01lZGlhQm94IFsgMCAwIDU5NS4yNzU2IDg0MS44ODk4IF0gL1BhcmVudCAxOSAwIFIgL1Jlc291cmNlcyA8PAovRm9udCAxIDAgUiAvUHJvY1NldCBbIC9QREYgL1RleHQgL0ltYWdlQiAvSW1hZ2VDIC9JbWFnZUkgXQo+PiAvUm90YXRlIDAgL1RyYW5zIDw8Cgo+PiAKICAvVHlwZSAvUGFnZQo+PgplbmRvYmoKMTYgMCBvYmoKPDwKL0NvbnRlbnRzIDMyIDAgUiAvTWVkaWFCb3ggWyAwIDAgNTk1LjI3NTYgODQxLjg4OTggXSAvUGFyZW50IDE5IDAgUiAvUmVzb3VyY2VzIDw8Ci9Gb250IDEgMCBSIC9Qcm9jU2V0IFsgL1BERiAvVGV4dCAvSW1hZ2VCIC9JbWFnZUMgL0ltYWdlSSBdCj4+IC9Sb3RhdGUgMCAvVHJhbnMgPDwKCj4+IAogIC9UeXBlIC9QYWdlCj4+CmVuZG9iagoxNyAwIG9iago8PAovUGFnZU1vZGUgL1VzZU5vbmUgL1BhZ2VzIDE5IDAgUiAvVHlwZSAvQ2F0YWxvZwo+PgplbmRvYmoKMTggMCBvYmoKPDwKL0F1dGhvciAoXChhbm9ueW1vdXNcKSkgL0NyZWF0aW9uRGF0ZSAoRDoyMDI2MDIxMzIwMjgyMSswMCcwMCcpIC9DcmVhdG9yIChcKHVuc3BlY2lmaWVkXCkpIC9LZXl3b3JkcyAoKSAvTW9kRGF0ZSAoRDoyMDI2MDIxMzIwMjgyMSswMCcwMCcpIC9Qcm9kdWNlciAoUmVwb3J0TGFiIFBERiBMaWJyYXJ5IC0gXChvcGVuc291cmNlXCkpIAogIC9TdWJqZWN0IChcKHVuc3BlY2lmaWVkXCkpIC9UaXRsZSAoXChhbm9ueW1vdXNcKSkgL1RyYXBwZWQgL0ZhbHNlCj4+CmVuZG9iagoxOSAwIG9iago8PAovQ291bnQgMTMgL0tpZHMgWyA0IDAgUiA1IDAgUiA2IDAgUiA3IDAgUiA4IDAgUiA5IDAgUiAxMCAwIFIgMTEgMCBSIDEyIDAgUiAxMyAwIFIgCiAgMTQgMCBSIDE1IDAgUiAxNiAwIFIgXSAvVHlwZSAvUGFnZXMKPj4KZW5kb2JqCjIwIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDY1Nwo+PgpzdHJlYW0KR2F0biI/I1EyZCdTYylQKCRAP0MmcjB0NSIuLl1KOGxOMkpnJCNHLV1sQVdrZl9DPkRdKEZuKy02XS1pWlgnQEwmQWo0U051b0dUSSFdPUg/XjFWMCc6PClOK0dGPjhhOVtGWixKNmdiWGJYcz46bG4zUkEwPj5OT0dEVj9rOkwhayNqSjxybE9oJzNZUmgqOjRHa051KURmOztGUVY3Sm5cZC1vT0heTjQhZlwwJlYlKk1ULD8yVVQvUCZiVkk/Zk45Ty0iJWNxUGoqJSxYM0RzIi1dV18oNDElVU4zYVpGJTNsVzJPSiJbYzBTZGdOLURMZiRYK3RoRCVWMSxkMF01K0ldPU1nY2c4TSRyKnUqTT05I0UjWm06Pl9sbyNWLjpKRmtqWSZDOVknQEckV1o0aGhxYToyS1VzYDtYMTQqViFlSS5uYSJuVUVKPVFXPC0iTmZpWnJJQkssYkA5VTt0YS5DOT8lYF8iSVYkdFJnJHErQCpnWTJFQiEySVBUcCUlZmJDVGxKOFhYImkqNzh0M0ltaipuRDI5alFoWkkiXUxHWjpbRk0/KlN1WjxcZFVNV1hTLS1jYD50VCtBPUtaZ2ROMXJNR3NUOW5TLm9OcXJwMC1CUy5AcUhmLlJfTHNGXTtTJ2wxRyIxRm9fSl5QPyQmN1o+QDRSMDhVZVBiays5J1Q+MDhBI0BxcWQnITBPQ2hlYW5oU1gnZlVaM18nXXNUcVwwJnQ8U1M/VnRJSSxoOlJjYVY3ZWBeYCY6JiUuZyhMJydtaCxfKGs/JGcnYzI2RyYnIjc6UTI7J1BjKD50TmpZTDNhLTNEODwkNU8nUCE+LjJDWmtSKm9wYl4/dG9SS2E2SVEvKTNwTX4+ZW5kc3RyZWFtCmVuZG9iagoyMSAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCAxMDA5Cj4+CnN0cmVhbQpHYXRVcz5CQUxQJjtCJDsoJlFLUDNbcUp0KWglcDFTXVMibDoxIUxjKF1jOC9VOVliKklza0JWOFhWSyQqRyVATjBHc18lWzc9aj8kcDsxKW85cTYzInQ9cF9CPj9MJjtkX21NSkZqYypkYSQvS2dPOnI9XSJLTSQhUThGJUFQJi1FbippNkxqWGNAYWJCZmJQRTlOJF9mXiFQKFpPVDBfXWpXKlVRXGFTOCwpYkM3IWZpIzgxcFNzZzByLiNWckc3PkpuOVUvXHFgQGNcXGMiSDNCR2pwLGY5WGY8KGdLVUFubz1xRSxJRVJIIWZaTjRcQVI2LzhHaFU4VzdVXGJYaW9Zaj1tRzBUWTJMJVFsZFxVMS1wL29rSjl0XmBlMFVxdE8xP29wX2cvQzgiNHM4IlphakByMiJfMXNubT1dc2IpXmtCNDU1TnBuWFJwWWFdNDJZPCc5K3AyUUFZPERObS1TUik+byVrImdrOD9LYGpiKnVoX0BIYDsnRCtuUkpaaXJeRjxRXDcsLzNJa2FRUmE1YSlsbU1uV1I2LVgjSWtuOSFqbTlzIjs4TTs/NWE/STxXdFchOTpMRzxmIl5KJk9UODNyKkZTPCMnQVRSR2kwO091V2EoKiFfXVsxWm1LNGFrNVU8KVZvUS5IZ1diU21XWEYxO0piJCUlTjBZUUpeXzVaQUI5VShEWCdiLl5pXy9pR0JyN008ZjQraktFQThxOjFiY2giLGVJU20mTy1vMjJgRkVYa2dPMEVhXFA6bjNoQCZUQmxcdThTLEYhRCZiUWMkVUFLbSo3WCRJKmFiITlERnMnbSlnTVdMIjouXXM6W1FsM1dJclw1bjRAZSJRTDo4T1ttRGJHbUdCWGZmWWZlK2todW9KZkJISTRVJiZRPTtSR2xkP1wuIT5RXHNaQC9ZV3FJTmZmIVtscklNJDRNb2QzN2NAQSZaZ0AxMCdQLzZrSGxeOl8xUVpIXTpbcT4lQSM/I3JNJzJmb2U6TlMxPzBJOyVfcihfIzNwYUgkRl5gZW1HW0NUYzhjJiVqOERWNUIuYGhiWDcjIkQ9Mk5NIkNCRi1BV1hyQFRbXmpQblRDVz5Mc1tDIXIvXigxSDVfMDwndDJvPFVXXS5TT0NHNT1pMlMhQENdcSpnUXI5XW83bTtWJEJCKnAiRkxAUUguJ1VfQjFqLDo4JCQ+PTQrZSpsOjdiPVJrLGMwMyoiRHNXTzpcLz0kTHM6YzZkYE1kTlxRZmNrUnN1UGoxUnNRKV8/Xy1GZmBINm4tUSd0SlRLTmpqYzRNI3EpWF1NTFlkPCtGQi86Vl4kPDorK2Mzcms2InBVO3UhV34+ZW5kc3RyZWFtCmVuZG9iagoyMiAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCAxOTcwCj4+CnN0cmVhbQpHYXVISz5CQTdfJ1JuQjMzKTw0VUNuXElPKl1hQitCSVA2WGgobkJZQU0oK1EtKmdSUTxjUW8laHNbWG9WJFY9NTo8JkpnWCQrKVhTRj41OG8nbStDcydlOmRAUk8iISM4RGhKUlNqXUQwb2ImO1gzb1ZQWlg/THFWLV1hajV0a0ZFSCwxVURpI0sycSk/cmMmP0JHJzMrPSZXMVA8OUF0YmcoMD9ZW3MkSEJFOGtsIlkkYmA2WTo5WUdrPUkvWC9bJEhYWTxkTipuMDxcTkxoaW1POC5QTTU+OmVHKyMkOVI4V2BQb05gRiQhXUonZiQzNUg5K3IxKEYkUE0iKkhJbUI+WmRiSDddVWRtN1hsV1VWL29OQFohcUIybClWSjsuN1BcMGZbcGhvdDUiSlcsUSElQF5iYXQuMl9wXFo5RT1PXFhmJW4ucWtNRkwmTGZAI2FxODVMUFNCdHIjWydybGpyOTAiPXJmOzBzTTxQIm9FWCVII2BEPFVfJEJhTSZAQmtUTlk8KFRuajlsMmMoLVMkW0prIy5WLDJFbDFtcC1JXiQiMzgray8hIy5hQUQ0JSw9XW88SFxLWSYkOSIwUHA3UD5dT1s4XzxFUSVpWk5jay83KEgzUFE8XlU/KlZuYFk3JGRSNzNSJDhiZkQpYjo8NWlcSz1xRnMrYSE3LEZrLztWU0UjMzZFQz5NNCpdQk1kNlVlLjdyQj5gZCtSIkNGYjZyaEA7M3JkaG0mM0ZsVCQjVzh0SV5paytRITUrNS1hU1hSaG8pT2RaRmtsQFdtbytTRjE9dU9dJSYwZjlicD5GbGRiWyRgVGpKO0NKK05rYCxnallVXmlJMF44ZFQxSTAySE5nSmhoU2FXZm1QPk43NEIwKmVbOzNfWUgrU3Iya0JZdVNJUmdnY1JVcTgyRWNybyU6O0VAaDVGKlZPM2lBcUtqVWxiR2ZXcT8+KzEuUT8pVVotXFYyKSc3aipMN1EsRjtRWDpaTllTbUQkNiMtSWFvJ107SWxEY0FgNE9ZSCEzNmtoMDlVME8mbHJNSyppRVYuIihNVmhmO05cS1khPTZKIyRHcjRfaGgrdDBwKycxJjlkZyZ0QSVxMVw+UV1kcmc/ZGUvP01UQGxNaVJYPVpkRzQtRUU4RmhsSC1KdFFvKXVKTF8xU2ZdO0QyYzBSZyc0OTFuKGphZnNiXT5mOiFoRzo/PCtLI2VNcjVBJllwLjVPWkYjQ2VRKyRsYiohPGokaWRrTjVtNzklVWkzQGsmO2BvJTFPKyMiZlcoXC8xKiw0TUZFUkE4LmZvPGxjK000SUFTSFshYS02XC1zQypsRmFaZCRBLS1PVFtLND8pQj5KIV8iOyNOWF9MR1MxOSU+b2xAQTInamk4JzhwMTtfMTRaQChaaGowMWJ0LCkjU2xUbihRUWQ4bjVWZ0I7NkZSUWRkZSZTZkA/TTZsXEElPClWVEUzLjZDMihCdVIwOGFOaTsyY3VmTXFZPnQ2OFw7PUwrRkJPZiE4Y1QzLVZYcmJRJ0xMalJGOy5VKmU+TE5QakQrUlFlLjBlZGhSTEgsUzZObC8kLCdiM1InUFtXQTR1ZmMxaGU8bj8wLUZGc1VVJHJgJkNJNjJcKzM6UjU9KERwZTFOK1xIcj1obkVFSGppOlMlPWhYQWE0Ly9IOD1EXyYhL3JLZmZZbyoxbVwtIUxdOFUvXCslIVAlZyVLLEgwLSxedT9xWWVoUyYyK21sZSgvJltgKkdtamtdSWIjYipdPmxSIy1jJWRrSzFzNi9bYCxNMCc+NHM3Y3IsbDU/P0Q8c1MmT2lHNWJGKCV1MU0qKzw8I0pCJ2FQMzwxVDI0NXRmUm5mPyFUQStJdFNAciFqWVdFW0RcVVI9M0siUi87YyhscHIxQkUyZ1MxNDBhYGpRUSslJkZfPkYyJ29wNGluOloqUnVPSm1lIS1ISzNtcGNAR2NLa15GczUrU2csKnEoQ102JjUncHVgIkJlP2hoT0ppdC9bcW1vZkp0SDg5LGJDREs4bWRwclo6Iz5hWlVGRHJvJzBYZ1dDJU1vJWNjXVlgXD8zaWUqNThbckpAZlFANHEhQEg2YkJATydhTXFiZ102bUlybDtSZm46TV1bIVsiJ0xaKnI6JUFbVD8pZC9sMCdgOk08Qm02Q09gZTIyMm1TTDRLXWVbcjxZPzBOQ2RrTEU6NXJUSFo2IyZTXG4vP2pqK1AnRk5HSVgjKz8/LT03IjRWaWVyR1JDTV00UD43XllgQyZuQC48akFMPjBPPis1Q1Uia1RpPyczYlNORXBuOlI4ckFkT0UuLk0xJDZRTzVoaSFCVU4xPC5QZ3JPOTEkU2xhamZgLy4+UygvMjBEJkEzODBoR3BcVSVMaDoyQCQmRzRnKjwsTDtFSlAzMDxFajBrNW85czNUQCldNjtwLnE0VVhnS0peJS01Y05YUTkxZDg1aCUmKFtEQilpQiw5OC1EL0ojLE0oVmIrUVhVbz9oO0lLLjRmJ0EvJW05R0pjJGEhaENmYitub0thQ2wtXllgV1RUUWRWa1RzLVdvO1pPb00uXV1MW2M2T1xMZTlkTCVGIyxcMihrTjcnVydtYXIjOUE3bGxYVlZOZUl+PmVuZHN0cmVhbQplbmRvYmoKMjMgMCBvYmoKPDwKL0ZpbHRlciBbIC9BU0NJSTg1RGVjb2RlIC9GbGF0ZURlY29kZSBdIC9MZW5ndGggMjE3MAo+PgpzdHJlYW0KR2IhI1xnTiZjUyY6TzpTb1pQZjguPlwkK0teb20/Yz1KTk9gRFEjJ1dyK1coT1llZEhtKiZqL0olc2VKK1FRWGVpaFViLD5kYWZXbDIqS3NvImAzZFlQdCRQITlaLl9wPCFLYExZMmFBXl40RUIlUERDLEoiTSMyYzpSKjg7PC5tNyNxKGBsTk1ecTFRZ3BqPktiSkY8ZkghYjlFJ2NMQkBpczRrJS5FZ0wwYk1XTSddRlpcT1UwaGwhPF81MVFWPVVGUCxcJ1tiZUNzXC43c0prNTdeP1pWRU4lPV1tTzFJKEwnMT1NZWQxLyJqTChxLU9IKnVOYmQ6aSQ8Uj5RTjdfZzNZcC8vIlgjdCQwJFpcUDYkNVRBL3BET2ZGSlxhRjI4aCInYDBQZ2hxY0JKRUw5cm4lUydNMj8lPlgoR2o4ZWQlRDtnSzQoJiIkMmpXXGtSczJyOChDOT5LajhFZThlZiRRImZyPTBhTTFHZixmIiRoRD1Eb0xjOEQ9c3U1Z1subF5IWVpqOnBhZGJgP1tSNC5IV1YpPl0rMltvYTZbQiVmMUU9dV9YPyUuQ1o3OE50Zj5TOyxSZlw0ZkFXLzFVODc2LT1IdCpsPi1iKE9dJiVYLmBDJSdpbF8pZ2BlTDMkbmRrVHEqKFBEM1dlKktzSEpQcWRtdG87cjdCVG5SOzZoMEglcSdoVCJgJmYrMDM/dVk/LmxOWXNET0RTRVwzS18xdE1DRi9eY1ZhIyhyZDYpOGBBNCxVWipec3MxSzw0TiJZQGpEJlBDLjpQZCgjUEl1cz5xLlpyTidCPl1bX2YxT1w7KENOVUFiQjcrYkw7SCosJWw7Im8na2Y7QEgtVjpPPU5PNzRSLUFgImJbalhjTl9BKTZSOkA3S09xaDlmVmBfJ29LKmU1ZzdWSikiUFw/QDJZbi89OmpdITNJXDEqQFlNZlUscEVHSVAqWFkmXGcsaWZoPSUmUD0sRl8yT3A2SDUhUjVgUEgrWEMwPnVSZSo2VTJAVlNJbU9UQ05XdWpJcV9dYUY2VEQ/bVonKmw4MFxWLVYzbTgyUT43MkM6LFM0NzNBTVQmS1Epa2RgJk89W25iOjlacVdGbzQiPGkkMV9bai9FPidIQDhuPXI1Yks1K1pNWyJGKDkvOTxnV11oX2JUcDglUm8wb3ApOmJkK2NEJVY8ZjBiIyo3bEJqXXVUXiEtLFdpbjBuXVpbUztCUnJAU010bz1LZSpkOWUuTmpqYmYuZkVhZzJrKGFyKU4xLkQhUmBmU1l0cDFVIUs4TUIkWzJpIWY9M15wN0omV0ZiVypoPE0vNCUycj41OjpIJHMhTFl0bl04Om5OV2glb1ZzJmxeJTpGaShYXGM6I0hRRjpnOk51U2FFZE1cXG5Fa28sMTNiKmlmJ2IkXFlVNmBXWzxsOCROP3FjYk1iVlk0STg/L0VjV2A9K010Oi8kOU9gKSZJP2krajQwY3QyZGpZaV5WLWAwMmBuPDlRWlJuVXQmQEZ0JWBea2JBOkVJNTVLJVNyVmRJSW5JRyFxNyNxXE8hZEdbPiEmYkJaYG1GaWwrYFhBJzUoOTdmLkRRTWNqLmFQTVgvTU0rOj5Hc2xpKkwuPnFbIkteZWg5IyRxWUxFbSZzajxaIzkkJClLam4oPFxZQmxgNC0xMzBXWjc4ZTEsQDdGWjNARD5WXFg/LlpdI3VGbUEvJGNlRidRSGppZGUtUyNNQzRwPycvVjhcOEcqSGsuSzRuNT9kRzYlN049YzRScHRXbTwtM11TOWQ3KXJJSEgzZW1PQm1JZUsta2NuQDtsWj5NK0dtcCw7V1EqNFgpXXBRdGc3UC5TS2ltWnVrR1EkQmJMbTRDYDxLbWNtRyRMR3QpYDQmUTNYNm8oTm1uXF1tSEwrQkpNcFZ0USFDTHRQQTksamxRdCVlbyhUYmFmaUdramwqT1FcNzhIZV0oLz5KNiw9PGAxMU4wU040ZG00UCVENjlrNUljUklOVT9zcGBkLik0NEk0NCE7O09May83UzFhUVRkIklHcSttTicxNEI5ZkBqXy5ATVksanJSTStwa1NpQFZfQDxnO2omJUIwOzRYcVxTWDtLTHRGdGVOQCVVSWtTT1I3KDRib0NUOiNpLGVmcV00NChBdCVjOGtQPFJLaScuMT1cWl1HLmZzWCJuLCNjaCgtPkdbLVtRXiNSKUBBTCZMQTZTJ0InWTUoTnNIUjcmZVZIaCVdLGlNJUo5aFVvYW8qbCQlYTJvJlRRKGAoVkAzKlFzcDNELnMmRmkodHFDP0FWQzs9XiVvcGdbYDExMCYkYWZrWV1GKUNLZEQjM0QmWzRNVnQmXSkqPW4xb2UzRD1qJ05QUVVja0FQRlMySDlTMVAqZiVbaSgvYUxVSFZVWTdQW3EkWzhyUVJZdVFSRV1DVVZcL1RwUFtUZFoqKmQnZEwpR3EwKVk9a2koSTZPYChkZl5oPyo6Kz4iN0k4a2k9NFw2NTcyMidCO2lrTmBqPjppaiMjMiMpMWRpTFBOaiZVWEJFNzRhVk8mRFZFPkMhUyVkUTlDSVpXdC07cGtAKGM5Rlg+cnRlRmdfb0NgRGdjYCUwKkZxJVJJSXVVSlk2VlQmbyhZNj8pb3QkLCtBSEUpY2FgcF9YY1AkUWc4KSpyIy5NbTNSbUEzW3JYYilGaEIrTGFCYVpyZWIsa1E5bUAsaUVtXDtlNF5UZmArUiU6PSdFXV1WVydBK246PVptNjppSUlkLGkwbl1YM1M1LCFGLClDMCFHLUFCXyI5PCtgPXVxbWInMVVHTShZSUwhKjVCbTsoSE00KipJZEE8UyFoRiNiJ3FVNjhcTlY9X2w7PlQic3Ahck9acFxiWSE0XkcySVsscVplUTtaJkp+PmVuZHN0cmVhbQplbmRvYmoKMjQgMCBvYmoKPDwKL0ZpbHRlciBbIC9BU0NJSTg1RGVjb2RlIC9GbGF0ZURlY29kZSBdIC9MZW5ndGggMTg5OQo+PgpzdHJlYW0KR2F0bTxEL1oxPSZIODguMGpoKlMyMjpVMHIiQTZELSlvP11dai5fRmVaK2VJQ2dfK2chTEUuK2tQM3FZQiMtQXNGI0B0Zj44WThgMVw4aUYxXGZuZWExJylLI0lwO0Fmc00/PiE6cU4zIipYYjpjUzFvXnItZFFgLm47c040PDQyIihlI1wkVCshK0IqOFxdYV5sTHRDcUk7MUsiUTJhVTFgY21wPFtZRFReQ3JEVkgmYSdNbjpyODUjWTc0IWk1L1IoSkxkJio8UTl1WiJaVUhHZjVQTmAmI2wvbTghcztbbyxnUGhoc2c2JzNyWXFPTmI8OkYoQEk2IWwiSF9rKWJBQnRjaDEtISZaVy1raEUyTWtuN3RvM1l1RF8oZFttZU5iWD84aUYoK3ApV3Nvby5qKW0nQiZKUWwyWSZyUFIvXl1mbUFJOihrVT5WXUU2R2xcTmklLlg0IydqNl9hZCVyWipzTGU8QU9OZVRRJyw+Ijo0NVpYO1Q2IVREVTQxQ2paUlQyUHJYJSFVR0E+WjdWMicpLikiNzNcQmExM11TIiMpRzxmUW82MjQmXUJJLXQ/YyFlVUlMPHFRIVg9LFFhXyY6OFBpWmZSXDJtUT83IytrM1JMT14zT1VMUS9BS2lvbWsidGhZZlJNQFBJSTZMSU00SGJTWikzL0ktVXJNRCgjPVlBXitaWTYsTU1PciFgOGh0bGNBKCxLVmxHXDtVXlk2T2BYWDgxajJlKCdrNTszQjdjP0clXFJgWW1xQi1HImU3UypCQjslUl0pSiZDZzFCT246WCVwZT9tc3NTISg3IiMjOjE9ITgnU0g6bjRZOnFWP2JJKmpCLk1oKSRoJWIiKjtHRU4tcUNGTkA/YyM8Q3IzUEhqcVEuLVJbWXBTNyRGRDlFNDUhZUEkSFk+QDA8dTxnYkowKzxDVCNgMGZnNTY6W2xRRnJHMltGMEUxO1xCRDtzUERbUytgKjlMcWpVM0NcUUUtNCdzVihrPDcjXl9cVTFOYCpyYSsoQSUmXi9bQFRkclFzVTReOE40b1I8PV9AJEk8LHFJbylAdDJTaURoaSdFcT0haDlyOFE+LUYpdWdpbUhFIyIwIm5mJzBGRCUsXVAnYkhXQmJuLkYzUD1hO1QnJCFfLlhEPTAwXEtXXyZfJzo2YGwvKnBzQUZLNUFWOlghdUBaTFxkbFNlQmdfPi1TISMrbEpnW2NsUUBdN1RwNCZTJkJzIShATStCIyZIaVRLZ0kxQXRxZSRbSjYmLVs9KiMocjNqZ15OTG5bYjMtO1FXRyFrWWUkWD9WOzhrMm5lOEQsQS1ZOlAzKj4+QmUoaHNBW11zJD0wYXRUWmxPb245Q2lCdGBRK1g2aVZcYl5fMmNkZihHbjoqP1A8MFdxTnIzQ0hcUiEnQTxmalYqYDhHWnUzI2cvLUFTdCtSaEZEWT5BJmJYKXFuI0hRWihIUFEkUFRFXCRDR2cjQ15scUZCaywvQltlak81I0laRTgmXilKMEs1JyhiRDVoJytAV2ZlJlhPPWJ0JCJVOzFuKjtUbF5QTFY0Vm9LYWVbRWtqNmI6bkwhZjYhcEMhbHJALydcUC1RLydyKilsOzBcWWJQYFZjV0JvPDZsbHQ+RlorTzYmI1hoWHAkWGMlR0wzdEA8Lz91NWhsRl83MG0tOCFJQVwmbmotUSFyNmtBP2VRXT4yNGokJ0ZSQHEtTztVcVU4M2MmIVgvZWY7MUoyIzxEL0ZlPSZTLV1aZy4ycHFAXDhORnBDYisuXTU4MFMhKDErdV1vcEoyTyErb28tQk1pOE8+X2AyaDs0JTBkaVslJC9dT0dzLDwoUmxMTUdtOywxNEZ1c2thLV9qQVgtT2onaTBAbk5MMTRyQDs6ZUU9PCVKTi5iRGtyPz9YXnIyV3JFV2YtPEZUclFqWWYvQS5zYnJkTGVaPjMwJl9DMj50PlNSJmtsJ1snTWw2XzExKEwhKjdjWy5yY2NGZUorQSkkRDdDTWozXzU4QEhSSzxab01CPCc9bkg8R01DXk9DJClacWJyMSImXTtRTUBKcWxPVD1jOzQ9R2pUMV1YSUMqLVFBJzslP0JpcTlCNTclIXU6aSE3NUNWWj05TE1rdC1lTz5gZlUzQ1J1aEdyLkdidWlhcGhZWlE0Vz1OUk5wTzZbYU5ncFIlIipMUEMqOG9hXzdycGNFaix1QnUuQGZzdElgXV1GaScmOXFHaFg7XD5wQVVxWzxTNkBoZmw1Z2tbUnAnOy8yOjMnLDhKPGMzaUJAOVJyN2dGaV5tN2Q/TWVhLW42dF4rW2Mtb2cjNTJmRT1hc14zQDVLQE1gRzk/ZnVERTptb09tXzQjRjdIM3BKX0JkSkkzXSdpbz1eQmdWJi44WjM0VkBQZDU7RGg7LSVuTTkjZkFNRilQYkk2b1hUPTJwVDgyXWI+S1c2Umw2LyRjSjpxcDg3TWZUbUk+SUtdNi8wLCEsTUw9NC9KT2dAKiE0Q1ttLG05b1pQcDQqPzIsSjhfJW9kM1MsNn4+ZW5kc3RyZWFtCmVuZG9iagoyNSAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCAxNTY2Cj4+CnN0cmVhbQpHYXRtOzsvYjJJJjpWcy9cPGo6MmlAI20lOyxWb1JCU1VDdWQxdHAqK1lTK0wsaGNdWE00LXNvblw8dFAvQl5wMWVPRDUwTl5NV0hyOWNXZmFWK2F1NUhPZ1FRMnBAaEU6Ri84YGFRK1QoM2ZqMjUvUGswalBMWCUrWD5zYjZFZ0lpQDMvJzBKcHFELFxEVTNxSyNkREwrK2tAVVM6cVAzV3RWImVvZVtnQzh1MUNcanQwInEiRDotcDowKGBcXWRcJU0yZkwhI1lANnIpKDJvJC0xT2JwUko0RzR0cjc6ZC8qdGFgQTomXDBsOTZjZigkOHVLKjE8VnIiIioqS0VcI05dPlJDLSgiWCZMYDJpLFQhaEZEP1EnRl5zQ1gxZ2E2QCInTGIxXExzRFQkYHQ+VzVAW0xJJSpZQDM/W0ZqPEIrJmdiRUZzJkBPJjRwWzxZW19JbEo2ZzApdVNDbnExUSZUQydWXV4pQFJdMG06LzohTTI6OklicUZSYDBKXXRgLWtvWFguOmtkT25ESlUhWUhGcTU9RCV0V1kqVFcvOzQnalZWJF87SlcuPGxUS3BgIj9kbCw3MnFjNjdnNV08MkY0bXFvZ3FcRXFzVXB0QWFWN1wlKyJpSmRlWXMsV3NcWmFIR2loay1tKFxvbj86WTUoRGdjPmtIRXElSnRhclYtI0IubU0qLk9lTlBAK1RPPClKQSRGXC9fWk88TT04WUVNai81XCgsYm4pWCRUJTMoYGQ+QU5xVjBMQU5ELicqXmA6JV8kVG9LUlNOUTswcnVecGAjJjRATUVLRUlYciUkXyJUTisrZTNUZlRPQFMtLF9lKEJbKSlBJTQ7Zk9dYChNI3BuLSRmOl8kcik3KmRgQHNvLF5MaiZVZVhIJFk+dClpO3VkaV8tJC5uV0AzNGdUWm1CZDJMayU/VURkbnQvRT00T0hDXWpLJ10sP0s7PURVJC88J00rJi8tX2ZrTWRub0pATyhlQUUtL1ZHSztGSDA4cVZhKlZiIzYzTVBVMENeNElsa25MMk4vV1NCRydJVWZLJDI+IlFySkFYQmVqRF1SLS5qRUUub11dUDldT3RvKz8yPlVFIVBFPlAuRTAxcE5pKiNCPVVzckA9czJpRzxlPmBdKjBgWklJVDU9WypxdWsjTT9YS19hRUsqL2ZzImNnT0kkLVFQMiQ0blRfdCMvXHRgXGUsQmdvTVppdFZrNltfc084VUNZcFkyM20ibC1QYE9eXDE/KnJsUC1NMjwma1Mrc2VbTyVvVzEnVFhnOGhCNThsWXJAVzwkaiU6O3BbakVoXW0xVTtEPDFZJyskJk4kTV1ycUVwM3M2UEoiQV51S0FhYCliOXNoUCYlSmUvXHRSJSonJmxoRCdlJWE3XG0iJzhUXFE8WipmIlhaUm1yYU1mdFxlTVBmNTcmX2AhMlJyOFI4NHJUajA/cG51LXQnPFhDUnJgXTkhOUMzOltMb0E7JEc7OEFHIm8yUT8uMyhwJ2AsLlMzUChRKmFyKW9fZ2xndGctbkcjSTQ3Xk5QU285bW9rJEVeYCtPWSokbEE4X2ppWk8sVGNYVl1gJF9AXCxicTdiYl8pc15PYVVxRFFAYi1rPV1ybj1lW2ZdKGooKC9nW2MhQUVXY2wjNkc3YEc0XE5BPlJOKCg3U2c+LURMT0Y3aEteOC5aNl9fNGMxZWgpSyctP2tiVD4rQTVmYjsoVSlhcz1Wa1xGMEtDMFIuSjdqYjNVNThcWCVoX0JMTUBxaGZSMyI/MjpYVmQ7ZCNwXiFZPjs+UUFtPzhePTRbN0gibmxORy1VcFpdZyNIUGIoSlVkZTtqLnUycWYmJ1liQUohW1Y3W1Q7UyJcLEZIMkdVTXNeRnUsRi5xUCtdRCRqYkQ2ZCwjUT1VQ2ljbEhXRkg6WEhBOVknVzJVLDZZTk5eOyJXYyQ8SDIwPjgvZWddXydkVF9XRTBNVTFnaF5XSTxFJEtgIV0uJEI2J3FRW2M3YzFAcW1NMlJmWyhyKlIzUEVlYGtbZ14pR2wkTT8vcjYnTF8nUjZIT2VpYzIybV5NaylaK3EsaThkKzE9LTwofj5lbmRzdHJlYW0KZW5kb2JqCjI2IDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDE3NDYKPj4Kc3RyZWFtCkdhdWBUOWxvJkkmQUBzQmxxcVhIN1xpRkVsRS9ATTFSVnRSJmJGRWc+c0sjOCZYKjImSjxwJCJdKmonWUczaytOMzZLPFA7XFswaDUubDteZjA3RktqaCdEYSQjZ1FxXTM/QlQhOSwkbzk1Yi4sRHQicGFxV0gjaTxqIVdiKkNdcj88b00zbTJwaGlFTEVHUGZpLmlpUHI6UEhCJCw/cjNpSGNNcGhJIzR0cj80aTtFSlloP24wODhQIjtHNVZIPm9XPl0/ZXRtNkhrVS5McWM0UScxTW0uP1M9a0IyXmQjOW1jM0s4cixpcWVvOW0pYFw2cz0lOlNNIVhKQj8/WCEvJDU3LTQ2PjFXTUlkTzhNYkUoWyYyY1NHLywzMERQMUdKVW9MTVxqTy9BRFwjTFRfb1ZBTUVwT3BXbV0naCsmU0UlTTJGXSUpMU4icUVfZD1rOFAzWVFRNmJQQEJ0YyJZPEpSOjo/X0I6MWVfSFc0Q1lvaUVYWyEyJzYnPGwqQmBCWCwtV0w0YG48X21HaVVKRlpVTVNgKD9tUD9jWWxKM2xyZGVNPy8nNic1M1NlRklGJjRYLU1ARTpKPkRFajtzZE1GJj5OOUs9QC1mVltYUTJCLj5kaHM+Xk49QnVidGZgKVE0PGNzQllsdUBMWGJxLW4iQVIvRDgnbllhS1clWmFlSjQ5I01FYElwU1xgdCc7YkN0SEE+cS90ckRQazJrT2k3U2Q+dWIuQEhSN3FZZ1EqS2JXb2cuJXJbMlNdLiNISTNBUT5aNXAjXW9OL2lBbTtWWU0nREtVXk4yW2lWbHIuSycwYiRIQ1g3YXNlIzNWKTc0OFNRXF8vTjdkZkxJZHBfJCRBZ05VZmZidGhXWjhqNDBOdCFTWCZmO0RLYFYrTlInbjNAOzJMMjhPSmNiPllZdUg6SURyP1QjRCEoakpaP20tVSZxYzk2NWc1ZVM2PClbR2NbcGxWJF9PI2ppLzdFamhRQCVJdWNfZTxRWjQ3XTtzKmZjL2E5SUFKaCIvLzolVy5nImAnUFsrRyoiUlhIIUBTPV0tQlJkVU9gMScrPGI0SSUpKCZvRzRkQlpoSGppQ25sPFwqQ08sX1VnOVwkS0ZEL0NMdV4jUk9LaFxwPVtZcTg3SFlqPE1YXChPam9FN1Z0RVZuZy9tTTNIS3M+dEklaSE4bjwmW1BXMy80dTFFPHVhQSxoJ0JNMFdpTTtlTzBQUF4mSFVkcDlXOENZV1g3UjVURy5vMFgpLDtJbChZUEdGLm82Rl4/OG1fQl5WVDtCO0kxXUZKOzVBQC00QmgmSEdAV2U4JnMzVmJZSksvIyhOWWJmIjVeZ24qPkBKKEJldV83YWZgU09UX2JfTE8pS21NPjEpN21ASWJCOCdqSF9UK0NNcGA3TyxtdVAoPGI9U24+ZXNrPy9mMjFKdVU0KWsyRjBzcUdaLVluMCZzQjYmSTUjLVstJSVnS2hwV0dnb1k4Z1hCPkEsZz9XYnBtaylcJ0knKkFdQHRhWm1NZWdRLU1MPFotcF1tVDUhKiIiV1pWRVkvIVY/KmVob1o6VF51TUxMW1BIJyxoPydzWD5NWzc5KFEkSE4iMkBtZ0pyXlM8dCRrLz1kbyhVW1FuR2xoXDsncz9rcDk2Vm9SYmpVaCksMy41J0FVMG5MPUY/Njo5Jyp1KD5cI1haUXUlSC9iUjlQNzE5b25CO1w+dTxKaUEjOUQ3QS1LXCszLlJdRWlkLkMyJCNeKChHNEokRE51Y0p1SjdxNmdZOFcoWy03VzgxT1hqcEZMYGo7LCxrQChSNFI4J2Ambj8paSc0IjNFRSNLZEMhc3VGQWNLLmw0LD5xWk5JU1RdRDkxYVsuOCw0OyYhVjt0aChUbSNmMHJJJHFIUismJSolMFIsNDxndWVubWZqSzQ4NG8xQzY8S3MpRmc4I2RbOjtJZjMyVUpbcylsPzFWLGciI0JPXmtaTFx0MWxmY1VrRXBeXEs/TnI1RihZOWxpbj4kRSpXQ0srP0EoZkUwVFEjLm9dZ2Q5NHJdNGtTciJaV3QhTU1AcT5nUWhhXi46SnE9bkVSOzpBKV5hZGRnKWlgaTYnWzE0O1UiaVclJC1uLEVDOlQ2cVxKRz1aTjNhQmhyY2QybiElPFE3cDxnUjxMNk1MdFx1M1o0KT5nTT8tcVI2PCRCRDpQXmNQcS5hQ29nVDsoYGY4TzduPDFpTFJvYEwjSFl0bmpmRHJrSjF1Nz50TE5mU0ZbKVAsRE42cG5AbExKWiZtbXFdb0oma1ptTFAuRWtMOVVwVGJZOjE+KUwuUF8+bD4mKT1qIyt+PmVuZHN0cmVhbQplbmRvYmoKMjcgMCBvYmoKPDwKL0ZpbHRlciBbIC9BU0NJSTg1RGVjb2RlIC9GbGF0ZURlY29kZSBdIC9MZW5ndGggMjEwCj4+CnN0cmVhbQpHYXI/KjVtdE9gJSMrMEkoJTQqY0IvPTtjWShFODsrUz1sL2UlJklcWDRwSktwU04nODVvdF1AXV88XVRfNGpjUC9bM1cpbUtmJUQ/VTZIMGQhS1NPb1NAMSZBaCRxNjc/WC0/NkZrNiFhKGwvWyVNSV0lcVpWZlY4aixXSEZaJi5sQV9ATGdrL2wqRVFdVjFbX0JcVGVmcUVzS1N1KytFaiIocm80ODgiam9fNkw3TjMxS3BJVzQqXkQ2VD05JzxeVDE1QnBdXnE+YkRGNEY3fj5lbmRzdHJlYW0KZW5kb2JqCjI4IDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDIwNzUKPj4Kc3RyZWFtCkdhdWBUPWA8JWEmOlhBV1IkU1MvK3UoQF5aVG9RTyssUG1xOitSKS1UVS1EKCdVX2QmRy5GdV1KKUFyQFhdUTExVElwWFtnMSthL3E7dGlfRlNtb0RjWDZrRUFjXSlRJG50QFc2c3MsYyJjTitvXWY+b1BiYyNgc05vaT9eQD1gNCtSYy09bFQjNS47ZGtra1cxcklmKl4nVTcxZ1JgJFo/Xz87SjdPdUswYDxKYnU/b1YmO0JoQUM+P1w6Ry8nYWAoQUwyZSxuNkNic1Eua0chdGlMZlorLjBVLXBWZ3RxOXBWZSJWLG5FX3UvIUg0MTc4LXA6SnVnKWxCalNUOFEmcW1oSzg9Tyo8JFt1T0JJNyxWTF90MFhePSM6KU0jcF9SVEhXNXI0TWAwaDNMQUolUTNqLmE5IXEwKW9Vam5HLio9WWI+U01aLTJwMVtXU2wlWFROJGpRXWkmLTgsQTgvUVZQKDsuSyJjJUA3TnM6TjRNI3E5U19AU1Y6Llp1b2pPU0BAbVBILVdta1poQ1smXT1yTllybzVaQmknJHNCaD41LDVxcTs/ZjpqciFCKm9tbEpOaTMlLWokc0FDbDo1aywzVDtfKjpHIjhlaD8naUltWENjUV07Rm8lMW9HOWpzZ1dgOEQ1OGErOTNUOEgzaEM+PDpvdVNlbW4nOl1EaHNGWHVQKmhDbiFeVWRcJzlqNVtWaWYoKl9HKUdMMTIwTTIoXz84WzxrYFBkKlVcNWE4P0M6MCdvVFlkcGIlZiNfcUZkWUskUl8icW5uNG90bWRJcyxiRjAva25HbHBhJSciOzY3Z1pOT2tLZSxCZmlxKUY5bFYzIVVJPT4mOFxfQSVGdG0mJlFNJmMsPUVQKFsyYzY3QTJGIy5dWnEhQSFcPVJJYCciRFVJJXQ4RVZMJVpVXTthcDcsYlNuVHBDc0NlKzpUck0jRitQTWRCbFFcX3UtRW8yVkUrKjRgJ1xMaWRcVlhjJ2M3Ny1lVUYuTT1wa1w2bWZNXUgncjw0WVpTRyFyMTJEPmY5NGAsKi44SV1nVXJmIihYOyQyQC4/WCgkYWxcVUNLZlFnZ11LIyZsVGxkOjtpcEphIWlaJ0tcVnJvNDYkT19KVCEzbFRmXSFlWFwhJVZiTjE7Jjw+YltJUE1CaGtpMi0sTlE6JycvY1RALj9jLS5hbFVeVCRGT0tLQllDP2FyYlBfVT5BX0xCc2c6V1BeO15MJUI5VWozc1ByTT5yIydKKkwpMWtAbE1xU3RNX2oxdDlYZ087YWEwSkd1ciYlYTJBTV0hdFdjJVAsTGcqazw3anI+VEM9S0EtZU5lPGZwIy8oUy1BSlxGNnBuO0JFOzFJMVlxdWJBKkExPGMqMEteUFkwbF81OXVoPy0pYC8zbWRsbCg1OShJRThbK2dValkwY1xRM2lJcjtwTWdoJjxpJEI4Ui5JJ1pHQVxKZ3BmbEthYjkmJjdwQS1qJUo1KjNzbFUmIWNgLChvUmxgKTlHOSQqUy82JF0/RDIkbWBSWVUnST1TLnAxayFaJzRnRC9pVWdxTTxlY1AmNDkyMmhkPTczWWtaaCdMYnJuLDEpZF09azlFYUc9a21tPElKa0dHODxkVSdYcUpYWDtHa0hqWGoiTkZkLXRcQVw1S140Slo1N081cUhlOTpnKCVndElYcmo3TTxcOCw9VjZvPDdBPS4jLmdeXW90c2ZeTiNWSkUwZT9uKyVNcUVQVWJMKThQbUtvIjJnblpeUixkSmdTaVZNYkxlbENyJicxZDQ8T0teMFhdSl0uUmhNNDJhZksxJiFUYCUzSzxRL20/XEJFMG01UCdyW1BUVUdfOWEmRm07NDI7LlJwO2UsTTNFIm5KLW0paWlmYmI/dWlXTkEuUDQiIWkrci41N0txMFRFdEthKylYVT8pQzE5W0czTz9pMCZiKzxRRW9iajonZFovNzdcW2cpQlUnLiMwRU1CMk9oaDlqITJnLjJAal0sdStANkxQbD5YUG4+XChvTk9jRV5yIjVMb0guKkBsdGQlTCtpUHI3Nko1QEgsOmZmZDJkQ2lGVSRqNEE5YT8oLTlbQmpabTlAJGUsRW44OVklUV4zZjxKUkpDN2BPVzNbUldFWipBRVpBblYwYi49Kl9ROj1AcWRpJz1oOVA5Jy10QyVDPGwtYyFFWEJSbTNqLkcqcGA3RFAsYyk2Ly5AcUxMPnUzZHQjKVdGWDRuO0BNamQ7XEpDQHBPWXEyS2U4RiEuVCRwQHJiLFklcD5VMztnOGFSZDgoJ3FqRlpJIy1FKV8oMWtRQms1LF5HPyhCOFlxTixTY0NzKHRQRF9GTnNmWUU6WjBNR0s1RWhMRnNjUl9cZl1IQUZcMj1RZThvWkFsWSxdTSEsY0tTLURRbF9lT104Rl48dCVrZGhZJGEoa1RBI0VWJlw4WiFFZEpRN2xnSileNFMxWDVNRjFMam5mT2ooRDRaIjRjVCIoMG9WVSRnWyRiRj1POm8ldC9MZV5AaTZwcCZdMWZcOkgpLCZhXkZGVVFLJl88RGA6XzFMMmhSIkdSSz1fUFpTWHU6YmcpTE9hRGJpJjUqcmhpQXNtI2giMTY3RC0+MCVsNyE8PkRcWkpeP2NAODYlVDE8S3ImNE5tYypCT3AsUDs4czJcaE0mUSZRa0w2a0dAZnFbQkdiKydhVmEpR3UsaEFKJG5uZiwyUi1YMFgncTZgP1AsTmI/X3FocyRJQj0xM09MXz1TWyRNVGZsc0pLYWw8Rn4+ZW5kc3RyZWFtCmVuZG9iagoyOSAwIG9iago8PAovRmlsdGVyIFsgL0FTQ0lJODVEZWNvZGUgL0ZsYXRlRGVjb2RlIF0gL0xlbmd0aCA3ODcKPj4Kc3RyZWFtCkdhdD1oRGJvK0EmQjxXJTtxc0hCJmdrbz1WRlxALUJHOGpeWyc8PFIsaTRwTGczUT9XYl0sJyxwLGI/MSJxMXF0PEc8REVJRiRhPFNxS0hyKzc/biUjMmo+Li1ncyhiJkZxXkpSKVAub183UCpiQ1ZmYSxRUlUsK1BmTkREQD00P0NrVCM5WSsjXVNsQWAuVy0zbzVmJUsvJyZtRzhPcENcTisraE9UMSIzTkQnOyo1MGxlZ2Qvc1tqVlZzOipKOyg/R0FBRk0zTz0vNWQ3JENKKSI8TWo5Yl91JUI3PCM1QT1jKjVEZStLaUZqa0BTcmlUNyEnTWpwSkM8NVlMMkNqOytbbCEhRGFmIjJFXi5OJHQ1W0JOUTAlZi9yIyVHMzchJmckS1EudUxMV1RJTExWMWZCWUtFZiptZ00yWURmQ2hqMSxTXEE/U1JWISdqMCNKckAhVFYhRyRmXyFWRUBYLyYuJSRIK3EtRzkmYkQydEZgWDY5UWlWT0IqJShaWm8uWVIzJzhRbWZlLm0hPWkoMFhrP0hMKm49VFg4RSRjL0BwPU9WXExcRTohczNkYC8wT2xWPHBYbEs7IiRUczpuc1wzWV9vZCFcTGBOLytiZFJFaGtGVypaWUZTMUVnRFRvc0dLYXE+XitBUCZmJEwwTl41cVdiTCJrMF5YUFMwYFNjT0tSNXAnKGw1bz1GPmcqO2tDWzlPIXNxKDVQQ0RVJjlZN2VgQDUmKz5uUEFWIWYka21kOS80MVBxR15LMCdWJCQrLm9VKCRyM0pZIyNRNCsqJy0nIXIndVk6LzVGVygxcXM2LTpOSVA7MUVHcmBtLCpGWmdXdE43ITtFZyVzIztIJUJIIm0oQl1rNSlXVkxRKiFUOlhLWnFhY0tuLVxNUig7R1tdXWBPZUFyZSZFbiNqJmxAPWViWGowdTVEMkkoK19ZImhmMGFIclBFaWk7QElbWTdjb1hnMSlOMT4kNGdCY1shMjtLNnMmLGBfY0l1NSs+TVhLSTJHUidGJFYqZXJBXihVVGpNJmtmJnFlfj5lbmRzdHJlYW0KZW5kb2JqCjMwIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDIzMDUKPj4Kc3RyZWFtCkdhdUhMYkJEVyInJkVGOEMsNk8kTyRqV3ErJls5JVAoJChkajBZblpDcVA8aTg0NixhQ11MaTpeUm0hOyZoMlNARkYqKjEzM2MmLF5vYjNALTNHPz5SLzxHPyE3cVVncU8lP2xAJ0tiS0g2RmhXaTckXUZZNyZwcFJEZHI9TmBjV1pQXiUhW2NZc3NZaig2JCMiP1xVOC1hTmZjYUgqNEkhOy0qaGNYX0JpKGAiRGEiTWVKdSNRYig7QUJdWmZAQkhXXmp0Ly11XztaaC9yPCVPVTY0VF5qbyJqaS4qUkNVKVZ1ckchTF9tdXEmaztYNEdQUDIsUCNiVnNHL3QqKy5mQj9TWnMoUjxeZCRkMVFSYEdOXEAiWSlWbz1MKkNgbmMsUUNrME8sKmFhZklTNmZsSGAmWnU+I1lcY3JXPyo/OVQydF0rayhmYDFwIiY2XzwoZys+aidbaiJeWUE0SytZKUpXV0pCYk5JZTNIMW8tLF5VOV8hSEwkRF40U0g+LHNCbGNnRjs9TjtcLSMuMWBqZ1oiKUBtJ05sQ2lRRlhhYFhBaDQmbzxxZDpDLCw0JWQ7KUw0ZmFjS15tRC9oQ09XYCkzVHFYLWRyWSwtPzVELEBcZ2tYNi9dWGtMPUFZQCNcMU5wIWBoTitZWFhBOjNLZiE+cVpeJD4mR1FRT1xgN1FNaFZeOTJCJjcmOjolclJVJ0lNQTktSWlUTU9BMCVJQSgsVyRxbDRDVSFJKTM3SEAjXjdcKiJSMCRzTCRvQyJ1SW5eS2A1RGhGTmJoNk9AVnRobkZJYGlsQ0ZoXlM2IjMvXjFhP1ZwTiRyZkEkWVFnTUxWJmQ2VnRQOic2N2xjJ0RFS2YsOHJOaVcyISQrUWVtb2g7L1tCWkM3XFcnUSYlLVxqOG9AXCtcL1o/QGBYQCw4VTI9SHIvS2ZWN1k/L3JCMSlbKEFGVzdCOD1CVi4oTDUzb20/blddKjNoaT9lN29GQCc8LFpwQ2JdaHFPLUErUV9FMSdXRUwrWmchcy8xKzsuUyRRUllYKE5aaVE1bnFEI0BCLmEqdDckWD9hWiM3YHQsV0o6dCZZcGBKKGUhLkhIcDVlZXBcJnItLTxyVklHKTwlQF5nZUxYZWMyXmMvaTEjV2JtdTFQX1ZWZzRBMFBmWllMSnMzTjZCJnVZWUJLIlApZTsvTnBmRVcvSm1jPEZVOSY3Sz0tRG9WXiYrb3BHRWFlUm5kMDJkVlhsYEVldURGKkhDdW9cbF5zajMqbFtALHInJU0hR14vWWZraTxzTWo6QHRdPHVabUFiaFA2Nzs7TyhxI0IqJjJrPUUnX3MwLnRbLUxaLSUyaGZKUi9fM2M3QmtIWGg2UEE9RkdtXVIvS0hBXjU1IzQ3JVVNLzk6dUVFSnE+Q3MiIk4pT3NoKFFhJjlDWkM9NEJyM3U5OEVBSkpKZGBNJG9TW1c6bDlmOExHQjkrMzBZTyouWFMrMFwlcFhsWzRYJyJEZyFdMUVORmN1LWN0OTYrSXBuM1NDO0dZVjdScEguQDk8X0xPcTBKMHVBc2VATU5xWkc2Qk9tXG5nWDxuNyUmbi5LYHVrQztcLjgwYTpQYkdlT3NNXjRIJ1BiKilUMUBAUSE7KT9eSk1tRkF0TjFWKCkmWFhJN3VpYEtUa0REOXJEa01HR10uZUY4KkxuZCxmJE9wSiNsRiFgOUZgZGA/NHBsLjwuOkQiPywhSVRvLGwtMkNoIUcvIkpbQkRpPFtkOjIwRkEzJWcuPl5vREYoIl4pUVFJPWs3bCVYVk1jNyk7Zkc/VUp1Py9bYjdzW2doZzM/aDUsIVcnLUhRITUlOV1sK2AqUj5DOzxbTSshajprQi4xO0w6LzRnZl1UKUs/K189Sj1EJD8hcjBAI1BNOU5SamtUTU80MmFyLmIlUWUtXigwRGFzNllOblskSVtnLz8hUXFFUzNMVD8qIk5RdGo8UyNybldOP0tsYXE+ZCFpVS9iJDM2VjNkREVbbmJJSltRay8hTyhmVVUrXVcmXSYsQnEoai51NzdAKmpqKCMta203T3JTXz1eUU0xZGE6ZTxdXnMtYSFtKCtjXCx0Lms2ZU4vUycnVTw3V1ZPOWNEN2AjTjFBVT8hI24iUilWUlxFJ1VVPjJlTl90Q1FxWiEnQy1oKCElXSY7PFQvR1JaT1lfZ2g2LkYrIyI0PVorMlZQVSZjVmwsaiNgPUEtaiNeJidkYiVhLmA2X3VdKltbKjtwJStQQidQX1M9ZFpuW3JPVWhRX25qWClCSnJvYkcrLG1wNiQxRDNUKWJWTzJUJSMzYUgwOFglWiZBPDdSWVlhWW5sY0xiSj9cTG9TI0A9RTwyY09jRi5TRWE5MSQjdF1VJz9OITdQL2dXREwxX1twUTFla1QnW0JjaSonUCRtPmIsRydtXl8jSj5aP2NdPzFGO0FkKlNNYiYrRm9rVDBTJUFURm5sbG1OYyxLKVxBQSNgRF8iKi9qPmwpKTlpdF1lPl9ILyY2QC4kSTEmYy8uLC8nV2c7PyRNN1I9KkdhOm82ZjlOKWNJPT47MFk3MFV0VllxLiQwb2wvZFtTZCg3SihyTy5TcGB0dTBUTmpuOkVTLmsyKDYnNTlNbzxfZD02LFZWNTpiWWxnKChoK2RUdHNqcUBYTl8wWlBNIWtDQXQ8ZXM3Qz9vcWk6R01EZzhOb1ssMlo4ODpWSF4nLUMqTk5wSzglQ1YiOEttK2U9XC0uZkxJdV9IWkonJ25NSnImMylWMnRGJFtxNT4sQFNvaG9lJz04V3VUNyJkMWpLOlxdJU80XGhgYTpTKSJQLCJQTmRxOXRqUmBFYDlHRENvR2NFOSkkSGlyYl5QUGMlUkBLcDtsKz5TLCtVNSl0WyIwbCpDcixeNUhDSCVNS1MsUGo6NXJRWCQuS2N0bDJMOVZcYUZGNVFZMGJRdGdLKEpgVS5SNjoiJyhBN0w3ck9PYihjRjhvLjQ4QDlcLEdPSVM6KjAkcUY9XDglXks0O1BIXFU8cTE2aFpjOj5JKFFPO3RGTmotcHMoNFZwWWlJW1trLGlrSVNvUShTfj5lbmRzdHJlYW0KZW5kb2JqCjMxIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDk2Mgo+PgpzdHJlYW0KR2F1SEk5NWlRPSUpMW4rRTJUUiNsR2RQMF1yYkJBJStudVVGM0koOEJqN1xgSCc0XTxeRTRjVFdTPTdfSjc9Ll5gJjo+WWhoLSJYNlRXWmJiO1RFRjk9WHRlNjk5XjAlZD5xal90IiZmMDcxSFxDJUxEJVJgcVxZRkErJ0csW0YoW1BYalxAI2IuUFkoIi1TaDkmSVI9X2NZOVBsW1AkMDE/S0RaJGVCJEUpJGdCTj5vUWxiXXNEQikvNGUkUkklVmw8MFMqZWxuQz1HbDEmYi1SQCQqT0UnaVtZQDc+Q08wJnNlVF9yOVNlLzdFO0JWRHBoQ3FTTW1JVkZULztmT2AuVkciVDs9XVJ0V2R0cSw5Z1MtVj9lLnBcUlElIzlORk5BOXQvTEFzaWYsPl0yKkslTyQsKSJDck5talsoL0ZQW2QjZDw8L2YsIiM9P2teYzlyUkVjYm5EPCNKKzAvYSxDU1lhdT9JYlhGNzo7RzMuVyIkSzlbcTNsRWZmVT9KcE5ZNmF0USU6SCpLQ2Y8L0JNYF1VbXVvYCVOU1lxIzRULXNqSiFHZzg1K3FPb0RcM21LWUNNc0M+Nk5fO21jNENsVjtOWT1rLTMzJVRFVjc4O2RAbGs1J25lVkhqYzYzQWUoRGAlWSRyXVAlRTAuJyMocilWRUQucVInSjlxWStuOGdYbTwmUllEYmJSKXJra3NoSjVIal5UMTUxNVtMQDdiUkBtV2J1NytpKylGcGIoRUwmIi8tTEluMSowZk5APVUmTE5bWWQ2QiwrWi5qQChzXV1DNyhjSzlTXU9YSSshWmFiSFdKUzFwQURtPV5OPmlNNyF1RF04OVhMOnEiPTJnWE1SMm4wVTZbY0BRIitESVtqXEkmR0hsNVFmTSxLZGtnSCZbb0FuTjFFLEdtO2NmcTEiMVJCX0FcZGsjSSciPiFyXT1DWzhZJiY9amNsQnMoMT9mQV5qZisxdXQqX1U3LE1uSzAhJy1xM1JAXUkmNVdURVFmJWpONFZPUyRAYylsOSNRXk5AP0dhS21PJidmWy8yI2NXRlY+NzxhRzNaZEU8ckowWi1may82YFpzITxEQSFwUWNpWW07MWEzZWpGUl04XjBxKEVZSjhkVWkjOSIwTFctSmFXVT9FKFImTDZYSUEqZUNJRSgtTHJrSFkpTnBBOnNzQGJHKzxRKzQzNU0zKiFfVWUrVD4sdFplJWIqOWxgXypCUi5OMjpwTVo6JWc/YjI0KSRYUV80bWZMLWtEcVYwYUdCViEtOm5Xfj5lbmRzdHJlYW0KZW5kb2JqCjMyIDAgb2JqCjw8Ci9GaWx0ZXIgWyAvQVNDSUk4NURlY29kZSAvRmxhdGVEZWNvZGUgXSAvTGVuZ3RoIDIxMTEKPj4Kc3RyZWFtCkdhdUhMYkF1PnMmQTdsamstWEhNLzRROic5JXA6LmZabmo4RSs1WUE+Tkg1XEplRE9VP3BOKUVyZEdmNjg+S2FMM2MpQSlPcEQ/TCkiZEcvYlwycWc8ckVNLFU1SzJnR2cyJlRbInNRYU5ebyE8b1AvQzpvN1N0V1ZoJFczIXA3bltUL3BkMGJqZFwlai8ncnMuNjIzJlQkMUpccjM4SlVcWU46Uz1IaSxbIWE7Q01FLz1gNl9LQEhHLjw/TytZNE87T0JiZWZaJ1tMSV9LLDJjYm9HO208IzEpRVBwaS8xaCY8K2tLMWktaTFEbD8iJ09SYFU0Jm4sSVM4aDBWLCtKKSMkQ25xQmhaa1IqczZxMzt0QSJjPidrX0U+PlczVE8uOSROPnA9bElfOi9JVEY+PWJzUl04QixoVFFNa08tazFOQGc8V0cxVTt1c2ZgaWdocmJbPllSVmdfY2BrMUsnWiIqMDJnKTwsJ1hjVEhZJ2ZmMjtYTk49SFttQyU5ZW9PRmhhOjg9ZUJVKm87UCU8JSQpNU9cVGlJRkJTXVFvdUVmbXJqa0U6aC5yVSRdZmktdS5XciRDNnFXc10sJ2YpKnA9VSRqKXBJKjhWcWpMbD1wTlJrWmQiUG5AaEFFMjpBT0xQY3Bqblo9KltjZiJRJkxlM0ExKGlQVDg1QVY4V2RFRXMwa3NIWkdpXit0R3A9TiJpayVjXyN0cmBcT25NXC8rPSsmVmFqXFxTdDdcPVhRY1RjUjtTNkZwKFQqKGNLXXNxXkM3N1lmW01KUSFLaWRUV2xxMlBQKEguMys+RkhmWCpoaEIpK2xPLnVBVVUobiVLc0FZTHFCPUQsJDwuXGtCbEU0cD49aytmJSU+TltQczhjXUxvIkUpWXRDRUdPZS5Lc3BWTVwoWGssLk1OJmVjPUhEKj5OWzsuXClkUXBiXSs7ZnFFQ1kyLSYwTjE4QVdJKWopYixeM1NpXCZRJjRPLzs9Z25oQl0qTEAmIXNoQEksVWYiK2s6IV5pUmdEY1kpPV9LQ08nR2lVOFZtVlRdKlNwLi5ARWJlX3NTSFNnPks6Z1cvRV4lOF5MaydNTFhcJjExVS4mTj0la3NGVUBfbF1oWV5MbCVsSTQ4V244XmdLNVZVLCNYZF5dO09wJV0ubzQwYypXby1AMjNUTGRjS2pbLF9jKUBoYWtIIic5YFpxQ24+ZnFMbT5lUXU6VDsiPm8zcDk2SUpmWFM3K2pSWmkyYyMuIlZicDI0RjwsSjZUMiRScEVJbUJBb1l1VEBlJSpTcTBab1UrNkxCXixcazdaOFVUQUMjc0JkYEhVcmByUEk6JFVZYXFaaylYTXA8VEE4NDcjay1QJk5GNHBdRzNBMmxNaFIiU1BFSUlWSzo2cCRORFwrRV1JMT8uJG1eMEUhP2AqVEtXI0QkJ3RUb2BOUk86OHJfZSksV1BIPEQlKlpmVkhyNnMzO3NMPkU1XllLPzsyOzYwckRkUztIVDFHSUZRSVw9SUdwV1Q3aURrOCExZV1ALnVtYCxoWWV0LG51cVsvZmcvWlssN3JFbllQW2A/UyVOMmtmPyszXy4mUEgkMEtrUERPOWI5N2UqZEcmNyJfPzJYS2Z1TUhRSUprUTBOUkQtPjpmQmw+TF1lYD5KRGAocVxRKTQqZjN0L0hPXE9LJmw2aVdpQ29db2guXSxQcjN1JGgwRjtpRTtdS0RMP2Y7RVwoO2MsMGouT2NGdFBVZitGND1OXilEU2pda0ssTVFGQV8tZjc/KzhZLyZATFkxPSdDUVVnLm5xU19VZUV0WDZQcz5lWmBjRE1FMElIOF9ecyFRODM2b3EsNmZZVWMqa0FDOFFLZzRvbCJbWzcjL0cpRkMhJDdwJzo8MEpqKjdvUydFRj1yPTUpaixjXzRDNmEwKGpENC1OIk03P11gak5sR0MlJj51Z3VHVjpfO1RGT2FvaiU5WlQtcFkoOCFhKVlrTyVWZlxLNnQuZGZdWl91Rz9BOTNmSGFVLEZpVDRRb1ZtOGtYNlBjUGlXY0kzNUopbTZuJ1c9cWxaWV1DZkdca3JkOkNBaW01bl8hXi4zOFEoSlBQIUM6L0BTZTdlS2wrVzBGYUwxNm83SnNQQ29UNVBEY04+SjE6K3VfZkNoK2xPMzY2TWNDVixGUEtacD00TUAiLlxsLFMrb0pEPCpjWC5ZQVUmaWRQcXNOWjBtWV8/bGxqUV9EKzVUUEhULVkwZSFDa2x0SCRGLGpeSnFWN1RqXEAmLmc1TDgvTks6SkJPV2pxSys8Y1VaLzRPKGEsKVVBIm4nbDEnODtgZUNtdWw3WiJaSTFoamNZaUQwP3EiXSdsV2JnT3VgMVUjJic3bltMQlsxWmNEPSc9VTNlRykiJDhVJSpUUVNiN2EoZ1lHXVEqc3QlcnJWYTVIKUspMSVnUypVIkJ0LDAlWEE9SWtCV3NaMGV0S3FWMWcjTTtsZEs1XilRWl9lRl9MRE1GQGMkYUY9P2MhRlE7anVZS10+ZU9QQTFWRmFLIVElVUMkaCpkPDYuZVwrMTJKYmRVJFJJSVBLU1gkKi9YVnVTLUFlWCdtNl5rTWo5YDBhNEF1ZFo0QHVnIlAtRkJdP2FTUEwiW0NrK201QUJPO1Qnc3FFcD4vXFMtUV8sS0ZyL1FaXjQvQHFLYFZfMHJRKT0uLVAhZ1pmI2FYN09uWCk4JFBEJ140UFNdY1E8Si0lYGJrKW8nVCpTT00+TE9sZSthYj1dX080Pm03Y2pvaEh0ZDM3K0kiPEFvbzthal9CS3NJWCFyTFBRKFdlNCc9Wn4+ZW5kc3RyZWFtCmVuZG9iagp4cmVmCjAgMzMKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDYxIDAwMDAwIG4gCjAwMDAwMDAxMDIgMDAwMDAgbiAKMDAwMDAwMDIwOSAwMDAwMCBuIAowMDAwMDAwMzIxIDAwMDAwIG4gCjAwMDAwMDA1MjYgMDAwMDAgbiAKMDAwMDAwMDczMSAwMDAwMCBuIAowMDAwMDAwOTM2IDAwMDAwIG4gCjAwMDAwMDExNDEgMDAwMDAgbiAKMDAwMDAwMTM0NiAwMDAwMCBuIAowMDAwMDAxNTUxIDAwMDAwIG4gCjAwMDAwMDE3NTcgMDAwMDAgbiAKMDAwMDAwMTk2MyAwMDAwMCBuIAowMDAwMDAyMTY5IDAwMDAwIG4gCjAwMDAwMDIzNzUgMDAwMDAgbiAKMDAwMDAwMjU4MSAwMDAwMCBuIAowMDAwMDAyNzg3IDAwMDAwIG4gCjAwMDAwMDI5OTMgMDAwMDAgbiAKMDAwMDAwMzA2MyAwMDAwMCBuIAowMDAwMDAzMzQ0IDAwMDAwIG4gCjAwMDAwMDM0ODcgMDAwMDAgbiAKMDAwMDAwNDIzNSAwMDAwMCBuIAowMDAwMDA1MzM2IDAwMDAwIG4gCjAwMDAwMDczOTggMDAwMDAgbiAKMDAwMDAwOTY2MCAwMDAwMCBuIAowMDAwMDExNjUxIDAwMDAwIG4gCjAwMDAwMTMzMDkgMDAwMDAgbiAKMDAwMDAxNTE0NyAwMDAwMCBuIAowMDAwMDE1NDQ4IDAwMDAwIG4gCjAwMDAwMTc2MTUgMDAwMDAgbiAKMDAwMDAxODQ5MyAwMDAwMCBuIAowMDAwMDIwODkwIDAwMDAwIG4gCjAwMDAwMjE5NDMgMDAwMDAgbiAKdHJhaWxlcgo8PAovSUQgCls8YTA4OWMzYzdiYjAxZjMwYWYwZDJmMmEzNzFmNzJjNWY+PGEwODljM2M3YmIwMWYzMGFmMGQyZjJhMzcxZjcyYzVmPl0KJSBSZXBvcnRMYWIgZ2VuZXJhdGVkIFBERiBkb2N1bWVudCAtLSBkaWdlc3QgKG9wZW5zb3VyY2UpCgovSW5mbyAxOCAwIFIKL1Jvb3QgMTcgMCBSCi9TaXplIDMzCj4+CnN0YXJ0eHJlZgoyNDE0NgolJUVPRgo=';
  var bin=atob(b64);var arr=new Uint8Array(bin.length);
  for(var i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);
  var blob=new Blob([arr],{type:'application/pdf'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url;a.download='salary-tracker-manual.pdf';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
function exportPeriods(){
  save();
  var data={year:aYr,periods:years[aYr].periods};
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob);var a=document.createElement('a');
  a.href=url;a.download='periods-'+aYr.replace('/','-')+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
function importPeriods(input){
  var file=input.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var data=JSON.parse(e.target.result);
      if(!data.periods||!Array.isArray(data.periods)){alert('Invalid periods file.');return}
      var src=data.year||'unknown';
      if(!confirm('Import '+data.periods.length+' periods'+(src!=='unknown'?' from '+src:'')+'?\\n\\nThis will REPLACE all period data for '+aYr+'.\\n\\nSettings, accounts, holidays etc will not be affected.')){input.value='';return}
      years[aYr].periods=data.periods;
      years[aYr].periods.forEach(function(p){if(!p.extras)p.extras=[];if(p.cutoff===undefined)p.cutoff='';if(p.payDate===undefined)p.payDate=''});
      save();rAll();sw(aTab);
      alert('Imported '+data.periods.length+' periods into '+aYr+'.');
    }catch(err){alert('Error: '+err.message)}
    input.value='';
  };
  reader.readAsText(file);
}
function buildHelpContent(){
  var h='';
  var secs=[
    {t:'Getting Started',c:'This app tracks your UK salary including tax, NI, pension, overtime, shift allowance, holidays, and expenses. All data is stored locally in your browser — no login required. Run the <b>Setup Wizard</b> (Settings \u2192 top) to configure your work pattern, salary, and tax code.'},
    {t:'Dashboard',c:'At-a-glance view of your current month and year-to-date totals. Shows take-home, gross, tax, NI, pay date countdown, and a monthly trend chart.'},
    {t:'Pay Periods',c:'Each tax year has 13 periods (March\u2013March). Set period dates, weeks, and pension %. Tap <b>Add</b> to enter bonuses, extra OT, bank holidays, expenses, or mileage. Unlock with the lock icon to edit dates.'},
    {t:'Pay Calculation',c:'<b>Gross</b> = Base salary + Shift allowance + Compulsory OT + Bank holiday pay + Bonuses + Extra OT + Expenses + Mileage \u2212 Pension \u2212 Salary sacrifice.<br/><b>Take-home</b> = Gross \u2212 Tax \u2212 NI \u2212 Student loans.'},
    {t:'Shift Allowance',c:'Each shift type has an allowance %. Calculated as: <i>worked hours \u00D7 base rate \u00D7 (allowance% \u00F7 100)</i>. Not paid on bank holidays or holiday days.'},
    {t:'Overtime',c:'<b>Compulsory:</b> Rules configured per day-of-week with hours and rate multiplier (auto-calculated each working day). <b>Extra:</b> Added manually per date with hours worked.'},
    {t:'Bank Holidays',c:'Added per date with hours and multiplier (1x\u20133x). 2x = double normal rate. Optionally include shift allowance in the BH base rate.'},
    {t:'Tax & NI',c:'Supports England/Wales and Scottish tax bands. NI at 8%/2% above thresholds. Student loans: Plans 1, 2, 4, 5, and Postgrad (multiple can be active). Tax codes: standard, BR, D0, D1, K codes, NT.'},
    {t:'Salary Changes',c:'Add multiple mid-year salary changes in Settings \u2192 Pay &amp; Salary. Each change specifies a month and new annual salary. The app automatically uses the correct salary for each period.'},
    {t:'Breakdown',c:'Detailed month-by-month table of every pay component. Tap any month for a full modal breakdown to verify against your payslip.'},
    {t:'Annual Summary',c:'Full tax year totals for all components — useful for tax returns and annual reviews.'},
    {t:'Accounts',c:'Track bank accounts with balances, transactions, and monthly forecasts. Supports transfers between accounts and salary override.'},
    {t:'Spending',c:'Monthly expense tracker with categories, recurring costs (rent, bills), and budgeting. Navigate month by month.'},
    {t:'Pension Forecast',c:'Multiple pension pots (DB/DC). Projects total value at retirement with compound growth, CPI adjustment, 25% lump sum option, and drawdown rate.'},
    {t:'Calendar & Holidays',c:'Shift calendar colour-coded by type. Book holidays (full, half-day, or custom hours). Holiday pay uplift calculated per HMRC 52-week average — replaces lost SA/OT with an uplift based on average hourly rate vs base rate.'},
    {t:'Known Hourly Rate Override',c:'In Calendar settings, enter your known average hourly rate and tick "Always use known rate" to override the 52-week calculation. Useful when you know your actual rate from your employer.'},
    {t:'Work Profiles',c:'Save and switch between different job configurations. Supports mid-year profile switches (e.g. promotion) that change all settings from a specified month.'},
    {t:'Theme & Appearance',c:'Found in Settings → Display &amp; Tabs. Dark/Light toggle. Both themes have 7 accent colours. Light theme has a brightness slider (bright white to very dark). Settings saved automatically.'},
    {t:'Tab Order',c:'In Settings \u2192 Display &amp; Tabs, show/hide tabs and reorder with \u25B2\u25BC arrows. Dashboard always stays first.'},
    {t:'Data Backup',c:'<b>Export All:</b> Full JSON backup of everything. <b>Selective Export:</b> Choose which categories to include (salary, accounts, spending, pension, holidays, profiles, settings). <b>Import:</b> Restore from backup (replaces matching data). <b>Periods only:</b> Export/import just the period data for the current year. <b>.ics export:</b> Shift calendar for Google/Apple/Outlook.'},
    {t:'Mileage',c:'HMRC approved rates: 45p/mile for first 10,000 miles, 25p/mile thereafter. Enter miles and it auto-calculates, splitting at the threshold.'},
  ];
  secs.forEach(function(s){
    h+='<div style="margin-bottom:10px;padding:10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs)">';
    h+='<div style="font-size:12px;font-weight:700;color:var(--bl);margin-bottom:4px">'+s.t+'</div>';
    h+='<div style="font-size:11px;color:var(--tx2);line-height:1.5">'+s.c+'</div></div>';
  });
  h+='<div style="margin-top:8px;padding:10px;background:rgba(99,102,241,.04);border:1px solid rgba(99,102,241,.12);border-radius:var(--rs);font-size:10px;color:var(--tx3)"><b>Glossary:</b> SA = Shift Allowance, OT = Overtime, NI = National Insurance, BH = Bank Holiday, DB = Defined Benefit pension, DC = Defined Contribution pension, CPI = Consumer Price Index, HMRC = HM Revenue &amp; Customs, PWA = Progressive Web App</div>';
  return h;
}
function importData(input){
  var file=input.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var data=JSON.parse(e.target.result);
      if(typeof data!=='object'||!data){alert('Invalid file: not a valid backup.');return}
      // Handle new format with accounts/spending/pension
      var yearData=data;
      if(data.years){
        yearData=data.years;
        if(data.accounts&&Array.isArray(data.accounts)){accts=data.accounts;svAccts()}
        if(data.spending&&typeof data.spending==='object'){spending=data.spending;svSpend()}
        if(data.pensionCfg&&typeof data.pensionCfg==='object'){penCfg=data.pensionCfg;svPenCfg()}
        if(data.recurringExpenses&&Array.isArray(data.recurringExpenses)){recurDefs=data.recurringExpenses;svRecur()}
        if(data.workProfiles&&Array.isArray(data.workProfiles)){workProfiles=data.workProfiles;svProfiles()}
        if(data.holidays&&Array.isArray(data.holidays)){holidays=data.holidays;svHolidays()}
        if(data.holidayCfg&&typeof data.holidayCfg==='object'){holCfg=data.holidayCfg;svHolCfg()}
        if(data.tabOrder&&Array.isArray(data.tabOrder)){tabOrder=data.tabOrder;svTabOrder()}
        if(data.lightThemeCfg&&typeof data.lightThemeCfg==='object'){ltCfg=data.lightThemeCfg;svLtCfg();if(document.documentElement.classList.contains('light'))applyLightScale()}
      }
      var ks=Object.keys(yearData).filter(function(k){return /^\d{4}\/\d{2}$/.test(k)});
      if(ks.length===0){alert('No year data found in file.');return}
      // Only take valid year keys
      var cleanYears={};ks.forEach(function(k){cleanYears[k]=yearData[k]});
      if(!confirm('Import '+ks.length+' year(s): '+ks.join(', ')+'?\n\nThis will REPLACE all current data.')){input.value='';return}
      years=cleanYears;
      var sorted=Object.keys(years).sort();
      aYr=sorted[0];
      load(aYr);
      // Run migration on imported data
      Object.keys(years).forEach(function(yr){
        if(years[yr].periods)years[yr].periods.forEach(function(p){if(!p.extras)p.extras=[];if(p.cutoff===undefined)p.cutoff='';if(p.payDate===undefined)p.payDate=''});
        if(years[yr].cfg){var c=years[yr].cfg;
          if(!c.profile)c.profile='shift-rotating';
          if(!c.payFreq)c.payFreq='monthly';
          if(!c.payBasis)c.payBasis='salaried';
          if(c.hourlyRate===undefined)c.hourlyRate=0;
          if(!c.taxRegion)c.taxRegion='england';
          if(!c.studentLoans)c.studentLoans=[];
          if(!c.sacrifices)c.sacrifices=[];
          if(!c.payMode)c.payMode='arrears';
          if(c.unpaidBreak===undefined)c.unpaidBreak=0.5;
          if(c.bhIncludeSA===undefined)c.bhIncludeSA=false;
          if(!c.setupDone)c.setupDone=true;
          if(c.compMaxPct===undefined)c.compMaxPct=10;
          if(!c.penTiers)c.penTiers=[{emp:4,comp:8},{emp:5,comp:9},{emp:6,comp:10}];
          if(!c.otRules)c.otRules=[{days:[1,2,3,4,5],hours:0,rate:1,label:'None'}];
          if(!c.salaryChanges)c.salaryChanges=[];
          if(!c.shiftTypes)c.shiftTypes=[{id:'day',label:'Day',hours:11.25,totalHours:12,allowancePct:c.saPct||33.33,color:'var(--gn)'},{id:'night',label:'Night',hours:11.25,totalHours:12,allowancePct:c.saPct||33.33,color:'var(--bl)'},{id:'off',label:'Off',hours:0,totalHours:0,allowancePct:0,color:'var(--tx3)'}];
          if(c.shiftTypes)c.shiftTypes.forEach(function(st){if(st.totalHours===undefined)st.totalHours=12});
          if(!c.sp)c.sp=[{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'off'},{t:'off'}];
        }
      });
      cfg=years[aYr].cfg;tax=years[aYr].tax;
      save();rAll();sw(aTab);
      try{rS()}catch(e){}
      alert('Successfully imported '+ks.length+' year(s).');
    }catch(err){alert('Error reading file: '+err.message)}
    input.value='';
  };
  reader.readAsText(file);
}
function rSPat(){var c=document.getElementById('spC');if(!c)return;var h='';var types=(cfg.shiftTypes||[{id:'day',label:'Day'},{id:'night',label:'Night'},{id:'off',label:'Off'}]);cfg.sp.forEach(function(s,i){var cls=s.t==='off'?'off':s.t==='day'?'day':'night';h+='<div class="sr '+cls+'"><span style="font-weight:700;font-size:10px;color:var(--tx3);width:26px">D'+(i+1)+'</span><select onchange="spCh('+i+',this.value)">';types.forEach(function(st){h+='<option value="'+st.id+'"'+(s.t===st.id?' selected':'')+'>'+st.label+'</option>'});h+='</select>';if(s.t!=='off')h+='<input type="number" style="width:55px;text-align:center" value="'+(s.h||0)+'" step=".25" onchange="cfg.sp['+i+'].h=+this.value||0;save();rS()"><span style="font-size:10px;color:var(--tx3)">hrs</span>';h+='</div>'});c.innerHTML=h}
function spCh(i,v){var st=getShiftType(v);cfg.sp[i]=v==='off'?{t:'off'}:{t:v,h:st?st.hours:11.25};save();rSPat()}
function aSP(){cfg.sp.push({t:'off'});save();rSPat()}
function rSP(){if(cfg.sp.length>1){cfg.sp.pop();save();rSPat()}}

// ═══ CHART HELPER ═══
function mkChart(pm,sy){
  var mx=Math.max.apply(null,pm.map(function(d){return d.tH})),h='',rows=[],row=[];
  var avg=pm.reduce(function(s,d){return s+d.tH},0)/pm.length;
  h+='<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><span style="font-size:10px;font-weight:600;color:var(--tx3);font-family:\'Geist Mono\',monospace;background:var(--glass2);padding:4px 12px;border-radius:20px;border:1px solid var(--bd)">AVG: <span style="color:var(--yw)">'+fmt(avg)+'</span></span></div>';
  pm.forEach(function(d,i){row.push({d:d,i:i});if(row.length===4||i===pm.length-1){rows.push(row);row=[]}});
  rows.forEach(function(r2){
    h+='<div class="cc-row">';
    r2.forEach(function(item){var d=item.d,idx=item.i;var p=mx>0?d.tH/mx*100:0,ic=isN(d.m,sy);var dev=d.tH-avg,devStr=(dev>=0?'+':'')+fs(dev);h+='<div class="cw" style="cursor:pointer" onclick="goMBD('+idx+')"><span style="font-size:8px;font-weight:600;font-family:\'Geist Mono\',monospace;color:'+(dev>=0?'var(--gn)':'var(--rd)')+'">'+devStr+'</span><span class="cv">'+fs(d.tH)+'</span><div class="cb2" style="height:'+p+'%;background:'+(ic?'linear-gradient(180deg,var(--bl2),var(--bl))':'linear-gradient(180deg,var(--gn2),var(--gn))')+';opacity:'+(ic?1:.6)+'"></div><span class="cl" style="'+(ic?'color:var(--bl2);font-weight:700':'')+'">'+d.m.substring(0,3)+'</span></div>'});
    h+='</div>';
  });
  return h;
}
function goMBD(idx){
  // Show month detail card on dashboard (like "This Month" hero card)
  var data=cAll(),pm=data.length>1?data.slice(1):data;
  if(idx<0||idx>=pm.length)return;
  var d=pm[idx];
  var pIdx=data.length>1?idx+1:idx;
  var pdStr=d.payDate?fd(d.payDate):'Not set';
  var daysUntil='';
  if(d.payDate){var today=new Date();today.setHours(0,0,0,0);var pp=d.payDate.split('-');var pd=new Date(+pp[0],+pp[1]-1,+pp[2]);var diff=Math.ceil((pd-today)/864e5);if(diff>0)daysUntil=' <span style="color:var(--gn);font-size:10px">('+diff+' day'+(diff===1?'':'s')+')</span>';else if(diff===0)daysUntil=' <span style="color:var(--gn);font-size:10px;font-weight:700">TODAY!</span>';else daysUntil=' <span style="color:var(--tx3);font-size:10px">('+Math.abs(diff)+' day'+(Math.abs(diff)===1?'':'s')+' ago)</span>'}
  var ec=(d.extras||[]).length;
  var mh='<div class="cd cd-bl" id="dashMonthDetail" style="scroll-margin-top:60px"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent">'+ICO.pin+'</span> '+d.m+'</span><button class="btn bg bx" onclick="closeMBD()">'+ICO.x+' Close</button></h3>';
  mh+='<div class="sg" style="margin-bottom:12px">';
  mh+='<div class="st"><div class="st-l">Take Home</div><div class="st-v" style="font-size:20px;color:var(--bl2)">'+fmt(d.tH)+'</div></div>';
  mh+='<div class="st"><div class="st-l">Gross</div><div class="st-v" style="font-size:16px">'+fmt(d.gP)+'</div></div>';
  mh+='<div class="st"><div class="st-l">Tax</div><div class="st-v" style="font-size:16px;color:var(--rd2)">'+fmt(d.tx)+'</div></div>';
  mh+='<div class="st"><div class="st-l">NI</div><div class="st-v" style="font-size:16px;color:var(--rd2)">'+fmt(d.ni)+'</div></div></div>';
  mh+='<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 10px;font-size:12px;padding:12px 14px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);align-items:center">';
  mh+='<span style="color:var(--tx3)">Pay date:</span><span style="font-weight:700;font-family:\'Geist Mono\',monospace">'+pdStr+' '+daysUntil+'</span>';
  mh+='<span style="color:var(--tx3)">Period:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px">'+(d.start?fd(d.start):'')+' \u2013 '+(d.end?fd(d.end):'')+'</span>';
  mh+='<span style="color:var(--tx3)">Pension:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--pu)">'+fmt(d.pG)+' ('+(d.pP*100).toFixed(0)+'%)</span>';
  if(d.sA>0)mh+='<span style="color:var(--tx3)">Shift allow.:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--or)">'+fmt(d.sA)+'</span>';
  if(d.holSup>0)mh+='<span style="color:var(--tx3)">Hol. supplement:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--gn)">'+fmt(d.holSup)+'</span>';
  if(d.otTotal>0)mh+='<span style="color:var(--tx3)">Comp. OT:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px">'+fmt(d.otTotal)+'</span>';
  if(d.bHg>0)mh+='<span style="color:var(--tx3)">Bank hol.:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px">'+fmt(d.bHg)+'</span>';
  if(d.bon>0)mh+='<span style="color:var(--tx3)">Bonus:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--gn)">'+fmt(d.bon)+'</span>';
  if(d.sl>0)mh+='<span style="color:var(--tx3)">Student loan:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--or)">'+fmt(d.sl)+'</span>';
  if(ec>0)mh+='<span style="grid-column:1/-1;margin-top:2px"><span style="background:var(--blg);color:#fff;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px">'+ec+' extra'+(ec>1?'s':'')+'</span></span>';
  mh+='</div></div>';
  // Insert or replace the detail card
  var existing=document.getElementById('dashMonthDetail');
  if(existing)existing.outerHTML=mh;
  else{
    var chartCard=document.querySelector('#c-dash .cd:last-child');
    if(chartCard)chartCard.insertAdjacentHTML('beforebegin',mh);
  }
  document.getElementById('dashMonthDetail').scrollIntoView({behavior:'smooth',block:'center'});
}
function closeMBD(){var el=document.getElementById('dashMonthDetail');if(el)el.remove()}

// ═══ DASHBOARD ═══
function rDash(){
  var data=cAll(),pm=data.length>1?data.slice(1):data,sy=parseInt(aYr.split('/')[0]);
  var t={gP:0,tx:0,ni:0,pG:0,sA:0,holSup:0,bHg:0,ot:0,tH:0,bon:0,otX:0,sl:0,sacT:0};
  pm.forEach(function(d){t.gP+=d.gP;t.tx+=d.tx;t.ni+=d.ni;t.pG+=d.pG;t.sA+=d.sA;t.holSup+=(d.holSup||0);t.bHg+=d.bHg;t.ot+=d.o13g+d.o15g+d.o2g;t.tH+=d.tH;t.bon+=d.bon;t.otX+=(d.otX||0);t.sl+=(d.sl||0);t.sacT+=(d.sacT||0)});
  var cur=null,curI=-1;pm.forEach(function(d,i){if(isN(d.m,sy)){cur=d;curI=i+1}});
  var h='<div class="yb" id="yd"></div>';
  // Current month hero card
  if(cur){
    var ec=(cur.extras||[]).length;
    var pdStr=cur.payDate?fd(cur.payDate):'Not set';
    var daysUntil='';
    if(cur.payDate){var today=new Date();today.setHours(0,0,0,0);var pp=cur.payDate.split('-');var pd=new Date(+pp[0],+pp[1]-1,+pp[2]);var diff=Math.ceil((pd-today)/864e5);if(diff>0)daysUntil=' <span style="color:var(--gn);font-size:10px">('+diff+' day'+(diff===1?'':'s')+')</span>';else if(diff===0)daysUntil=' <span style="color:var(--gn);font-size:10px;font-weight:700">TODAY!</span>';else daysUntil=' <span style="color:var(--tx3);font-size:10px">('+Math.abs(diff)+' day'+(Math.abs(diff)===1?'':'s')+' ago)</span>'}
    h+='<div class="cd cd-bl"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent">'+ICO.pin+'</span> This Month: '+cur.m+'</span><button class="btn bp bx" onclick="oEM('+curI+')">'+ICO.plus+' Add</button></h3>';
    h+='<div class="sg" style="margin-bottom:12px">';
    h+='<div class="st"><div class="st-l">Take Home</div><div class="st-v" style="font-size:20px;color:var(--bl2)">'+fmt(cur.tH)+'</div></div>';
    h+='<div class="st"><div class="st-l">Gross</div><div class="st-v" style="font-size:16px">'+fmt(cur.gP)+'</div></div>';
    h+='<div class="st"><div class="st-l">Tax</div><div class="st-v" style="font-size:16px;color:var(--rd2)">'+fmt(cur.tx)+'</div></div>';
    h+='<div class="st"><div class="st-l">NI</div><div class="st-v" style="font-size:16px;color:var(--rd2)">'+fmt(cur.ni)+'</div></div></div>';
    h+='<div style="display:grid;grid-template-columns:auto 1fr;gap:4px 10px;font-size:12px;padding:12px 14px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);align-items:center">';
    h+='<span style="color:var(--tx3)">Pay date:</span><span style="font-weight:700;font-family:\'Geist Mono\',monospace">'+pdStr+' '+daysUntil+'</span>';
    h+='<span style="color:var(--tx3)">Period:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px">'+(cur.start?fd(cur.start):'')+' \u2013 '+(cur.end?fd(cur.end):'')+'</span>';
    h+='<span style="color:var(--tx3)">Pension:</span><span style="font-family:\'Geist Mono\',monospace;font-size:11px;color:var(--pu)">'+fmt(cur.pG)+' ('+(cur.pP*100).toFixed(0)+'%)</span>';
    if(ec>0)h+='<span style="grid-column:1/-1;margin-top:2px"><span style="background:var(--blg);color:#fff;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px">'+ec+' extra'+(ec>1?'s':'')+'</span></span>';
    h+='</div></div>';
  }
  // Annual summary cards
  h+='<div class="sg">';
  h+='<div class="st" style="border-left:3px solid var(--gn)"><div class="st-l">Annual Gross</div><div class="st-v" style="color:var(--gn)">'+fs(t.gP)+'</div><div class="st-s">'+fs(t.gP/12)+'/mo</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--bl)"><div class="st-l">Annual Take Home</div><div class="st-v" style="color:var(--bl2)">'+fs(t.tH)+'</div><div class="st-s">'+fs(t.tH/12)+'/mo</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--rd)"><div class="st-l">Tax + NI</div><div class="st-v" style="color:var(--rd2)">'+fs(t.tx+t.ni)+'</div><div class="st-s">'+(t.gP>0?((t.tx+t.ni)/t.gP*100).toFixed(1):0)+'% eff.</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--pu)"><div class="st-l">Pension</div><div class="st-v" style="color:var(--pu)">'+fs(t.pG)+'</div><div class="st-s">'+fs(t.pG/12)+'/mo</div></div></div>';
  // Chart
  h+='<div class="cd"><h3>'+ic('chart')+' Monthly Take Home</h3>';
  h+=mkChart(pm,sy);
  h+='</div>';
  document.getElementById('c-dash').innerHTML=h;yBt('yd');
}

// ═══ PAY PERIODS ═══
function rPer(){
  var per=years[aYr].periods,sy=parseInt(aYr.split('/')[0]);
  var h='<div class="yb" id="yp"></div><div class="cd cd-rd"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent-rd">'+ICO.cal+'</span> Pay Periods: Apr '+sy+' \u2013 Mar '+(sy+1)+'</span><button class="btn '+(perLocked?'bg':'bp')+' bs" onclick="tgLock()" style="font-size:11px" title="'+(perLocked?'Unlock editing':'Lock editing')+'">'+(perLocked?ICO.lock+' Locked':ICO.unlock+' Unlocked')+'</button></h3>';
  h+='<div class="ib" style="margin-top:0;margin-bottom:14px">Set dates, pension%, and payroll cutoff per month. Use "Add" to add bonuses, extra OT, and bank holidays.</div>';
  var hasProf=workProfiles.length>0;
  h+='<div class="tw"><table class="dt"><thead><tr><th>Month</th><th>Start</th><th>End</th><th class="r">Wks</th><th class="r">Sacrifice%</th><th class="r">Co.%</th><th>Cutoff</th><th>Pay Date</th><th>Extras</th>'+(hasProf?'<th>Profile</th>':'')+'<th></th></tr></thead><tbody>';
  per.forEach(function(p,i){
    var lb=i===0?p.m+' (pre)':p.m,ec=(p.extras||[]).length,coPct=gCM(p.penPct*100),dis=perLocked?' disabled':'';
    h+='<tr><td style="font-weight:700">'+lb+'</td>';
    h+='<td><input type="date" value="'+(p.start||'')+'" onchange="pU('+i+',\'start\',this.value)"'+dis+'></td>';
    h+='<td><input type="date" value="'+(p.end||'')+'" onchange="pU('+i+',\'end\',this.value)"'+dis+'></td>';
    h+='<td class="r"><input type="number" value="'+p.mW+'" min="3" max="6" style="width:45px" onchange="pU('+i+',\'mW\',+this.value)"'+dis+'></td>';
    h+='<td class="r"><input type="number" value="'+(p.penPct*100).toFixed(0)+'" step="1" min="0" style="width:50px" onchange="pU('+i+',\'penPct\',+this.value/100)"'+dis+'>%</td>';
    h+='<td class="r" style="color:var(--pu);font-weight:600;font-family:\'Geist Mono\',monospace;font-size:11px">'+coPct+'%</td>';
    h+='<td><input type="date" value="'+(p.cutoff||'')+'" onchange="pU('+i+',\'cutoff\',this.value)" title="Payroll cutoff for extra OT"'+dis+'></td>';
    h+='<td><input type="date" value="'+(p.payDate||'')+'" onchange="pU('+i+',\'payDate\',this.value)" title="Pay date"'+dis+'></td>';
    h+='<td style="text-align:center">'+(ec>0?'<span style="background:var(--blg);color:#fff;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700">'+ec+'</span>':'<span style="color:var(--tx3);font-size:11px">\u2013</span>')+'</td>';
    if(hasProf){
      var curProf=p.profileId||'';
      h+='<td><select style="padding:3px 4px;background:var(--s3);border:1px solid var(--bd);border-radius:4px;color:'+(curProf?'var(--bl2)':'var(--tx3)')+';font-size:10px;font-family:inherit;max-width:80px" onchange="pU('+i+',\'profileId\',this.value)"'+dis+'>';
      h+='<option value="">Default</option>';
      workProfiles.forEach(function(wp){h+='<option value="'+wp.id+'"'+(curProf===wp.id?' selected':'')+'>'+wp.name+'</option>'});
      h+='</select></td>';
    }
    h+='<td><button class="btn bp bx" onclick="oEM('+i+')"'+(perLocked?' disabled style="opacity:.4"':'')+'>'+ICO.plus+' Add</button></td></tr>';
    if(ec>0){h+='<tr><td colspan="'+(hasProf?'11':'10')+'" style="padding:6px 8px;background:var(--s2)">';
    (p.extras||[]).forEach(function(ex,j){
      h+='<div class="ei">';
      if(ex.type==='bonus'){h+='<span class="tg tg-bo">'+(ex.holidayId?'<span style="background:rgba(34,197,94,.1);color:var(--gn);padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700">HOL SUPP</span>':'BONUS')+'</span><span>'+(ex.desc||'Bonus')+'</span><span class="am">'+fmt(ex.amount||0)+'</span>'}
      else if(ex.type==='ot'){var m=gOM(ex.date);h+='<span class="tg tg-ot">OT</span><span>'+(ex.date?fd(ex.date):'')+' \u2022 '+(ex.hours||0)+'h @ '+m.toFixed(2)+'x'+(ex.desc?' \u2022 '+ex.desc:'')+'</span><span class="am">'+fmt((ex.hours||0)*hr()*m)+'</span>'}
      else if(ex.type==='bh'){h+='<span class="tg tg-bh">B/H</span><span>'+(ex.date?fd(ex.date):'')+' \u2022 '+(ex.hours||0)+'h @ '+(ex.mult||1)+'x'+(ex.desc?' \u2022 '+ex.desc:'')+'</span><span class="am">'+fmt((ex.hours||0)*hr()*(ex.mult||1))+'</span>'}
      else if(ex.type==='expense'){var eSign=ex.expType==='deduction'?'-':'+';var eCol=ex.expType==='deduction'?'var(--rd)':'var(--gn)';h+='<span class="tg" style="background:rgba(167,139,250,.1);color:var(--pu)">EXP</span><span>'+(ex.desc||'Expense')+(ex.preTax?' (pre-tax)':'')+'</span><span class="am" style="color:'+eCol+'">'+eSign+fmt(ex.amount||0)+'</span>'}
      else if(ex.type==='mileage'){h+='<span class="tg" style="background:rgba(34,197,94,.1);color:var(--gn)">MILES</span><span>'+(ex.miles||0)+' miles @ '+P+(ex.mileRate||0.45).toFixed(2)+(ex.desc?' \u2022 '+ex.desc:'')+'</span><span class="am" style="color:var(--gn)">+'+fmt(ex.amount||0)+'</span>'}
      if(ex.recurId)h+='<span style="color:var(--bl2);font-size:9px;font-weight:700" title="Recurring">\u21BB</span>';
      h+='<button class="db" onclick="eE('+i+','+j+')" title="Edit" style="'+(perLocked?'opacity:.4;pointer-events:none':'')+'">'+ICO.edit+'</button><button class="db" onclick="rE('+i+','+j+')" title="Remove"'+(perLocked?' style="opacity:.4;pointer-events:none"':'')+'>'+ICO.x+'</button></div>'});
    h+='</td></tr>'}
  });
  h+='</tbody></table></div></div>';
  h+='<div class="ib w" style="margin-top:0"><strong>Payroll Cutoff:</strong> Extra OT after cutoff rolls to next month. <strong>Bank Holidays:</strong> BH pay replaces normal pay (no shift allowance). For night shifts crossing midnight into a BH, set hours to the BH-day portion only (e.g. 6h for midnight\u20136am).</div>';
  document.getElementById('c-per').innerHTML=h;yBt('yp');
}
function pU(i,k,v){
  years[aYr].periods[i][k]=v;
  if(k==='penPct'&&i>0){
    if(confirm('Apply '+Math.round(v*100)+'% pension sacrifice to all months?')){
      years[aYr].periods.forEach(function(p){p.penPct=v});
      save();rPer();return;
    }
  }
  save();
}
function tgLock(){perLocked=!perLocked;rPer()}
function expCSV(){
  var data=cAll(),pm=data.length>1?data.slice(1):data;
  var rows=[['Month','Weeks','Hours Worked','Base Salary','Sal Offset','Pension (Employee)','Pension (Company)','OT 1.33','OT 1.5','OT 2.0','Extra OT','Bank Holiday','Shift Allowance','Bonus','Gross Pay','Tax','NI','Take Home']];
  pm.forEach(function(d){rows.push([d.m,d.mW,d.hW.toFixed(2),d.bS.toFixed(2),d.sOff.toFixed(2),d.pG.toFixed(2),(d.cP||0).toFixed(2),d.o13g.toFixed(2),d.o15g.toFixed(2),d.o2g.toFixed(2),(d.otX||0).toFixed(2),(d.bHg||0).toFixed(2),d.sA.toFixed(2),(d.bon||0).toFixed(2),d.gP.toFixed(2),d.tx.toFixed(2),d.ni.toFixed(2),d.tH.toFixed(2)])});
  var csv=rows.map(function(r){return r.join(',')}).join('\n');
  var blob=new Blob([csv],{type:'text/csv'});var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='salary-'+aYr.replace('/','-')+'.csv';a.click();URL.revokeObjectURL(url);
}

// ═══ EXTRA MODAL ═══
function oEM(i){
  eMI=i;eEI=-1;var p=years[aYr].periods[i];
  document.getElementById('eMT').textContent='Add Payment \u2013 '+p.m;
  document.getElementById('eMSB').textContent='Add Payment';
  document.getElementById('eMSB').setAttribute('onclick','sEP()');
  var h='<div class="fg"><label class="fl">Payment Type</label><select class="sf" id="eT" onchange="uEF()"><option value="bonus">Bonus (Lump Sum)</option><option value="ot">Extra Overtime</option><option value="bh">Bank Holiday</option><option value="expense">Expense / Deduction</option><option value="mileage">Mileage Claim</option></select></div><div id="eF"></div>';
  document.getElementById('eMB').innerHTML=h;document.getElementById('eM').classList.add('o');uEF();
}
function eE(pi,ei){
  eMI=pi;eEI=ei;var p=years[aYr].periods[pi],ex=p.extras[ei];
  document.getElementById('eMT').textContent='Edit Payment \u2013 '+p.m;
  document.getElementById('eMSB').textContent='Save Changes';
  document.getElementById('eMSB').setAttribute('onclick','sEP()');
  var h='<div class="fg"><label class="fl">Payment Type</label><select class="sf" id="eT" onchange="uEF()"><option value="bonus"'+(ex.type==='bonus'?' selected':'')+'>Bonus (Lump Sum)</option><option value="ot"'+(ex.type==='ot'?' selected':'')+'>Extra Overtime</option><option value="bh"'+(ex.type==='bh'?' selected':'')+'>Bank Holiday</option><option value="expense"'+(ex.type==='expense'?' selected':'')+'>Expense / Deduction</option><option value="mileage"'+(ex.type==='mileage'?' selected':'')+'>Mileage Claim</option></select></div><div id="eF"></div>';
  document.getElementById('eMB').innerHTML=h;document.getElementById('eM').classList.add('o');uEF();
  setTimeout(function(){
    if(ex.type==='bonus'){
      if(document.getElementById('eA'))document.getElementById('eA').value=ex.amount||'';
      if(document.getElementById('eD'))document.getElementById('eD').value=ex.desc||'';
    } else if(ex.type==='ot'){
      if(document.getElementById('eDt'))document.getElementById('eDt').value=ex.date||'';
      if(document.getElementById('eH'))document.getElementById('eH').value=ex.hours||'';
      if(document.getElementById('eD'))document.getElementById('eD').value=ex.desc||'';
    } else if(ex.type==='bh'){
      if(document.getElementById('eDt'))document.getElementById('eDt').value=ex.date||'';
      if(document.getElementById('eH'))document.getElementById('eH').value=ex.hours||'';
      if(document.getElementById('eML'))document.getElementById('eML').value=ex.mult||1;
      if(document.getElementById('eD'))document.getElementById('eD').value=ex.desc||'';
    } else if(ex.type==='expense'){
      if(document.getElementById('eD'))document.getElementById('eD').value=ex.desc||'';
      if(document.getElementById('eExpType'))document.getElementById('eExpType').value=ex.expType||'deduction';
      if(document.getElementById('eExpTax'))document.getElementById('eExpTax').checked=!!ex.preTax;
      if(ex.expCalc&&ex.expCalc!=='fixed'){
        if(document.getElementById('eExpCalc')){document.getElementById('eExpCalc').value=ex.expCalc;uExpCalc()}
        if(document.getElementById('eExpPct'))document.getElementById('eExpPct').value=ex.expPct||'';
        setTimeout(uExpCalc,20);
      } else {
        if(document.getElementById('eA'))document.getElementById('eA').value=ex.amount||'';
      }
    } else if(ex.type==='mileage'){
      if(document.getElementById('eMiles'))document.getElementById('eMiles').value=ex.miles||'';
      if(document.getElementById('eMileRate'))document.getElementById('eMileRate').value=ex.mileRate||0.45;
      if(document.getElementById('eD'))document.getElementById('eD').value=ex.desc||'';
    }
  },10);
}
function uEF(){
  var t=document.getElementById('eT').value,h='';
  if(t==='bonus'){
    h+='<div class="fg"><label class="fl">Amount</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="eA" step=".01" placeholder="0.00"></div></div>';
    h+='<div class="fg"><label class="fl">Description (optional)</label><div class="iw"><input type="text" class="fi" id="eD" placeholder="e.g. Annual bonus"></div></div>';
  } else if(t==='ot'){
    h+='<div class="fg"><label class="fl">Date of Overtime</label><div class="iw"><input type="date" class="fi" id="eDt" onchange="uOTRate()"></div></div>';
    // Show OT rates from rules
    var dayNames2=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    h+='<div id="eOTRateInfo" style="padding:8px 10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);font-size:11px;margin-bottom:10px">';
    h+='<div style="font-weight:600;margin-bottom:4px;color:var(--tx2)">OT Rates (from Settings)</div>';
    (cfg.otRules||[]).forEach(function(rule){
      if(rule.rate&&rule.rate>0){
        var dayStr=(rule.days||[]).map(function(d){return dayNames2[d]}).join(', ');
        h+='<div style="color:var(--tx3)"><span style="color:var(--bl2);font-weight:600">'+rule.rate+'x</span> \u2014 '+dayStr+(rule.label?' ('+rule.label+')':'')+'</div>';
      }
    });
    h+='<div id="eOTSelectedRate" style="margin-top:6px;color:var(--gn);font-weight:700;display:none"></div></div>';
    h+='<div class="fg"><label class="fl">Hours</label><div class="iw"><input type="number" class="fi" id="eH" step=".25" placeholder="0"><span class="is">hrs</span></div></div>';
    h+='<div class="fg"><label class="fl">Description (optional)</label><div class="iw"><input type="text" class="fi" id="eD" placeholder="e.g. Cover shift"></div></div>';
  } else if(t==='bh'){
    h+='<div class="fg"><label class="fl">Bank Holiday Date</label><div class="iw"><input type="date" class="fi" id="eDt"></div></div>';
    h+='<div class="fg"><label class="fl">Hours at BH Rate</label><div class="iw"><input type="number" class="fi" id="eH" value="11.5" step=".5"><span class="is">hrs</span></div><div class="fh">Night shift crossing midnight? Enter only the hours on the BH day (e.g. 6h for 12am\u20136am)</div></div>';
    h+='<div class="fg"><label class="fl">BH Multiplier</label><select class="sf" id="eML"><option value="1">1x (standard pay \u2013 no enhancement)</option><option value="1.5">1.5x (time and a half)</option><option value="2" selected>2x (double pay)</option><option value="2.5">2.5x</option><option value="3">3x (triple pay)</option></select>';
    h+='<div class="fh">2x = double your normal pay. The multiplier is applied to base hourly rate'+(cfg.bhIncludeSA?' + shift allowance':'')+'.</div></div>';
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="eBHSA" '+(cfg.bhIncludeSA?'checked':'')+' style="accent-color:var(--bl);width:16px;height:16px"> Include shift allowance in BH rate</label>';
    h+='<div class="fh">If ticked, BH pay = hours \u00D7 (base rate + shift allowance) \u00D7 multiplier. If unticked, BH pay = hours \u00D7 base rate \u00D7 multiplier.</div></div>';
    h+='<div class="fg"><label class="fl">Description (optional)</label><div class="iw"><input type="text" class="fi" id="eD" placeholder="e.g. Christmas Day"></div></div>';
    h+='<div class="ib">BH pay replaces normal pay for those hours. No additional shift allowance on BH hours (unless included above).</div>';
  } else if(t==='expense'){
    h+='<div class="fg"><label class="fl">Type</label><select class="sf" id="eExpType"><option value="reimbursement">Reimbursement (added to pay)</option><option value="deduction">Deduction (removed from pay)</option><option value="allowance">Allowance (added to pay)</option></select></div>';
    h+='<div class="fg"><label class="fl">Calculate as</label><select class="sf" id="eExpCalc" onchange="uExpCalc()"><option value="fixed">Fixed amount</option><option value="pctBase">% of base salary</option><option value="pctTotal">% of total (base + shift allowance)</option></select></div>';
    h+='<div id="eExpPctRow" style="display:none"><div class="fg"><label class="fl">Percentage</label><div class="iw"><input type="number" class="fi" id="eExpPct" step=".01" placeholder="0" oninput="uExpCalc()"><span class="is">%</span></div></div>';
    h+='<div id="eExpPctPreview" style="padding:8px 10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);font-size:11px;font-family:\'Geist Mono\',monospace;color:var(--bl2);margin-bottom:10px"></div></div>';
    h+='<div id="eExpFixedRow"><div class="fg"><label class="fl">Amount</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="eA" step=".01" placeholder="0.00"></div></div></div>';
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="eExpTax" style="accent-color:var(--bl);width:16px;height:16px"> Pre-tax (salary sacrifice / before tax)</label>';
    h+='<div class="fh">Tick for pre-tax items like salary sacrifice. Untick for post-tax expenses like uniform deductions.</div></div>';
    h+='<div class="fg"><label class="fl">Description</label><div class="iw"><input type="text" class="fi" id="eD" placeholder="e.g. Uniform deduction, Tool allowance, On-call payment"></div></div>';
  } else if(t==='mileage'){
    h+='<div class="fg"><label class="fl">Miles</label><div class="iw"><input type="number" class="fi" id="eMiles" step="1" placeholder="0" oninput="uMileCalc()"><span class="is">miles</span></div></div>';
    h+='<div class="fg"><label class="fl">Rate per Mile</label><select class="sf" id="eMileRate" onchange="uMileCalc()"><option value="0.45">45p/mile (HMRC first 10,000)</option><option value="0.25">25p/mile (HMRC over 10,000)</option><option value="0.20">20p/mile (bicycle)</option><option value="custom">Custom rate...</option></select></div>';
    h+='<div id="eMileCustom" style="display:none;margin-top:6px"><div class="fg"><label class="fl">Custom Rate</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="eMileCustomRate" step=".01" value="0.45" oninput="uMileCalc()"><span class="is">/mile</span></div></div></div>';
    h+='<div id="eMilePreview" style="margin-top:8px;padding:10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);font-size:12px;font-family:\'Geist Mono\',monospace;color:var(--gn);display:none"></div>';
    h+='<div class="fg"><label class="fl">Description</label><div class="iw"><input type="text" class="fi" id="eD" placeholder="e.g. Site visit, Client meeting"></div></div>';
    h+='<div class="ib">HMRC approved mileage rate: 45p for first 10,000 miles, 25p thereafter. Tax-free if employer reimburses at or below HMRC rate.</div>';
  }
  // Add recurring option (not for editing existing, not for types needing specific dates)
  if(eEI===-1){
    h+='<div class="fg" style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bd)"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="eRec" style="accent-color:var(--bl);width:16px;height:16px"> Apply to all remaining months</label>';
    h+='<div class="fh">Adds this payment to every period from the selected month onwards.</div></div>';
  }
  document.getElementById('eF').innerHTML=h;
}
function uMileCalc(){
  var sel=document.getElementById('eMileRate');var custom=document.getElementById('eMileCustom');
  if(sel&&custom)custom.style.display=sel.value==='custom'?'':'none';
  var miles=+(document.getElementById('eMiles')||{}).value||0;
  var rate=sel&&sel.value==='custom'?+(document.getElementById('eMileCustomRate')||{}).value||0:+(sel||{}).value||0.45;
  var total=miles*rate;
  var prev=document.getElementById('eMilePreview');
  if(prev){if(miles>0){prev.style.display='';prev.innerHTML=miles+' miles \u00D7 '+P+rate.toFixed(2)+' = <strong>'+fmt(total)+'</strong>'}else{prev.style.display='none'}}
}
function uOTRate(){
  var dtEl=document.getElementById('eDt');
  var infoEl=document.getElementById('eOTSelectedRate');
  if(!dtEl||!dtEl.value||!infoEl)return;
  var m=gOM(dtEl.value);
  var dayNames2=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var p=dtEl.value.split('-'),d=new Date(+p[0],+p[1]-1,+p[2]);
  infoEl.style.display='';
  infoEl.innerHTML='Selected: '+dayNames2[d.getDay()]+' \u2192 <span style="font-size:13px">'+m.toFixed(2)+'x</span> (= '+fmt((+(document.getElementById('eH')||{}).value||1)*hr()*m)+' per hour)';
}
function uExpCalc(){
  var calc=(document.getElementById('eExpCalc')||{}).value||'fixed';
  var pctRow=document.getElementById('eExpPctRow');
  var fixRow=document.getElementById('eExpFixedRow');
  if(pctRow)pctRow.style.display=calc==='fixed'?'none':'';
  if(fixRow)fixRow.style.display=calc==='fixed'?'':'none';
  if(calc!=='fixed'){
    var pct=+(document.getElementById('eExpPct')||{}).value||0;
    var monthly=cfg.sal/12;
    var base=monthly;
    if(calc==='pctTotal'){
      // Add shift allowance estimate
      var data=cAll();var pm=data.length>1?data.slice(1):data;
      var avgSA=pm.reduce(function(s,d){return s+d.sA},0)/pm.length;
      base=monthly+avgSA;
    }
    var amount=base*pct/100;
    var prev=document.getElementById('eExpPctPreview');
    if(prev)prev.innerHTML=pct+'% of '+fmt(base)+(calc==='pctTotal'?' (base+shift avg)':' (base)')+' = <strong>'+fmt(amount)+'</strong>/mo';
  }
}
function sEP(){
  var t=document.getElementById('eT').value,per=years[aYr].periods,i=eMI;
  if(!per[i].extras)per[i].extras=[];var ex={type:t};
  if(t==='bonus'){ex.amount=+(document.getElementById('eA').value)||0;ex.desc=(document.getElementById('eD')||{}).value||'';if(ex.amount<=0){alert('Enter amount');return}}
  else if(t==='ot'){ex.date=(document.getElementById('eDt')||{}).value||'';ex.hours=+(document.getElementById('eH').value)||0;ex.desc=(document.getElementById('eD')||{}).value||'';if(!ex.date){alert('Enter date');return}if(ex.hours<=0){alert('Enter hours');return}}
  else if(t==='bh'){ex.date=(document.getElementById('eDt')||{}).value||'';ex.hours=+(document.getElementById('eH').value)||0;ex.mult=+(document.getElementById('eML').value)||1;ex.desc=(document.getElementById('eD')||{}).value||'';if(!ex.date){alert('Enter date');return}if(ex.hours<=0){alert('Enter hours');return}
    // Save SA preference to config
    var bhSAEl=document.getElementById('eBHSA');if(bhSAEl){cfg.bhIncludeSA=bhSAEl.checked;save()}
  }
  else if(t==='expense'){
    var expCalc=(document.getElementById('eExpCalc')||{}).value||'fixed';
    ex.desc=(document.getElementById('eD')||{}).value||'';
    ex.expType=(document.getElementById('eExpType')||{}).value||'deduction';
    ex.preTax=document.getElementById('eExpTax')?document.getElementById('eExpTax').checked:false;
    if(expCalc==='fixed'){
      ex.amount=+(document.getElementById('eA').value)||0;
    } else {
      var expPct=+(document.getElementById('eExpPct')||{}).value||0;
      var monthly=cfg.sal/12;
      var base=monthly;
      if(expCalc==='pctTotal'){
        var data2=cAll();var pm2=data2.length>1?data2.slice(1):data2;
        var avgSA2=pm2.reduce(function(s,d){return s+d.sA},0)/pm2.length;
        base=monthly+avgSA2;
      }
      ex.amount=Math.round(base*expPct/100*100)/100;
      ex.expCalc=expCalc;
      ex.expPct=expPct;
    }
    if(ex.amount<=0){alert('Enter amount or percentage');return}
  }
  else if(t==='mileage'){
    ex.miles=+(document.getElementById('eMiles').value)||0;
    var sel=document.getElementById('eMileRate');
    ex.mileRate=sel&&sel.value==='custom'?+(document.getElementById('eMileCustomRate')||{}).value||0.45:+(sel||{}).value||0.45;
    ex.amount=ex.miles*ex.mileRate;
    ex.desc=(document.getElementById('eD')||{}).value||'Mileage';
    if(ex.miles<=0){alert('Enter miles');return}
  }
  var co=per[i].cutoff,eDate=ex.date||'';
  var isRec=eEI===-1&&document.getElementById('eRec')&&document.getElementById('eRec').checked;
  if(eEI===-1){
    if(co&&eDate&&eDate>co&&i<per.length-1){if(confirm('Payment date ('+fd(eDate)+') is after cutoff ('+fd(co)+').\nAdd to '+per[i+1].m+' instead?')){i++;if(!per[i].extras)per[i].extras=[]}}
    if(isRec){
      var rId='rec_'+Date.now();
      var count=0;
      for(var ri=i;ri<per.length;ri++){
        if(!per[ri].extras)per[ri].extras=[];
        var copy=JSON.parse(JSON.stringify(ex));
        copy.recurId=rId;
        // Clear date-specific fields for recurring copies (not the first one)
        if(ri>i){copy.date=''}
        per[ri].extras.push(copy);
        count++;
      }
      alert('Added to '+count+' months ('+per[i].m+' onwards).\nThese are tagged as recurring \u21BB and can be removed together.');
    } else {
      per[i].extras.push(ex);
    }
  } else {
    per[i].extras[eEI]=ex;
  }
  save();cEM();rTab(aTab);
}
function rE(pi,ei){
  var ex=years[aYr].periods[pi].extras[ei];
  if(ex&&ex.recurId){
    var choice=confirm('This is a recurring payment (\u21BB).\n\nOK = Delete from ALL months\nCancel = Delete this month only');
    if(choice){
      var rid=ex.recurId;
      years[aYr].periods.forEach(function(p){if(p.extras)p.extras=p.extras.filter(function(e){return e.recurId!==rid})});
      save();rTab(aTab);return;
    }
  } else {
    if(!confirm('Delete this payment?'))return;
  }
  years[aYr].periods[pi].extras.splice(ei,1);save();rTab(aTab);
}
function cEM(){document.getElementById('eM').classList.remove('o')}

// ═══ BREAKDOWN ═══
function rBD(){
  var data=cAll(),pm=data.length>1?data.slice(1):data,sy=parseInt(aYr.split('/')[0]);
  var h='<div class="yb" id="ybb"></div><div class="cd cd-gn"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent-gn">'+ICO.pound+'</span> Monthly Breakdown: Apr '+sy+' \u2013 Mar '+(sy+1)+'</span><button class="btn bg bs" onclick="expCSV()" title="Export to CSV">'+ICO.dl+' Export CSV</button></h3>';
  h+='<div class="tw"><table class="dt"><thead><tr><th class="fr"></th><th class="fr" style="left:30px">Month</th><th class="r">Base</th><th class="r">Sal.Off</th><th class="r">Pension</th>';
  h+='<th class="r">OT 1.33</th><th class="r">OT 1.5</th><th class="r">OT 2</th><th class="r">Extra OT</th><th class="r">B/H</th>';
  h+='<th class="r">Shift All.</th><th class="r">Bonus</th><th class="r" style="font-weight:800">Gross</th>';
  h+='<th class="r" style="color:var(--rd)">Tax</th><th class="r" style="color:var(--rd)">NI</th>';
  h+='<th class="r" style="color:var(--bl);font-weight:800">Take Home</th></tr></thead><tbody>';
  pm.forEach(function(d,i){
    var c=isN(d.m,sy)?'cu':'',id='dt'+i;
    h+='<tr class="'+c+'" style="cursor:pointer" onclick="tD(\''+id+'\')">';
    h+='<td class="fr"><span id="eb-'+id+'" style="font-size:11px;color:var(--tx3)">&#9654;</span></td>';
    h+='<td class="fr" style="font-weight:700;left:30px">'+(c?'\u25B8 ':'')+d.m+'</td>';
    h+='<td class="r">'+fmt(d.bS)+'</td>';
    h+='<td class="r" style="color:'+(d.sOff>=0?'var(--gn)':'var(--rd)')+'">'+fmt(d.sOff)+'</td>';
    h+='<td class="r" style="color:var(--pu)">('+fmt(d.pG)+')</td>';
    h+='<td class="r">'+(d.o13g?fmt(d.o13g):'\u2013')+'</td><td class="r">'+(d.o15g?fmt(d.o15g):'\u2013')+'</td><td class="r">'+(d.o2g?fmt(d.o2g):'\u2013')+'</td>';
    h+='<td class="r">'+(d.otX?fmt(d.otX):'\u2013')+'</td>';
    h+='<td class="r">'+(d.bHg?fmt(d.bHg):'\u2013')+'</td>';
    h+='<td class="r" style="color:var(--or)">'+fmt(d.sA)+'</td>';
    h+='<td class="r">'+(d.bon?fmt(d.bon):'\u2013')+'</td>';
    h+='<td class="r" style="font-weight:800">'+fmt(d.gP)+'</td>';
    h+='<td class="r" style="color:var(--rd)">'+fmt(d.tx)+'</td>';
    h+='<td class="r" style="color:var(--rd)">'+fmt(d.ni)+'</td>';
    h+='<td class="r" style="font-weight:800;color:var(--bl2)">'+fmt(d.tH)+'</td></tr>';
    h+='<tr class="xr" id="'+id+'"><td colspan="16"><div style="padding:8px"><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:500px">';
    h+='<div class="dg"><span class="dl">Hours worked:</span><span class="dv">'+d.hW.toFixed(2)+'h</span>';
    h+='<span class="dl">Month hours ('+cfg.shw+'h\u00D7'+d.mW+'wk):</span><span class="dv">'+d.mH+'h</span>';
    h+='<span class="dl">Offset:</span><span class="dv" style="color:'+(d.off>=0?'var(--gn)':'var(--rd)')+'">'+(d.off>=0?'+':'')+d.off.toFixed(2)+'h</span>';
    h+='<span class="dl">B/H hours:</span><span class="dv">'+(d.bH||0)+'h</span>';
    h+='<span class="dl">Shift hours:</span><span class="dv">'+d.sHr.toFixed(2)+'h</span></div>';
    h+='<div class="dg"><span class="dl">OT 1.33:</span><span class="dv">'+d.o13h.toFixed(2)+'h = '+fmt(d.o13g)+'</span>';
    h+='<span class="dl">OT 1.5:</span><span class="dv">'+d.o15h.toFixed(2)+'h = '+fmt(d.o15g)+'</span>';
    h+='<span class="dl">OT 2.0:</span><span class="dv">'+d.o2h.toFixed(2)+'h = '+fmt(d.o2g)+'</span>';
    h+='<span class="dl">Pension ('+(d.pP*100).toFixed(0)+'% SS):</span><span class="dv" style="color:var(--pu)">'+fmt(d.pG)+'</span>';
    h+='<span class="dl">Company ('+d.cPct+'%):</span><span class="dv" style="color:var(--pu)">'+fmt(d.cP)+'</span></div></div></div></td></tr>'});
  var tt={bS:0,sOff:0,pG:0,o13g:0,o15g:0,o2g:0,bHg:0,sA:0,bon:0,otX:0,gP:0,tx:0,ni:0,tH:0};
  pm.forEach(function(d){for(var k in tt)tt[k]+=(d[k]||0)});
  h+='</tbody><tfoot><tr><td class="fr" colspan="2" style="font-weight:800;left:0">TOTALS</td>';
  h+='<td class="r">'+fmt(tt.bS)+'</td><td class="r">'+fmt(tt.sOff)+'</td><td class="r" style="color:var(--pu)">('+fmt(tt.pG)+')</td>';
  h+='<td class="r">'+fmt(tt.o13g)+'</td><td class="r">'+fmt(tt.o15g)+'</td><td class="r">'+fmt(tt.o2g)+'</td>';
  h+='<td class="r">'+(tt.otX?fmt(tt.otX):'\u2013')+'</td><td class="r">'+fmt(tt.bHg)+'</td>';
  h+='<td class="r" style="color:var(--or)">'+fmt(tt.sA)+'</td><td class="r">'+fmt(tt.bon)+'</td>';
  h+='<td class="r" style="font-weight:800">'+fmt(tt.gP)+'</td><td class="r" style="color:var(--rd)">'+fmt(tt.tx)+'</td>';
  h+='<td class="r" style="color:var(--rd)">'+fmt(tt.ni)+'</td><td class="r" style="font-weight:800;color:var(--bl2);font-size:13px">'+fmt(tt.tH)+'</td></tr></tfoot></table></div></div>';
  document.getElementById('c-bd').innerHTML=h;yBt('ybb');
}
function tD(id){var r=document.getElementById(id),b=document.getElementById('eb-'+id);if(r){r.classList.toggle('sh');b.innerHTML=r.classList.contains('sh')?'&#9660;':'&#9654;'}}

// ═══ ANNUAL ═══
function rAnn(){
  var data=cAll(),pm=data.length>1?data.slice(1):data,sy=parseInt(aYr.split('/')[0]);
  var t={gP:0,tx:0,ni:0,pG:0,sA:0,holSup:0,bHg:0,ot:0,tH:0,bon:0,cP:0,otX:0,sl:0,sacT:0};
  pm.forEach(function(d){t.gP+=d.gP;t.tx+=d.tx;t.ni+=d.ni;t.pG+=d.pG;t.sA+=d.sA;t.holSup+=(d.holSup||0);t.bHg+=d.bHg;t.ot+=d.o13g+d.o15g+d.o2g;t.tH+=d.tH;t.bon+=d.bon;t.cP+=(d.cP||0);t.otX+=(d.otX||0);t.sl+=(d.sl||0);t.sacT+=(d.sacT||0)});
  var tP=t.pG+t.cP,eff=t.gP>0?(t.tx+t.ni)/t.gP*100:0,ded=t.gP>0?(t.tx+t.ni+t.pG)/t.gP*100:0;
  var h='<div class="yb" id="ya"></div>';
  // Earnings + Pension + Tax side by side
  h+='<div class="l2">';
  // Earnings card
  h+='<div class="cd cd-or"><h3><span class="ic-accent-or">'+ICO.clip+'</span> Earnings Breakdown</h3><div class="sg2" style="font-size:13px">';
  h+='<span class="sl">Base salary:</span><span class="sv">'+fmt(cfg.sal)+'</span>';
  if(cfg.salaryChanges&&cfg.salaryChanges.length>0){var scMo=['','April','May','June','July','August','September','October','November','December','January','February','March'];cfg.salaryChanges.forEach(function(sc){if(sc.sal>0)h+='<span class="sl">New salary (from '+scMo[sc.month||0]+'):</span><span class="sv" style="color:var(--bl2)">'+fmt(sc.sal)+'</span>'})}else if(cfg.midYearEnabled&&cfg.midYearSal>0){h+='<span class="sl">New salary (from '+['','April','May','June','July','August','September','October','November','December','January','February','March'][cfg.midYearMonth||0]+'):</span><span class="sv" style="color:var(--bl2)">'+fmt(cfg.midYearSal)+'</span>'}
  h+='<span class="sl">Compulsory OT:</span><span class="sv">'+fmt(t.ot)+'</span>';
  h+='<span class="sl">Extra OT:</span><span class="sv">'+(t.otX?fmt(t.otX):'\u2013')+'</span>';
  h+='<span class="sl">Shift allowance:</span><span class="sv" style="color:var(--or)">'+fmt(t.sA)+'</span>';
  if(t.holSup>0)h+='<span class="sl">Holiday supplement:</span><span class="sv" style="color:var(--gn)">'+fmt(t.holSup)+'</span>';
  h+='<span class="sl">Bank holiday:</span><span class="sv">'+fmt(t.bHg)+'</span>';
  h+='<span class="sl">Bonus:</span><span class="sv">'+(t.bon?fmt(t.bon):'\u2013')+'</span>';
  h+='<span class="sl" style="font-weight:700;padding-top:8px;border-top:1px solid var(--bd)">Annual gross:</span>';
  h+='<span class="sv" style="font-weight:800;font-size:15px;color:var(--gn);padding-top:8px;border-top:1px solid var(--bd)">'+fmt(t.gP)+'</span></div></div>';
  // Pension card
  h+='<div class="cd cd-pu"><h3><span class="ic-accent-pu">'+ICO.bank+'</span> Total Pension</h3><div class="sg2" style="font-size:13px">';
  h+='<span class="sl">Your sacrifice:</span><span class="sv" style="color:var(--pu)">'+fmt(t.pG)+'</span>';
  h+='<span class="sl">Company contribution:</span><span class="sv" style="color:var(--pu)">'+fmt(t.cP)+'</span>';
  h+='<span class="sl" style="font-weight:700;padding-top:8px;border-top:1px solid var(--bd)">Total pension:</span>';
  h+='<span class="sv" style="font-weight:800;font-size:15px;color:var(--pu);padding-top:8px;border-top:1px solid var(--bd)">'+fmt(tP)+'</span>';
  h+='<span class="sl">Monthly:</span><span class="sv">'+fmt(tP/12)+'</span></div></div></div>';
  // Tax analysis
  h+='<div class="cd cd-rd"><h3><span class="ic-accent-rd">'+ICO.bldg+'</span> Tax &amp; Deductions</h3>';
  h+='<div class="sg" style="margin-bottom:0">';
  h+='<div class="st"><div class="st-l">Income Tax</div><div class="st-v" style="font-size:16px;color:var(--rd)">'+fmt(t.tx)+'</div><div class="st-s">'+fmt(t.tx/12)+'/mo</div></div>';
  h+='<div class="st"><div class="st-l">National Insurance</div><div class="st-v" style="font-size:16px;color:var(--rd)">'+fmt(t.ni)+'</div><div class="st-s">'+fmt(t.ni/12)+'/mo</div></div>';
  if(t.sl>0)h+='<div class="st"><div class="st-l">Student Loan</div><div class="st-v" style="font-size:16px;color:var(--or)">'+fmt(t.sl)+'</div><div class="st-s">'+fmt(t.sl/12)+'/mo</div></div>';
  if(t.sacT>0)h+='<div class="st"><div class="st-l">Sal. Sacrifice</div><div class="st-v" style="font-size:16px;color:var(--pu)">'+fmt(t.sacT)+'</div><div class="st-s">'+(cfg.sacrifices||[]).map(function(s){return s.name}).join(', ')+'</div></div>';
  h+='<div class="st"><div class="st-l">Eff. Tax Rate</div><div class="st-v" style="font-size:16px;color:var(--yw)">'+eff.toFixed(1)+'%</div><div class="st-s">Tax+NI'+(t.sl>0?'+SL':'')+' on gross</div></div>';
  h+='<div class="st"><div class="st-l">Total Deductions</div><div class="st-v" style="font-size:16px;color:var(--yw)">'+ded.toFixed(1)+'%</div><div class="st-s">Inc. pension sacrifice</div></div></div></div>';
  // Chart
  h+='<div class="cd cd-gn"><h3>'+ic('chart')+' Monthly Take Home</h3>';
  h+=mkChart(pm,sy);
  h+='</div>';
  document.getElementById('c-ann').innerHTML=h;yBt('ya');
}

// ═══ ACCOUNTS ═══
var accts=[];
function ldAccts(){try{var s=localStorage.getItem('st7-accts');if(s)accts=JSON.parse(s)}catch(e){}if(!accts||!accts.length)accts=[]}
function svAccts(){try{localStorage.setItem('st7-accts',JSON.stringify(accts))}catch(e){}}
ldAccts();

// ═══ WORK PROFILES ═══
var workProfiles=[];
function ldProfiles(){try{var s=localStorage.getItem('st7-profiles');if(s)workProfiles=JSON.parse(s)}catch(e){}if(!workProfiles||!Array.isArray(workProfiles))workProfiles=[]}
function svProfiles(){try{localStorage.setItem('st7-profiles',JSON.stringify(workProfiles))}catch(e){}}
ldProfiles();
function getProfile(id){for(var i=0;i<workProfiles.length;i++){if(workProfiles[i].id===id)return workProfiles[i]}return null}
function saveAsProfile(name){
  var id='wp-'+Date.now();
  var prof={
    id:id,name:name,
    sp:JSON.parse(JSON.stringify(cfg.sp)),
    shiftTypes:JSON.parse(JSON.stringify(cfg.shiftTypes||[])),
    otRules:JSON.parse(JSON.stringify(cfg.otRules||[])),
    unpaidBreak:cfg.unpaidBreak!==undefined?cfg.unpaidBreak:0.5,
    saPct:cfg.saPct||0,
    payBasis:cfg.payBasis||'salaried',
    payMode:cfg.payMode||'arrears',
    patternStart:cfg.patternStart||'',
    shw:cfg.shw||39,
    profile:cfg.profile||'shift-rotating'
  };
  workProfiles.push(prof);svProfiles();return prof;
}
function loadProfile(id){
  var p=getProfile(id);if(!p)return;
  if(!confirm('Load profile "'+p.name+'"?\n\nThis will replace your current shift pattern, OT rules, shift types, and allowances for '+aYr+'.\n\nYour salary, tax code, and pension settings will not change.'))return;
  cfg.sp=JSON.parse(JSON.stringify(p.sp));
  cfg.shiftTypes=JSON.parse(JSON.stringify(p.shiftTypes||[]));
  cfg.otRules=JSON.parse(JSON.stringify(p.otRules||[]));
  cfg.unpaidBreak=p.unpaidBreak!==undefined?p.unpaidBreak:0.5;
  if(p.saPct!==undefined)cfg.saPct=p.saPct;
  if(p.payBasis)cfg.payBasis=p.payBasis;
  if(p.payMode)cfg.payMode=p.payMode;
  if(p.patternStart)cfg.patternStart=p.patternStart;
  if(p.shw)cfg.shw=p.shw;
  if(p.profile)cfg.profile=p.profile;
  save();rAll();sw(aTab);if(document.getElementById('sDw').classList.contains('o'))rS();
}
function deleteProfile(id){
  var p=getProfile(id);if(!p)return;
  if(!confirm('Delete profile "'+p.name+'"?\n\nThis cannot be undone. Any months using this profile will revert to default settings.'))return;
  // Clear any period references to this profile
  Object.keys(years).forEach(function(yr){
    if(years[yr].periods)years[yr].periods.forEach(function(per){if(per.profileId===id)per.profileId=''});
    if(years[yr].cfg&&years[yr].cfg.midYearProfile===id){years[yr].cfg.midYearProfile='';years[yr].cfg.midYearProfileEnabled=false}
  });
  workProfiles=workProfiles.filter(function(p){return p.id!==id});svProfiles();save();
}
function updateProfile(id){
  var p=getProfile(id);if(!p)return;
  if(!confirm('Update profile "'+p.name+'" with your current settings?\n\nThis will overwrite the saved pattern, OT rules, shift types, and allowances.'))return;
  p.sp=JSON.parse(JSON.stringify(cfg.sp));
  p.shiftTypes=JSON.parse(JSON.stringify(cfg.shiftTypes||[]));
  p.otRules=JSON.parse(JSON.stringify(cfg.otRules||[]));
  p.unpaidBreak=cfg.unpaidBreak!==undefined?cfg.unpaidBreak:0.5;
  p.saPct=cfg.saPct||0;
  p.payBasis=cfg.payBasis||'salaried';
  p.payMode=cfg.payMode||'arrears';
  p.patternStart=cfg.patternStart||'';
  p.shw=cfg.shw||39;
  p.profile=cfg.profile||'shift-rotating';
  svProfiles();rS();
}
function renameProfile(id){
  var p=getProfile(id);if(!p)return;
  var name=prompt('Rename profile:',p.name);
  if(!name||!name.trim())return;
  p.name=name.trim();svProfiles();rS();
}
function openEditProfile(id){
  var p=getProfile(id);if(!p)return;
  var m=document.getElementById('eM');
  document.getElementById('eMT').textContent='Edit Profile \u2013 '+p.name;
  document.getElementById('eMSB').textContent='Save Changes';
  var h='<div class="fg"><label class="fl">Profile Name</label><div class="iw"><input type="text" class="fi" id="epName" value="'+p.name+'"></div></div>';
  h+='<div class="fg"><label class="fl">Contracted Hours/Week</label><div class="iw"><input type="number" class="fi" id="epShw" value="'+(p.shw||39)+'" step="1"><span class="is">hrs</span></div></div>';
  h+='<div class="fg"><label class="fl">Unpaid Break per Shift</label><div class="iw"><input type="number" class="fi" id="epBreak" value="'+(p.unpaidBreak!==undefined?p.unpaidBreak:0.5)+'" step=".25"><span class="is">hrs</span></div></div>';
  // Shift types
  h+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)"><label class="fl" style="margin-bottom:8px">Shift Types</label>';
  (p.shiftTypes||[]).forEach(function(st,i){
    if(st.id==='off')return;
    h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
    h+='<span style="font-weight:700;font-size:11px;min-width:50px">'+st.label+'</span>';
    h+='<div class="iw" style="width:70px"><input type="number" class="fi epTH" data-idx="'+i+'" value="'+(st.totalHours||12)+'" step=".25" style="text-align:center"><span class="is">h</span></div>';
    h+='<div class="iw" style="width:70px"><input type="number" class="fi epSA" data-idx="'+i+'" value="'+(st.allowancePct||0)+'" step=".01" style="text-align:center"><span class="is">%</span></div>';
    h+='</div>';
  });
  h+='</div>';
  // OT Rules
  h+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)"><label class="fl" style="margin-bottom:8px">OT Rules</label>';
  var dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  (p.otRules||[]).forEach(function(rule,i){
    var dayStr=(rule.days||[]).map(function(d){return dayNames[d]}).join(',');
    h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
    h+='<span style="font-size:10px;min-width:70px;color:var(--tx2)">'+(rule.label||dayStr)+'</span>';
    h+='<div class="iw" style="width:70px"><input type="number" class="fi epOTH" data-idx="'+i+'" value="'+(rule.hours||0)+'" step=".25" style="text-align:center"><span class="is">h</span></div>';
    h+='<div class="iw" style="width:70px"><input type="number" class="fi epOTR" data-idx="'+i+'" value="'+(rule.rate||1)+'" step=".01" style="text-align:center"><span class="is">x</span></div>';
    h+='</div>';
  });
  h+='</div>';
  // Pattern preview
  var patStr=p.sp.map(function(s){return s.t==='off'?'Off':s.t.charAt(0).toUpperCase()}).join(' ');
  h+='<div style="margin-top:12px;padding:8px;background:var(--s2);border-radius:var(--rs);font-size:10px;font-family:\'Geist Mono\',monospace;color:var(--tx2)">Pattern: '+patStr+' ('+p.sp.length+'-day cycle)</div>';
  h+='<div class="fh" style="margin-top:6px">To change the shift pattern itself, load this profile first, edit the pattern in Settings, then update the profile.</div>';
  document.getElementById('eMB').innerHTML=h;
  document.getElementById('eMSB').setAttribute('onclick','saveEditProfile(\''+id+'\')');
  m.classList.add('o');
}
function saveEditProfile(id){
  var p=getProfile(id);if(!p)return;
  p.name=(document.getElementById('epName')||{}).value||p.name;
  p.shw=+(document.getElementById('epShw')||{}).value||p.shw;
  p.unpaidBreak=+(document.getElementById('epBreak')||{}).value;
  document.querySelectorAll('.epTH').forEach(function(el){var idx=+el.dataset.idx;if(p.shiftTypes[idx])p.shiftTypes[idx].totalHours=+el.value||12});
  document.querySelectorAll('.epSA').forEach(function(el){var idx=+el.dataset.idx;if(p.shiftTypes[idx])p.shiftTypes[idx].allowancePct=+el.value||0});
  document.querySelectorAll('.epOTH').forEach(function(el){var idx=+el.dataset.idx;if(p.otRules[idx])p.otRules[idx].hours=+el.value||0});
  document.querySelectorAll('.epOTR').forEach(function(el){var idx=+el.dataset.idx;if(p.otRules[idx])p.otRules[idx].rate=+el.value||1});
  svProfiles();cEM();rS();
}
function promptSaveProfile(){
  var name=prompt('Save current work settings as a profile.\n\nProfile name:','');
  if(!name||!name.trim())return;
  saveAsProfile(name.trim());
  if(document.getElementById('sDw').classList.contains('o'))rS();
  alert('Profile "'+name.trim()+'" saved!');
}
// Get effective config for a period — checks for profile override
function getCfgForPeriod(pIdx){
  var per=years[aYr].periods[pIdx];
  // Check per-period profile override first
  if(per&&per.profileId){var p=getProfile(per.profileId);if(p)return mergeProfileIntoCfg(p)}
  // Check mid-year profile switch
  if(cfg.midYearProfile&&cfg.midYearProfileMonth&&typeof pIdx==='number'&&pIdx>=cfg.midYearProfileMonth){
    var p2=getProfile(cfg.midYearProfile);if(p2)return mergeProfileIntoCfg(p2);
  }
  return cfg;
}
function mergeProfileIntoCfg(prof){
  // Return a merged config: year's cfg for salary/tax/pension, profile for pattern/OT/SA
  var merged=JSON.parse(JSON.stringify(cfg));
  merged.sp=JSON.parse(JSON.stringify(prof.sp));
  merged.shiftTypes=JSON.parse(JSON.stringify(prof.shiftTypes||[]));
  merged.otRules=JSON.parse(JSON.stringify(prof.otRules||[]));
  merged.unpaidBreak=prof.unpaidBreak!==undefined?prof.unpaidBreak:merged.unpaidBreak;
  if(prof.patternStart)merged.patternStart=prof.patternStart;
  if(prof.shw)merged.shw=prof.shw;
  return merged;
}

var acEditIdx=-1,txEditAcct=-1,txEditIdx=-1;
var accFY=1;
var acColors=['var(--bl)','var(--gn)','var(--pu)','var(--or)','var(--rd)','var(--yw)'];
var acTypes=['Current','Savings','ISA','S&S ISA','Credit Card','Mortgage','Loan','Other'];

function getAvgTH(){var data=cAll(),pm=data.length>1?data.slice(1):data;var s=0;pm.forEach(function(d){s+=d.tH});return pm.length?s/pm.length:0}
function getMonthTH(){var data=cAll(),pm=data.length>1?data.slice(1):data;var r={};var sy=parseInt(aYr.split('/')[0]);pm.forEach(function(d,i){r[i]=d.tH});return{months:r,avg:getAvgTH()}}
// Get current month's actual take-home if data exists, otherwise average
function getSalTH(){var data=cAll(),pm=data.length>1?data.slice(1):data;var sy=parseInt(aYr.split('/')[0]);for(var i=0;i<pm.length;i++){if(isN(pm[i].m,sy)&&pm[i].gP>0)return pm[i].tH}return getAvgTH()}
function isSalActual(){var data=cAll(),pm=data.length>1?data.slice(1):data;var sy=parseInt(aYr.split('/')[0]);for(var i=0;i<pm.length;i++){if(isN(pm[i].m,sy)&&pm[i].gP>0)return true}return false}

var accViewMonth=0; // 0 = current month, 1 = next month, etc.

// Get salary take-home for a specific calendar month/year, independent of dashboard year tab
function getSalForMonth(calYear,calMonth){
  // Find which tax year this month falls in
  // Tax years run Apr-Mar. Apr 2025 = 2025/26, Mar 2026 = 2025/26
  var taxYrStart=calMonth>=4?calYear:calYear-1;
  var taxYrKey=taxYrStart+'/'+(String(taxYrStart+1).slice(2));
  if(!years[taxYrKey])return getAvgTH();
  var yrData=years[taxYrKey];
  var savedCfg=cfg,savedTax=tax;
  cfg=yrData.cfg;tax=yrData.tax;
  var moNames=['','January','February','March','April','May','June','July','August','September','October','November','December'];
  var targetName=moNames[calMonth];
  var periods=yrData.periods||[];
  // Find matching period by checking pay date or month name
  var best=0,bestIdx=-1;
  for(var pi=0;pi<periods.length;pi++){
    var p=periods[pi];
    if(p.payDate){
      var pp=p.payDate.split('-');
      var pY=+pp[0],pM=+pp[1];
      if(pY===calYear&&pM===calMonth){bestIdx=pi;break}
    }
    if(p.m===targetName&&bestIdx===-1)bestIdx=pi;
  }
  var result=0;
  if(bestIdx>=0){
    var calc=cM(periods[bestIdx],bestIdx);
    result=calc.tH;
  }
  cfg=savedCfg;tax=savedTax;
  if(result<=0)result=getAvgTH();
  return result;
}

// Get spending expenses for a specific account in a given month
function getSpendForAcct(acctIdx,calYear,calMonth){
  var ym=calYear+'-'+String(calMonth).padStart(2,'0');
  var sm=spending[ym];
  if(!sm||!sm.items)return 0;
  var total=0;
  sm.items.forEach(function(it){
    if(it.linkedAcct===acctIdx)total+=it.amount||0;
  });
  return total;
}

// Get recurring expense total for a specific account
function getRecurForAcct(acctIdx){
  var total=0;
  recurDefs.forEach(function(rd){
    if(rd.linkedAcct===acctIdx)total+=rd.amount||0;
  });
  return total;
}

// Calculate all flows for a specific account in a specific month offset
function getAcctMonthFlows(acctIdx,monthOffset){
  var a=accts[acctIdx];
  var now=new Date();
  var calMonth=now.getMonth()+1+monthOffset;
  var calYear=now.getFullYear();
  while(calMonth>12){calMonth-=12;calYear++}
  while(calMonth<1){calMonth+=12;calYear--}

  var flows={salary:0,txnsIn:0,txnsOut:0,transfersIn:0,transfersOut:0,spendingOut:0,interest:0};

  // Salary income
  if(a.linkedSalary){
    if(a.salaryOverrides&&a.salaryOverrides[monthOffset]!==undefined){
      flows.salary=a.salaryOverrides[monthOffset];
    } else {
      flows.salary=getSalForMonth(calYear,calMonth);
    }
  }

  // Account transactions
  (a.txns||[]).forEach(function(t){
    if(t.amount>0)flows.txnsIn+=t.amount;
    else{
      if(t.toAcct!==undefined&&t.toAcct>=0){
        flows.transfersOut+=Math.abs(t.amount);
      } else {
        flows.txnsOut+=Math.abs(t.amount);
      }
    }
  });

  // Incoming transfers from other accounts
  accts.forEach(function(a2,i2){
    if(i2===acctIdx)return;
    (a2.txns||[]).forEach(function(t2){
      if(t2.toAcct===acctIdx&&t2.amount<0){
        flows.transfersIn+=Math.abs(t2.amount);
      }
    });
  });

  // Spending expenses linked to this account
  flows.spendingOut=getSpendForAcct(acctIdx,calYear,calMonth);
  // If no specific spending data for future months, use recurring expense totals
  if(monthOffset>0&&flows.spendingOut===0){
    flows.spendingOut=getRecurForAcct(acctIdx);
  }

  // Monthly interest
  flows.interest=0; // Applied to balance in projection

  return flows;
}

// Calculate projected balance for an account at a given month offset
function getAcctBalance(acctIdx,monthOffset){
  var a=accts[acctIdx];
  var bal=a.balance||0;
  var rate=(a.rate||0)/100/12;
  for(var m=0;m<monthOffset;m++){
    var flows=getAcctMonthFlows(acctIdx,m);
    var monthNet=flows.salary+flows.txnsIn+flows.transfersIn-flows.txnsOut-flows.transfersOut-flows.spendingOut;
    bal=bal*(1+rate)+monthNet;
  }
  return bal;
}

function getAccMonthLabel(offset){
  var now=new Date();
  var calMonth=now.getMonth()+1+offset;
  var calYear=now.getFullYear();
  while(calMonth>12){calMonth-=12;calYear++}
  while(calMonth<1){calMonth+=12;calYear--}
  var moNames=['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return moNames[calMonth]+' '+calYear;
}

function accNavM(d){accViewMonth+=d;if(accViewMonth<0)accViewMonth=0;rAcc()}
function accGoNow(){accViewMonth=0;rAcc()}

function rAcc(){
  var h='<div class="cd cd-bl"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent">'+ICO.bank+'</span> Accounts</span><button class="btn bp bs" onclick="oAcM()">'+ICO.plus+' Account</button></h3>';
  if(!accts.length){h+='<p style="color:var(--tx3);font-size:12px">No accounts yet. Add your current account, savings, ISA, etc. to track balances and forecast growth.</p>'}
  else{
    // Month navigator
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:10px 14px">';
    h+='<button class="btn bg bs" onclick="accNavM(-1)"'+(accViewMonth===0?' disabled style="opacity:.3"':'')+'>&laquo; Prev</button>';
    h+='<div style="text-align:center"><span style="font-weight:700;font-size:14px">'+getAccMonthLabel(accViewMonth)+'</span>';
    if(accViewMonth===0)h+='<div style="font-size:9px;color:var(--bl2);font-weight:600">CURRENT</div>';
    else h+='<div style="font-size:9px;color:var(--tx3)">+'+accViewMonth+' month'+(accViewMonth>1?'s':'')+(accViewMonth>0?' <a href="javascript:accGoNow()" style="color:var(--bl2);text-decoration:underline;font-size:9px">Back to now</a>':'')+'</div>';
    h+='</div>';
    h+='<button class="btn bg bs" onclick="accNavM(1)">Next &raquo;</button></div>';

    var totalBal=0,totalIn=0,totalOut=0;
    accts.forEach(function(a,i){
      var openBal=getAcctBalance(i,accViewMonth);
      var flows=getAcctMonthFlows(i,accViewMonth);
      var rate=(a.rate||0)/100/12;
      var interest=openBal*rate;
      var monthIn=flows.salary+flows.txnsIn+flows.transfersIn;
      var monthOut=flows.txnsOut+flows.transfersOut+flows.spendingOut;
      var closeBal=openBal*(1+rate)+monthIn-monthOut;
      totalBal+=closeBal;totalIn+=monthIn;totalOut+=monthOut;

      h+='<div style="background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;margin-bottom:10px;border-left:3px solid '+(a.color||'var(--bl)')+'">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-weight:700;font-size:13px">'+a.name+'</span> <span style="font-size:10px;color:var(--tx3);background:var(--glass2);padding:2px 8px;border-radius:10px">'+a.type+'</span>';
      if(a.linkedSalary)h+=' <span style="font-size:9px;color:var(--bl2);background:rgba(99,102,241,.1);padding:2px 6px;border-radius:10px;font-weight:700">SALARY</span>';
      h+='</div>';
      h+='<div style="display:flex;gap:4px"><button class="btn bg bx" onclick="oTxM('+i+')">'+ICO.plus+'</button><button class="btn bg bx" onclick="oAcM('+i+')">'+ICO.edit+'</button><button class="btn bdn bx" onclick="delAcct('+i+')">'+ICO.x+'</button></div></div>';

      // Balance display - show projected closing balance
      h+='<div style="font-size:22px;font-weight:800;font-family:\'Geist Mono\',monospace;color:'+(closeBal>=0?'var(--gn)':'var(--rd)')+'">'+fmt(closeBal)+'</div>';
      if(accViewMonth===0)h+='<div style="font-size:9px;color:var(--tx3);margin-top:2px">Stored balance: '+fmt(a.balance||0)+'</div>';

      // Monthly flows breakdown
      h+='<div style="margin-top:8px;padding:10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs)">';
      h+='<div style="display:grid;grid-template-columns:1fr auto;gap:3px 10px;font-size:11px">';
      h+='<span style="color:var(--tx3)">Opening balance:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;text-align:right">'+fmt(openBal)+'</span>';
      if(a.linkedSalary){var isOvr=a.salaryOverrides&&a.salaryOverrides[accViewMonth]!==undefined;h+='<span style="color:var(--bl2);cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px" onclick="ovrSalAcc('+i+','+accViewMonth+')">'+ic('pound')+' Salary'+(isOvr?' <span style="font-size:8px;color:var(--or)">\u270E</span>':'')+':</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:'+(isOvr?'var(--or)':'var(--gn)')+';text-align:right;cursor:pointer" onclick="ovrSalAcc('+i+','+accViewMonth+')">+'+fmt(flows.salary)+'</span>';}
      if(flows.txnsIn>0)h+='<span style="color:var(--gn)">Income:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--gn);text-align:right">+'+fmt(flows.txnsIn)+'</span>';
      if(flows.transfersIn>0)h+='<span style="color:var(--gn)">Transfers in:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--gn);text-align:right">+'+fmt(flows.transfersIn)+'</span>';
      if(flows.txnsOut>0)h+='<span style="color:var(--rd)">Payments out:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--rd);text-align:right">-'+fmt(flows.txnsOut)+'</span>';
      if(flows.transfersOut>0)h+='<span style="color:var(--rd)">Transfers out:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--rd);text-align:right">-'+fmt(flows.transfersOut)+'</span>';
      if(flows.spendingOut>0)h+='<span style="color:var(--or)">'+ic('clip')+' Spending:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--rd);text-align:right">-'+fmt(flows.spendingOut)+'</span>';
      if(interest!==0&&a.rate>0)h+='<span style="color:var(--pu)">Interest ('+a.rate+'%):</span><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--pu);text-align:right">+'+fmt(interest)+'</span>';
      var net=monthIn-monthOut+interest;
      h+='<span style="font-weight:700;padding-top:4px;border-top:1px solid var(--bd)">Net this month:</span><span style="font-family:\'Geist Mono\',monospace;font-weight:700;color:'+(net>=0?'var(--gn)':'var(--rd)')+';text-align:right;padding-top:4px;border-top:1px solid var(--bd)">'+(net>=0?'+':'')+fmt(net)+'</span>';
      h+='</div></div>';

      // Show transactions list
      if(a.txns&&a.txns.length){
        h+='<div style="margin-top:10px;border-top:1px solid var(--bd);padding-top:8px">';
        (a.txns||[]).forEach(function(t,j){
          h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px">';
          h+='<span style="color:var(--tx2)">'+t.desc;
          if(t.toAcct!==undefined&&t.toAcct>=0&&accts[t.toAcct])h+=' <span style="color:var(--tx3);font-size:9px">\u2192 '+accts[t.toAcct].name+'</span>';
          if(t.recurring)h+=' <span style="color:var(--bl2);font-size:8px">\u21BB</span>';
          h+='</span>';
          h+='<span style="display:flex;align-items:center;gap:6px"><span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:'+(t.amount>=0?'var(--gn)':'var(--rd)')+'">'+(t.amount>=0?'+':'')+fmt(t.amount)+'/mo</span>';
          h+='<button class="db" onclick="oTxM('+i+','+j+')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">'+ICO.edit+'</button>';
          h+='<button class="db" onclick="delAcctTxn('+i+','+j+')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">'+ICO.x+'</button></span></div>';
        });
        h+='</div>';
      }
      // Show incoming transfers from other accounts
      var hasIncoming=false;
      accts.forEach(function(a2,i2){
        if(i2===i)return;
        (a2.txns||[]).forEach(function(t2){
          if(t2.toAcct===i&&t2.amount<0){
            if(!hasIncoming){hasIncoming=true;h+='<div style="margin-top:'+(a.txns&&a.txns.length?'4':'10')+'px;padding-top:4px">';}
            h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px">';
            h+='<span style="color:var(--tx2)">'+t2.desc+' <span style="color:var(--tx3);font-size:9px">\u2190 '+a2.name+'</span> <span style="color:var(--gn);font-size:8px">AUTO</span></span>';
            h+='<span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--gn)">+'+fmt(Math.abs(t2.amount))+'/mo</span></div>';
          }
        });
      });
      if(hasIncoming)h+='</div>';

      // Show linked spending expenses
      var spendAmt=flows.spendingOut;
      if(spendAmt>0){
        h+='<div style="margin-top:4px;padding-top:4px">';
        h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px">';
        h+='<span style="color:var(--or)">'+ic('clip')+' Linked spending expenses <span style="color:var(--tx3);font-size:9px">from Spending tab</span></span>';
        h+='<span style="font-family:\'Geist Mono\',monospace;font-weight:600;color:var(--rd)">-'+fmt(spendAmt)+'/mo</span></div></div>';
      }

      h+='</div>';
    });

    // Totals bar
    var totalNet=totalIn-totalOut;
    h+='<div style="background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;margin-top:14px">';
    h+='<div style="font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:6px">'+getAccMonthLabel(accViewMonth)+' \u2022 Total Net Worth</div>';
    h+='<div style="font-size:24px;font-weight:800;font-family:\'Geist Mono\',monospace;color:'+(totalBal>=0?'var(--gn)':'var(--rd)')+'">'+fmt(totalBal)+'</div>';
    h+='<div style="display:flex;gap:12px;margin-top:6px;font-size:11px;font-family:\'Geist Mono\',monospace">';
    h+='<span style="color:var(--gn)">+'+fmt(totalIn)+'/mo in</span>';
    h+='<span style="color:var(--rd)">-'+fmt(totalOut)+'/mo out</span>';
    h+='<span style="color:'+(totalNet>=0?'var(--gn)':'var(--rd)')+'">Net: '+(totalNet>=0?'+':'')+fmt(totalNet)+'/mo</span></div></div>';
  }
  h+='</div>';
  if(accts.length){
    h+='<div class="cd cd-gn"><h3><span class="ic-accent-gn">'+ICO.chart+'</span> Account Forecast</h3>';
    h+='<div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">';
    [1,2,5,10].forEach(function(y){h+='<button class="btn '+(accFY===y?'bp':'bg')+' bs" onclick="accFY='+y+';rAcc()">'+y+' Year'+(y>1?'s':'')+'</button>'});
    h+='</div>';
    h+=accForecast(accFY);
    h+='</div>';
  }
  document.getElementById('c-acc').innerHTML=h;
}

function accForecast(yrs){
  var months=yrs*12,h='';
  var snapPoints=[];
  if(yrs===1){for(var m=0;m<=12;m+=3)snapPoints.push(m)}
  else if(yrs===2){for(var m=0;m<=24;m+=6)snapPoints.push(m)}
  else{for(var m=0;m<=months;m+=12)snapPoints.push(m)}
  if(snapPoints[snapPoints.length-1]!==months)snapPoints.push(months);

  h+='<div class="tw"><table class="dt"><thead><tr><th>Time</th>';
  accts.forEach(function(a){h+='<th class="r" style="color:'+(a.color||'var(--bl)')+'">'+a.name+'</th>'});
  h+='<th class="r" style="font-weight:800">Total</th></tr></thead><tbody>';

  var mx=0,rowData=[];
  
  snapPoints.forEach(function(m){
    var totBal=0;var row={m:m,bals:[]};
    accts.forEach(function(a,aIdx){
      var b=getAcctBalance(aIdx,m);
      row.bals.push(b);totBal+=b;
    });
    row.total=totBal;rowData.push(row);
    if(Math.abs(totBal)>mx)mx=Math.abs(totBal);
  });
  if(mx===0)mx=1;

  rowData.forEach(function(r){
    var yy=Math.floor(r.m/12),mm=r.m%12;
    var label=r.m===0?'Now':yy>0?(mm>0?yy+'yr '+mm+'mo':yy+(yy===1?' year':' years')):mm+(mm===1?' month':' months');
    h+='<tr><td style="font-weight:600">'+label+'</td>';
    r.bals.forEach(function(b){h+='<td class="r" style="color:'+(b>=0?'var(--gn)':'var(--rd)')+'">'+fs(b)+'</td>'});
    h+='<td class="r" style="font-weight:700;color:'+(r.total>=0?'var(--gn)':'var(--rd)')+'">'+fs(r.total)+'</td></tr>';
  });
  h+='</tbody></table></div>';

  var finalR=rowData[rowData.length-1],firstR=rowData[0],growth=finalR.total-firstR.total;
  h+='<div class="sg" style="margin-top:14px">';
  h+='<div class="st" style="border-left:3px solid var(--gn)"><div class="st-l">Projected in '+yrs+'yr</div><div class="st-v" style="font-size:16px;color:var(--gn)">'+fs(finalR.total)+'</div></div>';
  h+='<div class="st" style="border-left:3px solid '+(growth>=0?'var(--bl)':'var(--rd)')+'"><div class="st-l">Change</div><div class="st-v" style="font-size:16px;color:'+(growth>=0?'var(--bl2)':'var(--rd)')+'">'+(growth>=0?'+':'')+fs(growth)+'</div></div></div>';
  return h;
}

function oAcM(idx){
  acEditIdx=idx===undefined?-1:idx;
  var isEdit=acEditIdx>=0;
  var a=isEdit?accts[acEditIdx]:{name:'',type:'Current',balance:0,rate:0,linkedSalary:false};
  document.getElementById('acMT').textContent=isEdit?'Edit Account':'Add Account';
  document.getElementById('acMSB').textContent=isEdit?'Save Changes':'Add Account';
  var h='';
  h+='<div class="fg"><label class="fl">Account Name</label><div class="iw"><input type="text" class="fi" id="acName" value="'+a.name+'" placeholder="e.g. Main Current, Help to Buy ISA"></div></div>';
  h+='<div class="fg"><label class="fl">Account Type</label><select class="sf" id="acType">';
  acTypes.forEach(function(t){h+='<option value="'+t+'"'+(a.type===t?' selected':'')+'>'+t+'</option>'});
  h+='</select></div>';
  h+='<div class="g2">';
  h+='<div class="fg"><label class="fl">Current Balance</label><div style="display:flex;gap:6px;align-items:stretch"><button type="button" class="btn" id="acBalSign" onclick="tgAcSign()" style="min-width:48px;font-size:16px;font-weight:800;border:1.5px solid var(--bd);border-radius:var(--rs);padding:8px 12px;flex-shrink:0"></button><div class="iw" style="flex:1"><span class="ip">'+P+'</span><input type="number" class="fi" id="acBal" value="'+Math.abs(a.balance)+'" step=".01" min="0" inputmode="decimal"></div></div><div class="fh">Tap +/\u2013 for positive/negative balance (use negative for debt)</div></div>';
  h+='<input type="hidden" id="acBalSignVal" value="'+((a.balance||0)>=0?'1':'-1')+'">';
  h+='<div class="fg"><label class="fl">Annual Interest Rate</label><div class="iw"><input type="number" class="fi" id="acRate" value="'+(a.rate||0)+'" step=".1"><span class="is">%</span></div></div>';
  h+='</div>';
  h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="acSal" '+(a.linkedSalary?'checked':'')+' style="accent-color:var(--bl);width:16px;height:16px"> Link to salary take-home pay</label>';
  h+='<div class="fh">Uses actual calculated take-home per month when data exists, average ('+fmt(getAvgTH())+'/mo) otherwise. Override per-month in the forecast if your payslip differs.</div></div>';
  document.getElementById('acMB').innerHTML=h;
  document.getElementById('acM').classList.add('o');
  setTimeout(function(){uAcSignBtn();document.getElementById('acName').focus()},100);
}
function tgAcSign(){var sv=document.getElementById('acBalSignVal');sv.value=sv.value==='-1'?'1':'-1';uAcSignBtn()}
function uAcSignBtn(){var sv=document.getElementById('acBalSignVal');var btn=document.getElementById('acBalSign');if(!btn||!sv)return;var isPos=sv.value!=='-1';btn.textContent=isPos?'+':'\u2013';btn.style.background=isPos?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)';btn.style.color=isPos?'var(--gn)':'var(--rd)';btn.style.borderColor=isPos?'rgba(34,197,94,.3)':'rgba(239,68,68,.3)'}
function cAcM(){document.getElementById('acM').classList.remove('o');acEditIdx=-1}
function sAcct(){
  var name=document.getElementById('acName').value.trim();
  if(!name){alert('Enter account name');return}
  var type=document.getElementById('acType').value;
  var bal=Math.abs(+(document.getElementById('acBal').value)||0);
  var balSign=document.getElementById('acBalSignVal').value==='-1'?-1:1;
  bal=bal*balSign;
  var rate=+(document.getElementById('acRate').value)||0;
  var sal=document.getElementById('acSal').checked;
  if(acEditIdx>=0){
    accts[acEditIdx].name=name;accts[acEditIdx].type=type;
    accts[acEditIdx].balance=bal;accts[acEditIdx].rate=rate;accts[acEditIdx].linkedSalary=sal;
  } else {
    accts.push({name:name,type:type,balance:bal,rate:rate,linkedSalary:sal,color:acColors[accts.length%acColors.length],txns:[]});
  }
  svAccts();cAcM();rAcc();
}
function delAcct(i){if(!confirm('Delete '+accts[i].name+'?'))return;accts.splice(i,1);svAccts();rAcc()}

function oTxM(acIdx,txIdx){
  txEditAcct=acIdx;txEditIdx=txIdx===undefined?-1:txIdx;
  var isEdit=txEditIdx>=0;
  var t=isEdit?accts[acIdx].txns[txIdx]:{desc:'',amount:0,recurring:true,toAcct:-1};
  document.getElementById('txMT').textContent=(isEdit?'Edit':'Add')+' Transaction \u2013 '+accts[acIdx].name;
  document.getElementById('txMSB').textContent=isEdit?'Save Changes':'Add Transaction';
  var h='';
  h+='<div class="fg"><label class="fl">Description</label><div class="iw"><input type="text" class="fi" id="txDesc" value="'+(t.desc||'')+'" placeholder="e.g. Salary, Rent, Netflix, Fuel"></div></div>';
  h+='<div class="fg"><label class="fl">Monthly Amount</label><div style="display:flex;gap:6px;align-items:stretch"><button type="button" class="btn" id="txSign" onclick="tgTxSign()" style="min-width:48px;font-size:16px;font-weight:800;border:1.5px solid var(--bd);border-radius:var(--rs);padding:8px 12px;flex-shrink:0"></button><div class="iw" style="flex:1"><span class="ip">'+P+'</span><input type="number" class="fi" id="txAmt" value="'+Math.abs(t.amount||0)+'" step=".01" min="0" placeholder="0.00" inputmode="decimal"></div></div>';
  h+='<div class="fh">Tap +/\u2013 to toggle income/expense. Green = money in, Red = money out.</div></div>';
  h+='<input type="hidden" id="txSignVal" value="'+((t.amount||0)>=0?'1':'-1')+'">';
  h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="txRec" '+(t.recurring!==false?'checked':'')+' style="accent-color:var(--bl);width:16px;height:16px"> Recurring monthly</label></div>';
  // Transfer to another account
  h+='<div class="fg"><label class="fl">Transfer to Account (optional)</label><select class="sf" id="txTo">';
  h+='<option value="-1">None \u2013 external payment</option>';
  accts.forEach(function(a,i){if(i!==acIdx)h+='<option value="'+i+'"'+((t.toAcct===i)?' selected':'')+'>'+a.name+'</option>'});
  h+='</select><div class="fh">Links outgoing from this account as incoming to another</div></div>';
  document.getElementById('txMB').innerHTML=h;
  document.getElementById('txM').classList.add('o');
  setTimeout(function(){
    uTxSignBtn();
    document.getElementById('txAmt').focus();
  },100);
}
function tgTxSign(){var sv=document.getElementById('txSignVal');sv.value=sv.value==='-1'?'1':'-1';uTxSignBtn()}
function uTxSignBtn(){var sv=document.getElementById('txSignVal');var btn=document.getElementById('txSign');if(!btn||!sv)return;var isPos=sv.value!=='-1';btn.textContent=isPos?'+':'\u2013';btn.style.background=isPos?'rgba(34,197,94,.12)':'rgba(239,68,68,.12)';btn.style.color=isPos?'var(--gn)':'var(--rd)';btn.style.borderColor=isPos?'rgba(34,197,94,.3)':'rgba(239,68,68,.3)'}
function cTxM(){document.getElementById('txM').classList.remove('o');txEditAcct=-1;txEditIdx=-1}
function sTxn(){
  var desc=document.getElementById('txDesc').value.trim();
  if(!desc){alert('Enter description');return}
  var absAmt=Math.abs(+(document.getElementById('txAmt').value));
  if(absAmt===0){alert('Enter an amount');return}
  var sign=document.getElementById('txSignVal').value==='-1'?-1:1;
  var amt=absAmt*sign;
  var rec=document.getElementById('txRec').checked;
  var toAcct=+(document.getElementById('txTo').value);
  if(!accts[txEditAcct].txns)accts[txEditAcct].txns=[];
  var txn={desc:desc,amount:amt,recurring:rec};
  if(toAcct>=0)txn.toAcct=toAcct;
  if(txEditIdx>=0){
    accts[txEditAcct].txns[txEditIdx]=txn;
  } else {
    accts[txEditAcct].txns.push(txn);
  }
  svAccts();cTxM();rAcc();
}
function delAcctTxn(i,j){if(!confirm('Delete this transaction?'))return;accts[i].txns.splice(j,1);svAccts();rAcc()}
function ovrSal(mIdx){
  var thData=getMonthTH();var cur=thData.months[mIdx]||0;
  var salMonths=['April','May','June','July','August','September','October','November','December','January','February','March'];
  // Check existing override
  var existing=null;accts.forEach(function(a){if(a.linkedSalary&&a.salaryOverrides&&a.salaryOverrides[mIdx]!==undefined)existing=a.salaryOverrides[mIdx]});
  var msg=salMonths[mIdx]+'\nActual calculated: '+fmt(cur)+'\n\n';
  if(existing!==null)msg+='Current override: '+fmt(existing)+'\n\n';
  msg+='Enter new take-home amount (or leave blank to '+(existing!==null?'remove override':'keep as-is')+'):';
  var val=prompt(msg,existing!==null?existing:'');
  if(val===null)return;
  accts.forEach(function(a){
    if(a.linkedSalary){
      if(!a.salaryOverrides)a.salaryOverrides={};
      if(val===''){delete a.salaryOverrides[mIdx];if(Object.keys(a.salaryOverrides).length===0)delete a.salaryOverrides}
      else{a.salaryOverrides[mIdx]=+val||0}
    }
  });
  svAccts();rAcc();
}
function clearSalOvr(){if(!confirm('Clear all salary overrides?'))return;accts.forEach(function(a){if(a.linkedSalary)delete a.salaryOverrides});svAccts();rAcc()}
function ovrSalAcc(acctIdx,monthOffset){
  var a=accts[acctIdx];
  var now=new Date();
  var calMonth=now.getMonth()+1+monthOffset;
  var calYear=now.getFullYear();
  while(calMonth>12){calMonth-=12;calYear++}
  while(calMonth<1){calMonth+=12;calYear--}
  var moNames=['','January','February','March','April','May','June','July','August','September','October','November','December'];
  var calcVal=getSalForMonth(calYear,calMonth);
  var existing=null;
  if(a.salaryOverrides&&a.salaryOverrides[monthOffset]!==undefined)existing=a.salaryOverrides[monthOffset];
  var msg=moNames[calMonth]+' '+calYear+' \u2014 '+a.name+'\nCalculated take-home: '+fmt(calcVal)+'\n\n';
  if(existing!==null)msg+='Current override: '+fmt(existing)+'\n\n';
  msg+='Enter actual take-home amount (or leave blank to '+(existing!==null?'remove override':'use calculated value')+'):';
  var val=prompt(msg,existing!==null?existing:'');
  if(val===null)return;
  if(!a.salaryOverrides)a.salaryOverrides={};
  if(val===''){delete a.salaryOverrides[monthOffset];if(Object.keys(a.salaryOverrides).length===0)delete a.salaryOverrides}
  else{a.salaryOverrides[monthOffset]=+val||0}
  svAccts();rAcc();
}

// ═══ SPENDING TRACKER ═══
var spending={};
function ldSpend(){try{var s=localStorage.getItem('st7-spend');if(s)spending=JSON.parse(s)}catch(e){}if(!spending||typeof spending!=='object')spending={}}
function svSpend(){try{localStorage.setItem('st7-spend',JSON.stringify(spending))}catch(e){}}
ldSpend();

var spMonth=new Date().getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
var defCats=['Housing','Bills & Utilities','Transport','Groceries','Eating Out','Entertainment','Shopping','Health','Subscriptions','Other'];
var spEditIdx=-1;
var recurDefs=[];
function ldRecur(){try{var s=localStorage.getItem('st7-recur');if(s)recurDefs=JSON.parse(s)}catch(e){}if(!recurDefs||!recurDefs.length)recurDefs=[]}
function svRecur(){try{localStorage.setItem('st7-recur',JSON.stringify(recurDefs))}catch(e){}}
ldRecur();

function getSpM(ym){
  if(!spending[ym])spending[ym]={budget:{},items:[]};
  // Auto-populate recurring expenses if not already present
  var sm=spending[ym];
  recurDefs.forEach(function(rd){
    // Check if fixed-period recurring has expired
    if(rd.fixedMonths&&rd.startMonth){
      var sp=rd.startMonth.split('-'),sy=parseInt(sp[0]),smo=parseInt(sp[1]);
      var cp=ym.split('-'),cy=parseInt(cp[0]),cmo=parseInt(cp[1]);
      var diff=(cy-sy)*12+(cmo-smo);
      if(diff<0||diff>=rd.fixedMonths)return; // Outside the recurring window
    }
    var exists=(sm.items||[]).some(function(it){return it.recurId===rd.id});
    if(!exists){
      if(!sm.items)sm.items=[];
      sm.items.push({cat:rd.cat,amount:rd.amount,desc:rd.desc,date:'',recurId:rd.id,linkedAcct:rd.linkedAcct});
    }
  });
  return sm;
}

function rSpend(){
  var sm=getSpM(spMonth);
  var ym=spMonth.split('-'),yr=ym[0],mo=parseInt(ym[1]);
  var moNames=['','January','February','March','April','May','June','July','August','September','October','November','December'];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">';
  h+='<button class="btn bg bs" onclick="spNav(-1)">&laquo; Prev</button>';
  h+='<span style="font-weight:700;font-size:15px">'+moNames[mo]+' '+yr+'</span>';
  h+='<button class="btn bg bs" onclick="spNav(1)">Next &raquo;</button></div>';

  h+='<div class="cd cd-or"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent-or">'+ICO.clip+'</span> Expenses</span><button class="btn bp bs" onclick="oSpM()">'+ICO.plus+' Add</button></h3>';

  var catTotals={},total=0;
  (sm.items||[]).forEach(function(it){if(!catTotals[it.cat])catTotals[it.cat]=0;catTotals[it.cat]+=it.amount;total+=it.amount});
  var cats=Object.keys(catTotals).sort(function(a,b){return catTotals[b]-catTotals[a]});
  if(cats.length){
    var maxCat=Math.max.apply(null,cats.map(function(c){return catTotals[c]}));if(maxCat===0)maxCat=1;
    cats.forEach(function(c){
      var bgt=sm.budget[c]||0;var spent=catTotals[c];var over=bgt>0&&spent>bgt;
      h+='<div style="margin-bottom:10px">';
      h+='<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span style="font-weight:600">'+c+'</span>';
      h+='<span style="font-family:\'Geist Mono\',monospace;color:'+(over?'var(--rd)':'var(--tx)')+'">'+fmt(spent)+(bgt>0?' / '+fmt(bgt):'')+'</span></div>';
      var pct=maxCat>0?spent/maxCat*100:0;
      h+='<div style="background:var(--s3);height:6px;border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+(over?'var(--rd)':'var(--gn)')+';border-radius:3px;transition:.3s"></div></div></div>';
    });
    h+='<div style="display:flex;justify-content:space-between;padding-top:10px;border-top:1px solid var(--bd);font-size:13px;font-weight:700"><span>Total</span><span style="font-family:\'Geist Mono\',monospace;color:var(--rd)">'+fmt(total)+'</span></div>';
  } else {
    h+='<p style="color:var(--tx3);font-size:12px">No expenses this month. Tap Add to start tracking.</p>';
  }
  h+='</div>';

  // Recurring expenses section - always shown
  h+='<div class="cd cd-bl"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px">'+ic('refresh')+' Recurring Expenses</span><button class="btn bp bs" onclick="oSpM();setTimeout(function(){var c=document.getElementById(\'spRec\');if(c&&!c.checked){c.checked=true;tgRecOpts()}},50)">'+ICO.plus+' Add</button></h3>';
  if(recurDefs.length){
    h+='<div class="ib" style="margin-top:0;margin-bottom:10px">Auto-populated each month.</div>';
    var rTotal=0;
    recurDefs.forEach(function(rd,i){
      rTotal+=rd.amount;
      h+='<div class="ei"><span class="tg" style="background:rgba(245,158,11,.1);color:var(--or)">'+rd.cat+'</span>';
      h+='<span style="font-size:12px">'+rd.desc+'</span>';
      if(rd.fixedMonths){
        var sp2=rd.startMonth.split('-'),sy2=parseInt(sp2[0]),smo2=parseInt(sp2[1]);
        var cp2=spMonth.split('-'),cy2=parseInt(cp2[0]),cmo2=parseInt(cp2[1]);
        var elapsed=(cy2-sy2)*12+(cmo2-smo2);
        var remaining=Math.max(0,rd.fixedMonths-elapsed);
        var totalCost=rd.amount*rd.fixedMonths;
        h+='<span style="font-size:8px;color:var(--bl2);background:rgba(99,102,241,.1);padding:2px 6px;border-radius:10px;font-weight:700">'+remaining+'/'+rd.fixedMonths+' mo left</span>';
        h+='<span style="font-size:8px;color:var(--tx3)">'+fs(totalCost)+' total</span>';
      } else {
        h+='<span style="font-size:8px;color:var(--gn);background:rgba(34,197,94,.1);padding:2px 6px;border-radius:10px;font-weight:700">ONGOING</span>';
      }
      if(rd.linkedAcct>=0&&accts[rd.linkedAcct])h+='<span style="font-size:9px;color:var(--tx3)">\u2192 '+accts[rd.linkedAcct].name+'</span>';
      h+='<span class="am" style="color:var(--rd)">'+fmt(rd.amount)+'/mo</span>';
      h+='<button class="db" onclick="delRecur('+i+')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">'+ICO.x+'</button></div>';
    });
    h+='<div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px solid var(--bd);font-size:12px;font-weight:700;margin-top:6px"><span>Recurring total</span><span style="font-family:\'Geist Mono\',monospace;color:var(--rd)">'+fmt(rTotal)+'/mo</span></div>';
  } else {
    h+='<p style="color:var(--tx3);font-size:12px">No recurring expenses set up yet. Tap Add to create one.</p>';
  }
  h+='</div>';

  // Budget setup
  h+='<div class="cd cd-pu"><h3><span class="ic-accent-pu">'+ICO.chart+'</span> Monthly Budgets</h3>';
  h+='<div class="ib" style="margin-top:0;margin-bottom:12px">Set monthly budget limits per category. Leave 0 for no limit.</div>';
  defCats.forEach(function(c){
    var bv=sm.budget[c]||0;
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span style="font-size:11px;font-weight:600;color:var(--tx2);width:110px;flex-shrink:0">'+c+'</span>';
    h+='<div class="iw" style="flex:1"><span class="ip">'+P+'</span><input type="number" class="fi" value="'+(bv||'')+'" step="1" placeholder="0" onchange="setBudget(\''+c+'\',+this.value)"></div>';
    var sp=catTotals[c]||0;
    if(bv>0){h+='<span style="font-size:10px;font-family:\'Geist Mono\',monospace;color:'+(sp>bv?'var(--rd)':'var(--gn)')+'">'+Math.round(sp/bv*100)+'%</span>'}
    h+='</div>';
  });
  h+='</div>';

  // Expense list
  if(sm.items&&sm.items.length){
    h+='<div class="cd"><h3>'+ic('cal')+' All Expenses</h3>';
    var sorted=sm.items.slice().map(function(it,idx){return{it:it,idx:idx}}).sort(function(a,b){return(b.it.date||'').localeCompare(a.it.date||'')});
    sorted.forEach(function(obj){
      var it=obj.it,idx=obj.idx;
      h+='<div class="ei"><span class="tg" style="background:rgba(245,158,11,.1);color:var(--or)">'+it.cat+'</span>';
      h+='<span style="font-size:12px">'+(it.desc||it.cat)+'</span>';
      if(it.recurId)h+='<span style="color:var(--bl2);font-size:8px">\u21BB</span>';
      if(it.linkedAcct>=0&&accts[it.linkedAcct])h+='<span style="font-size:9px;color:var(--tx3)">\u2192 '+accts[it.linkedAcct].name+'</span>';
      if(it.date)h+='<span style="font-size:10px;color:var(--tx3)">'+fd(it.date)+'</span>';
      h+='<span class="am" style="color:var(--rd)">'+fmt(it.amount)+'</span>';
      h+='<button class="db" onclick="oSpM('+idx+')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">'+ICO.edit+'</button>';
      h+='<button class="db" onclick="delExpense('+idx+')">'+ICO.x+'</button></div>';
    });
    h+='</div>';
  }
  document.getElementById('c-spend').innerHTML=h;
}
function spNav(d){
  var p=spMonth.split('-'),yr=parseInt(p[0]),mo=parseInt(p[1]);
  mo+=d;if(mo>12){mo=1;yr++}if(mo<1){mo=12;yr--}
  spMonth=yr+'-'+String(mo).padStart(2,'0');rSpend();
}

function oSpM(idx){
  spEditIdx=idx===undefined?-1:idx;
  var isEdit=spEditIdx>=0;
  var sm=getSpM(spMonth);
  var it=isEdit?sm.items[spEditIdx]:{cat:'',amount:0,desc:'',date:'',recurId:null,linkedAcct:-1};
  document.getElementById('spMT').textContent=isEdit?'Edit Expense':'Add Expense';
  document.getElementById('spMSB').textContent=isEdit?'Save Changes':'Add Expense';
  var today=new Date();var todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
  var h='';
  h+='<div class="fg"><label class="fl">Category</label><select class="sf" id="spCat">';
  defCats.forEach(function(c){h+='<option value="'+c+'"'+(it.cat===c?' selected':'')+'>'+c+'</option>'});
  h+='</select></div>';
  h+='<div class="g2">';
  h+='<div class="fg"><label class="fl">Amount</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="spAmt" value="'+(it.amount||'')+'" step=".01" placeholder="0.00"></div></div>';
  h+='<div class="fg"><label class="fl">Date</label><div class="iw"><input type="date" class="fi" id="spDate" value="'+(it.date||todayStr)+'"></div></div>';
  h+='</div>';
  h+='<div class="fg"><label class="fl">Description</label><div class="iw"><input type="text" class="fi" id="spDesc" value="'+(it.desc||'')+'" placeholder="e.g. Weekly shop, Fuel"></div></div>';
  if(!isEdit||!it.recurId){
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="spRec" onchange="tgRecOpts()" style="accent-color:var(--bl);width:16px;height:16px"> Make this recurring monthly</label>';
    h+='<div id="spRecCalcType" style="display:none;margin-top:8px"><label class="fl">Amount Basis</label><select class="sf" id="spCalcType" onchange="uRecCalc()"><option value="fixed">Fixed amount</option><option value="pctBase">% of base salary</option><option value="pctTotal">% of total (incl. shift allowance)</option></select>';
    h+='<div id="spPctRow" style="display:none;margin-top:6px"><div class="g2"><div class="fg"><label class="fl">Percentage</label><div class="iw"><input type="number" class="fi" id="spPctVal" value="10" step=".5" min="0" max="100" oninput="uRecCalc()"><span class="is">%</span></div></div><div class="fg"><label class="fl">= Monthly</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="spPctAmt" disabled></div></div></div></div></div>';
    h+='<div id="spRecOpts" style="display:none;margin-top:8px">';
    h+='<div style="display:flex;gap:8px;margin-bottom:6px">';
    h+='<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer"><input type="radio" name="spRecType" id="spRecOngoing" value="ongoing" checked style="accent-color:var(--bl)"> Ongoing</label>';
    h+='<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer"><input type="radio" name="spRecType" id="spRecFixed" value="fixed" style="accent-color:var(--bl)" onchange="uRecPreview()"> Fixed period</label></div>';
    h+='<div id="spRecFixedOpts" style="display:none"><div class="iw" style="max-width:180px"><input type="number" class="fi" id="spRecMonths" value="12" min="1" max="120" step="1" onchange="uRecPreview()" oninput="uRecPreview()"><span class="is">months</span></div>';
    h+='<div id="spRecPreview" style="margin-top:6px;font-size:11px;color:var(--bl2);font-family:\'Geist Mono\',monospace"></div></div></div>';
    h+='<div class="fh">Ongoing = repeats indefinitely. Fixed = stops after the set number of months.</div></div>';
  }
  h+='<div class="fg"><label class="fl">Deduct from Account (optional)</label><select class="sf" id="spAcct">';
  h+='<option value="-1">None</option>';
  accts.forEach(function(a,i){h+='<option value="'+i+'"'+((it.linkedAcct===i)?' selected':'')+'>'+a.name+'</option>'});
  h+='</select><div class="fh">Links expense as outgoing on the selected account</div></div>';
  document.getElementById('spMB').innerHTML=h;
  document.getElementById('spM').classList.add('o');
  setTimeout(function(){document.getElementById('spAmt').focus()},100);
}
function cSpM(){document.getElementById('spM').classList.remove('o');spEditIdx=-1}
function uRecCalc(){
  var ct=document.getElementById('spCalcType');
  var pctRow=document.getElementById('spPctRow');
  if(!ct)return;
  if(ct.value==='fixed'){if(pctRow)pctRow.style.display='none';return}
  if(pctRow)pctRow.style.display='';
  var pctVal=+(document.getElementById('spPctVal')||{}).value||0;
  var monthlyBase=cfg.sal/12;
  if(ct.value==='pctTotal'){
    // Estimate total including shift allowance - use average take home as proxy
    var data=cAll(),pm=data.length>1?data.slice(1):data;
    var avgGross=0;pm.forEach(function(d){avgGross+=d.gP});avgGross=pm.length?avgGross/pm.length:monthlyBase;
    monthlyBase=avgGross;
  }
  var calcAmt=monthlyBase*pctVal/100;
  var amtEl=document.getElementById('spPctAmt');
  var mainAmt=document.getElementById('spAmt');
  if(amtEl)amtEl.value=calcAmt.toFixed(2);
  if(mainAmt)mainAmt.value=calcAmt.toFixed(2);
}
function tgRecOpts(){
  var ch=document.getElementById('spRec');
  var opts=document.getElementById('spRecOpts');
  var calcType=document.getElementById('spRecCalcType');
  if(opts)opts.style.display=ch&&ch.checked?'':'none';
  if(calcType)calcType.style.display=ch&&ch.checked?'':'none';
  uRecPreview();
}
function uRecPreview(){
  var fixedEl=document.getElementById('spRecFixed');
  var fixedOpts=document.getElementById('spRecFixedOpts');
  if(fixedOpts)fixedOpts.style.display=fixedEl&&fixedEl.checked?'':'none';
  var prev=document.getElementById('spRecPreview');
  if(!prev)return;
  var amt=+(document.getElementById('spAmt')||{}).value||0;
  var months=+(document.getElementById('spRecMonths')||{}).value||12;
  if(amt>0&&fixedEl&&fixedEl.checked){
    var total=amt*months;
    var p=spMonth.split('-'),yr=parseInt(p[0]),mo=parseInt(p[1]);
    var endMo=mo+months-1,endYr=yr;
    while(endMo>12){endMo-=12;endYr++}
    var moNames=['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    prev.innerHTML=fmt(amt)+'/mo \u00D7 '+months+' = <strong>'+fmt(total)+' total</strong> ('+moNames[mo]+' '+yr+' \u2013 '+moNames[endMo]+' '+endYr+')';
  } else {prev.innerHTML=''}
}
function sExp(){
  var cat=document.getElementById('spCat').value;
  var amt=+(document.getElementById('spAmt').value);
  if(!amt||amt<=0){alert('Enter a valid amount');return}
  var desc=document.getElementById('spDesc').value.trim();
  var date=document.getElementById('spDate').value;
  var linkedAcct=+(document.getElementById('spAcct').value);
  var recEl=document.getElementById('spRec');
  var isRec=recEl&&recEl.checked;
  var sm=getSpM(spMonth);
  var item={cat:cat,amount:amt,desc:desc||cat,date:date};
  if(linkedAcct>=0)item.linkedAcct=linkedAcct;
  if(isRec){
    var rid='r'+Date.now();
    item.recurId=rid;
    var fixedEl=document.getElementById('spRecFixed');
    var isFixed=fixedEl&&fixedEl.checked;
    var recMonths=isFixed?(+(document.getElementById('spRecMonths').value)||12):0;
    var rd={id:rid,cat:cat,amount:amt,desc:desc||cat,linkedAcct:linkedAcct>=0?linkedAcct:-1};
    if(isFixed){
      // Fixed period: store start month and duration
      rd.fixedMonths=recMonths;
      rd.startMonth=spMonth;
    }
    recurDefs.push(rd);
    svRecur();
  }
  if(spEditIdx>=0){
    var old=sm.items[spEditIdx];
    item.recurId=old.recurId||null;
    sm.items[spEditIdx]=item;
  } else {
    sm.items.push(item);
  }
  svSpend();cSpM();rSpend();
}
function delExpense(i){
  var sm=getSpM(spMonth);
  var it=sm.items[i];
  if(it.recurId){
    var ch=confirm('This is a recurring expense.\n\nOK = Delete from ALL months (stop recurring)\nCancel = Delete just this month');
    if(ch){
      recurDefs=recurDefs.filter(function(rd){return rd.id!==it.recurId});
      svRecur();
      Object.keys(spending).forEach(function(ym){
        if(spending[ym].items){spending[ym].items=spending[ym].items.filter(function(x){return x.recurId!==it.recurId})}
      });
    } else {
      sm.items.splice(i,1);
    }
  } else {
    if(!confirm('Delete this expense?'))return;
    sm.items.splice(i,1);
  }
  svSpend();rSpend();
}
function delRecur(i){
  if(!confirm('Stop this recurring expense?\n\nThis will remove it from all future months.'))return;
  var rid=recurDefs[i].id;
  recurDefs.splice(i,1);svRecur();
  Object.keys(spending).forEach(function(ym){
    if(spending[ym].items){spending[ym].items=spending[ym].items.filter(function(x){return x.recurId!==rid})}
  });
  svSpend();rSpend();
}
function setBudget(cat,val){
  var sm=getSpM(spMonth);sm.budget[cat]=val;
  // Propagate to future months that don't already have a budget set for this category
  if(val>0){
    var p=spMonth.split('-'),yr=parseInt(p[0]),mo=parseInt(p[1]);
    for(var f=1;f<=24;f++){
      var fmo=mo+f,fyr=yr;
      while(fmo>12){fmo-=12;fyr++}
      var fym=fyr+'-'+String(fmo).padStart(2,'0');
      if(!spending[fym])spending[fym]={budget:{},items:[]};
      if(!spending[fym].budget)spending[fym].budget={};
      // Only set if not already customised for that month
      if(!spending[fym].budget[cat]||spending[fym].budget[cat]===0){
        spending[fym].budget[cat]=val;
      }
    }
  }
  svSpend();
}

// ═══ PENSION FORECAST ═══
var penCfg={};
function ldPenCfg(){
  try{var s=localStorage.getItem('st7-pencfg');if(s)penCfg=JSON.parse(s)}catch(e){}
  if(!penCfg||typeof penCfg!=='object')penCfg={};
  if(!penCfg.retireAge)penCfg.retireAge=67;
  if(!penCfg.currentAge)penCfg.currentAge=30;
  if(!penCfg.drawdownRate)penCfg.drawdownRate=4;
  if(penCfg.inflationRate===undefined)penCfg.inflationRate=UK_CPI_AVG;
  if(penCfg.lumpSumPct===undefined)penCfg.lumpSumPct=25;
  if(!penCfg.pots){
    penCfg.pots=[{name:'Current Workplace',type:'DC',value:penCfg.currentPot||0,growth:penCfg.growthRate||5,inflLinked:false,ongoing:true,dbIncome:0}];
    delete penCfg.currentPot;delete penCfg.growthRate;delete penCfg.inflationRate;
  }
}
function svPenCfg(){try{localStorage.setItem('st7-pencfg',JSON.stringify(penCfg))}catch(e){}}
ldPenCfg();
var pfEditIdx=-1;
var UK_CPI_AVG=2.5;

function rPF(){
  var data=cAll(),pm=data.length>1?data.slice(1):data;
  var annEmp=0,annComp=0;
  pm.forEach(function(d){annEmp+=d.pG;annComp+=(d.cP||0)});
  var annTotal=annEmp+annComp;
  var yrsToRetire=Math.max(0,penCfg.retireAge-penCfg.currentAge);
  var h='';
  // Global settings
  h+='<div class="cd cd-pu"><h3><span class="ic-accent-pu">'+ICO.trend+'</span> Pension Forecast</h3>';
  h+='<div class="g2" style="margin-bottom:14px">';
  h+='<div class="fg"><label class="fl">Current Age</label><div class="iw"><input type="number" class="fi" id="pfAge" value="'+penCfg.currentAge+'" onchange="pfU()"><span class="is">yrs</span></div></div>';
  h+='<div class="fg"><label class="fl">Retirement Age</label><div class="iw"><input type="number" class="fi" id="pfRet" value="'+penCfg.retireAge+'" onchange="pfU()"><span class="is">yrs</span></div></div>';
  h+='<div class="fg"><label class="fl">Drawdown Rate</label><div class="iw"><input type="number" class="fi" id="pfDr" value="'+penCfg.drawdownRate+'" step=".5" onchange="pfU()"><span class="is">%/yr</span></div><div class="fh">Annual withdrawal from DC pot</div></div>';
  h+='<div class="fg"><label class="fl">Inflation Rate (CPI)</label><div class="iw"><input type="number" class="fi" id="pfInf" value="'+(penCfg.inflationRate||UK_CPI_AVG)+'" step=".1" onchange="pfU()"><span class="is">%/yr</span></div><div class="fh">Used for real values &amp; DB CPI adjustments</div></div>';
  h+='<div class="fg"><label class="fl">Tax-Free Lump Sum</label><div class="iw"><input type="number" class="fi" id="pfLump" value="'+(penCfg.lumpSumPct!==undefined?penCfg.lumpSumPct:25)+'" step="1" min="0" max="25" onchange="pfU()"><span class="is">%</span></div><div class="fh">0\u201325% of DC pot taken tax-free</div></div>';
  h+='</div>';
  h+='<div style="background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Annual Contributions (from '+aYr+')</div>';
  h+='<div class="sg2" style="font-size:12px">';
  h+='<span class="sl">Your sacrifice:</span><span class="sv" style="color:var(--pu)">'+fmt(annEmp)+'</span>';
  h+='<span class="sl">Company contribution:</span><span class="sv" style="color:var(--pu)">'+fmt(annComp)+'</span>';
  h+='<span class="sl" style="font-weight:700;padding-top:6px;border-top:1px solid var(--bd)">Total annual:</span>';
  h+='<span class="sv" style="font-weight:800;color:var(--pu);padding-top:6px;border-top:1px solid var(--bd)">'+fmt(annTotal)+'</span></div></div></div>';
  // Pension pots
  h+='<div class="cd cd-bl"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent">'+ICO.bank+'</span> Pension Pots</span><button class="btn bp bs" onclick="oPfM()">'+ICO.plus+' Pot</button></h3>';
  if(!penCfg.pots.length){h+='<p style="color:var(--tx3);font-size:12px">No pension pots added yet.</p>'}
  var totalPots=0;
  penCfg.pots.forEach(function(pot,i){
    if(pot.type==='DC')totalPots+=pot.value||0;
    h+='<div style="background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;margin-bottom:10px;border-left:3px solid var(--pu)">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center"><span style="font-weight:700;font-size:13px">'+pot.name+'</span>';
    h+='<span style="font-size:9px;padding:2px 6px;border-radius:10px;font-weight:700;background:'+(pot.type==='DB'?'rgba(245,158,11,.1);color:var(--or)':pot.type==='SP'?'rgba(34,197,94,.1);color:var(--gn)':'rgba(167,139,250,.1);color:var(--pu)')+'">'+pot.type+'</span>';
    if(pot.type==='SP'){h+='<span style="font-size:9px;color:var(--gn);background:rgba(34,197,94,.1);padding:2px 6px;border-radius:10px;font-weight:700">TRIPLE LOCK</span>'}
    else if(pot.ongoing)h+='<span style="font-size:9px;color:var(--gn);background:rgba(34,197,94,.1);padding:2px 6px;border-radius:10px;font-weight:700">ACTIVE</span>';
    else h+='<span style="font-size:9px;color:var(--tx3);background:var(--glass2);padding:2px 6px;border-radius:10px;font-weight:700">DEFERRED</span>';
    if(pot.inflLinked&&pot.type!=='SP')h+='<span style="font-size:9px;color:var(--bl2);background:rgba(99,102,241,.1);padding:2px 6px;border-radius:10px;font-weight:700">CPI</span>';
    h+='</div><div style="display:flex;gap:4px"><button class="btn bg bx" onclick="oPfM('+i+')">'+ICO.edit+'</button><button class="btn bdn bx" onclick="delPot('+i+')">'+ICO.x+'</button></div></div>';
    if(pot.type==='DC'){h+='<div style="font-size:20px;font-weight:800;font-family:\'Geist Mono\',monospace;color:var(--pu)">'+fmt(pot.value||0)+'</div>';h+='<div style="font-size:10px;color:var(--tx3);margin-top:2px">Growth: '+pot.growth+'%/yr'+(pot.ongoing?' \u2022 Receiving contributions':'')+'</div>'}
    else if(pot.type==='SP'){
      var spAnn=(pot.spWeekly||221.20)*52*(Math.min(35,pot.spYears||35)/35);
      h+='<div style="font-size:20px;font-weight:800;font-family:\'Geist Mono\',monospace;color:var(--gn)">'+fmt(spAnn)+'/yr</div>';
      h+='<div style="font-size:10px;color:var(--tx3);margin-top:2px">'+fmt(pot.spWeekly||221.20)+'/wk \u2022 '+(pot.spYears||35)+'/35 qualifying years \u2022 From age '+(pot.spAge||67)+' \u2022 Triple lock protected</div>';
    }
    else{h+='<div style="font-size:20px;font-weight:800;font-family:\'Geist Mono\',monospace;color:var(--or)">'+fmt(pot.dbIncome||0)+'/yr</div>';h+='<div style="font-size:10px;color:var(--tx3);margin-top:2px">'+(pot.ongoing?'Projected income at retirement':'Accrued income when stopped')+(pot.inflLinked?' (CPI linked)':'')+(pot.stoppedYear&&!pot.ongoing?' \u2022 Stopped '+pot.stoppedYear+' \u2022 CPI from then':'')+'</div>'}
    h+='</div>';
  });
  if(penCfg.pots.length>1){h+='<div style="background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);padding:12px"><div style="font-size:11px;color:var(--tx3);text-transform:uppercase;font-weight:600;margin-bottom:4px">Total DC Value</div><div style="font-size:20px;font-weight:800;font-family:\'Geist Mono\',monospace;color:var(--pu)">'+fmt(totalPots)+'</div></div>'}
  h+='</div>';
  // Projection
  var dcFinalTotal=0,dbIncomeTotal=0,projRows=[],avgInf=(penCfg.inflationRate||UK_CPI_AVG)/100;
  for(var y=0;y<=yrsToRetire;y++){var totalAtY=0;penCfg.pots.forEach(function(pot){if(pot.type==='DC'){var v=pot.value||0,gr=(pot.growth||5)/100,contrib=pot.ongoing?annTotal:0;for(var yi=0;yi<y;yi++){v=v*(1+gr)+contrib}totalAtY+=v;if(y===yrsToRetire)dcFinalTotal+=v}});projRows.push({yr:y,age:penCfg.currentAge+y,pot:totalAtY})}
  penCfg.pots.forEach(function(pot){
    if(pot.type==='DB'){var inc=pot.dbIncome||0;if(pot.inflLinked){var infYrs=yrsToRetire;if(pot.stoppedYear){var yearsFromStop=Math.max(0,(new Date().getFullYear()+yrsToRetire)-pot.stoppedYear);infYrs=yearsFromStop}inc=inc*Math.pow(1+avgInf,infYrs)}dbIncomeTotal+=inc}
    else if(pot.type==='SP'){
      var spAge=pot.spAge||67;
      if(penCfg.currentAge+yrsToRetire>=spAge){
        var spAnn=(pot.spWeekly||221.20)*52*(Math.min(35,pot.spYears||35)/35);
        // Triple lock: highest of earnings (~3.5%), CPI, or 2.5% — model at ~3.5%
        var tripleLock=Math.max((penCfg.inflationRate||UK_CPI_AVG)/100,0.035);
        var spYrsGrowth=yrsToRetire;
        spAnn=spAnn*Math.pow(1+tripleLock,spYrsGrowth);
        dbIncomeTotal+=spAnn;
      }
    }
  });
  var realDCPot=dcFinalTotal/Math.pow(1+avgInf,yrsToRetire);
  var lumpSumPct=(penCfg.lumpSumPct!==undefined?penCfg.lumpSumPct:25)/100;
  var lumpSum=dcFinalTotal*lumpSumPct;
  var remainingPot=dcFinalTotal-lumpSum;
  var dcAnnIncome=remainingPot*(penCfg.drawdownRate/100);
  var totalAnnIncome=dcAnnIncome+dbIncomeTotal;
  // Calculate how many years the pot lasts at the drawdown rate
  var potYears=0;
  if(penCfg.drawdownRate>0&&remainingPot>0){
    var simPot=remainingPot,simGr=(penCfg.drawdownRate<=4?2:1)/100;// conservative growth in drawdown
    var annDraw=dcAnnIncome;
    while(simPot>0&&potYears<100){simPot=simPot*(1+simGr)-annDraw*(1+avgInf*potYears/100);potYears++;if(simPot<0)break}
  }
  h+='<div class="cd cd-gn"><h3><span class="ic-accent-gn">'+ICO.chart+'</span> Projected Outcome at '+penCfg.retireAge+'</h3>';
  h+='<div class="sg" style="margin-bottom:14px">';
  h+='<div class="st" style="border-left:3px solid var(--pu)"><div class="st-l">DC Pot</div><div class="st-v" style="font-size:16px;color:var(--pu)">'+fs(dcFinalTotal)+'</div><div class="st-s">Nominal</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--gn)"><div class="st-l">Real Value</div><div class="st-v" style="font-size:16px;color:var(--gn)">'+fs(realDCPot)+'</div><div class="st-s">Today\'s '+P+'</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--or)"><div class="st-l">Total Income</div><div class="st-v" style="font-size:16px;color:var(--or)">'+fs(totalAnnIncome)+'/yr</div><div class="st-s">DC + DB</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--bl)"><div class="st-l">Tax-Free Lump</div><div class="st-v" style="font-size:16px;color:var(--bl2)">'+fs(lumpSum)+'</div><div class="st-s">'+(lumpSumPct*100).toFixed(0)+'% of DC</div></div></div>';
  // Lump sum impact info
  if(lumpSumPct>0&&lumpSumPct<0.25){
    var fullLump=dcFinalTotal*0.25;var fullRemain=dcFinalTotal-fullLump;var fullIncome=fullRemain*(penCfg.drawdownRate/100);
    h+='<div class="ib" style="margin-bottom:14px"><strong>Lump sum impact:</strong> Taking '+(lumpSumPct*100).toFixed(0)+'% ('+fs(lumpSum)+') vs full 25% ('+fs(fullLump)+') gives you '+fs(dcAnnIncome-fullIncome)+'/yr more drawdown income.</div>';
  } else if(lumpSumPct===0){
    h+='<div class="ib" style="margin-bottom:14px"><strong>No lump sum:</strong> Keeping full pot in drawdown. Taking 25% would give you '+fs(dcFinalTotal*0.25)+' tax-free but reduce annual income by '+fs(dcFinalTotal*0.25*(penCfg.drawdownRate/100))+'/yr.</div>';
  }
  h+='<div style="background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);padding:14px;margin-bottom:14px"><div class="sg2" style="font-size:12px">';
  h+='<span class="sl">DC pot after lump sum:</span><span class="sv" style="color:var(--pu)">'+fmt(remainingPot)+'</span>';
  h+='<span class="sl">DC drawdown ('+penCfg.drawdownRate+'%):</span><span class="sv" style="color:var(--pu)">'+fmt(dcAnnIncome)+'/yr</span>';
  if(dbIncomeTotal>0){
    // Show DB and SP separately
    var dbOnly=0,spOnly=0;
    penCfg.pots.forEach(function(pot){
      if(pot.type==='DB'){var inc=pot.dbIncome||0;if(pot.inflLinked){var infYrs=yrsToRetire;if(pot.stoppedYear){var yearsFromStop=Math.max(0,(new Date().getFullYear()+yrsToRetire)-pot.stoppedYear);infYrs=yearsFromStop}inc=inc*Math.pow(1+avgInf,infYrs)}dbOnly+=inc}
      else if(pot.type==='SP'){var spAge=pot.spAge||67;if(penCfg.currentAge+yrsToRetire>=spAge){var spAnn=(pot.spWeekly||221.20)*52*(Math.min(35,pot.spYears||35)/35);var tl=Math.max((penCfg.inflationRate||UK_CPI_AVG)/100,0.035);spAnn=spAnn*Math.pow(1+tl,yrsToRetire);spOnly+=spAnn}}
    });
    if(dbOnly>0)h+='<span class="sl">DB pension:</span><span class="sv" style="color:var(--or)">'+fmt(dbOnly)+'/yr</span>';
    if(spOnly>0)h+='<span class="sl">State Pension:</span><span class="sv" style="color:var(--gn)">'+fmt(spOnly)+'/yr</span>';
  }
  h+='<span class="sl" style="font-weight:700;padding-top:6px;border-top:1px solid var(--bd)">Total annual:</span><span class="sv" style="font-weight:800;color:var(--gn);padding-top:6px;border-top:1px solid var(--bd)">'+fmt(totalAnnIncome)+'/yr</span>';
  h+='<span class="sl">Monthly:</span><span class="sv" style="color:var(--gn)">'+fmt(totalAnnIncome/12)+'/mo</span>';
  h+='<span class="sl">Years to retirement:</span><span class="sv">'+yrsToRetire+'</span>';
  // Pot longevity
  if(potYears>0&&potYears<100){
    h+='<span class="sl" style="font-weight:700;color:var(--or)">DC pot lasts:</span><span class="sv" style="font-weight:800;color:'+(potYears>=30?'var(--gn)':potYears>=20?'var(--or)':'var(--rd)')+'">~'+potYears+' years</span>';
    h+='<span class="sl">Pot depleted at age:</span><span class="sv" style="color:'+(penCfg.retireAge+potYears>=90?'var(--gn)':penCfg.retireAge+potYears>=80?'var(--or)':'var(--rd)')+'">'+(penCfg.retireAge+potYears)+'</span>';
  } else if(potYears>=100){
    h+='<span class="sl" style="font-weight:700;color:var(--gn)">DC pot lasts:</span><span class="sv" style="font-weight:800;color:var(--gn)">100+ years</span>';
  }
  h+='</div></div>';
  // Growth table
  var finalPot=projRows.length?projRows[projRows.length-1].pot:0;
  if(finalPot>0){h+='<div style="font-size:12px;font-weight:700;margin-bottom:8px">DC Growth Timeline</div>';
  h+='<div class="tw"><table class="dt"><thead><tr><th>Age</th><th class="r">Pot Value</th><th class="r">Real Value</th><th style="width:30%">Chart</th></tr></thead><tbody>';
  var mx2=finalPot;if(mx2===0)mx2=1;var step=yrsToRetire<=15?1:yrsToRetire<=30?2:5;
  projRows.forEach(function(r,idx){if(idx===0||idx===projRows.length-1||idx%step===0){var pct=mx2>0?r.pot/mx2*100:0;var real=r.pot/Math.pow(1+avgInf,r.yr);h+='<tr><td style="font-weight:600">'+r.age+'</td><td class="r" style="font-weight:700;color:var(--pu)">'+fs(r.pot)+'</td><td class="r" style="color:var(--gn)">'+fs(real)+'</td><td><div style="background:var(--pu);height:14px;width:'+pct+'%;border-radius:3px;opacity:.5"></div></td></tr>'}});
  h+='</tbody></table></div>'}
  h+='<div class="ib" style="margin-top:14px">Inflation modelled at '+(penCfg.inflationRate||UK_CPI_AVG)+'% p.a. (adjustable above). DB pensions marked CPI-linked increase with inflation. Pot longevity assumes '+((penCfg.drawdownRate<=4?2:1))+'% growth during drawdown.</div></div>';
  document.getElementById('c-pf').innerHTML=h;
}
// Pension pot modal (reuses account modal shell)
function oPfM(idx){
  pfEditIdx=idx===undefined?-1:idx;var isEdit=pfEditIdx>=0;
  var pot=isEdit?penCfg.pots[pfEditIdx]:{name:'',type:'DC',value:0,growth:5,inflLinked:false,ongoing:true,dbIncome:0};
  document.getElementById('acMT').textContent=isEdit?'Edit Pension Pot':'Add Pension Pot';
  document.getElementById('acMSB').textContent=isEdit?'Save Changes':'Add Pot';
  var h='<div class="fg"><label class="fl">Pot Name</label><div class="iw"><input type="text" class="fi" id="ppName" value="'+(pot.name||'')+'" placeholder="e.g. Current Workplace, Old LGPS, SIPP"></div></div>';
  h+='<div class="fg"><label class="fl">Pension Type</label><select class="sf" id="ppType" onchange="tgPP()"><option value="DC"'+(pot.type==='DC'?' selected':'')+'>Defined Contribution (DC)</option><option value="DB"'+(pot.type==='DB'?' selected':'')+'>Defined Benefit (DB)</option><option value="SP"'+(pot.type==='SP'?' selected':'')+'>State Pension</option></select>';
  h+='<div class="fh">DC = money purchase pot. DB = guaranteed annual income. SP = UK State Pension.</div></div>';
  h+='<div id="ppDC" style="'+(pot.type!=='DC'?'display:none':'')+'"><div class="g2">';
  h+='<div class="fg"><label class="fl">Current Pot Value</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="ppVal" value="'+(pot.value||0)+'" step="100"></div></div>';
  h+='<div class="fg"><label class="fl">Expected Growth</label><div class="iw"><input type="number" class="fi" id="ppGr" value="'+(pot.growth||5)+'" step=".5"><span class="is">%/yr</span></div></div></div></div>';
  h+='<div id="ppDB" style="'+(pot.type!=='DB'?'display:none':'')+'"><div class="fg"><label class="fl" id="ppDBILabel">Annual Pension Income</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="ppDBI" value="'+(pot.dbIncome||0)+'" step="100"></div><div class="fh" id="ppDBIHint">The annual income from this scheme (at retirement if active, or at date contributions stopped if deferred)</div></div>';
  h+='<div class="fg" id="ppStopWrap" style="'+(pot.ongoing?'display:none':'')+'"><label class="fl">Year Contributions Stopped</label><div class="iw"><input type="number" class="fi" id="ppStop" value="'+(pot.stoppedYear||new Date().getFullYear())+'" min="1960" max="2099" placeholder="e.g. 2020"></div><div class="fh">Inflation applied from this year onwards for CPI-linked pensions</div></div></div>';
  h+='<div id="ppSP" style="'+(pot.type!=='SP'?'display:none':'')+'"><div class="fg"><label class="fl">Weekly State Pension Amount</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="ppSPW" value="'+(pot.spWeekly||221.20)+'" step=".01"></div><div class="fh">Full new State Pension 2024/25: £221.20/wk (£11,502/yr). Check your forecast at <a href="https://www.gov.uk/check-state-pension" target="_blank" style="color:var(--bl2)">gov.uk</a></div></div>';
  h+='<div class="fg"><label class="fl">NI Qualifying Years</label><div class="iw"><input type="number" class="fi" id="ppSPY" value="'+(pot.spYears||35)+'" min="0" max="35"><span class="is">/35</span></div><div class="fh">You need 35 qualifying years for full State Pension. Amount is proportional.</div></div>';
  h+='<div class="fg"><label class="fl">State Pension Age</label><div class="iw"><input type="number" class="fi" id="ppSPA" value="'+(pot.spAge||67)+'" min="60" max="75"><span class="is">yrs</span></div><div class="fh">Currently 66, rising to 67 (2028) then 68 (2046). Check your age at gov.uk</div></div>';
  h+='<div class="ib" style="margin-top:0;margin-bottom:10px">State Pension is triple-lock protected: increases by the highest of earnings growth, CPI inflation, or 2.5% per year.</div></div>';
  h+='<div id="ppDBSPOpts" style="'+(pot.type==='DC'?'display:none':'')+'">';
  if(pot.type!=='SP'){
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppInf" '+(pot.inflLinked?'checked':'')+' style="accent-color:var(--bl);width:16px;height:16px"> Inflation-linked (CPI)</label><div class="fh">Adjusts with inflation (~'+(penCfg.inflationRate||UK_CPI_AVG)+'% p.a.)</div></div>';
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppOn" '+(pot.ongoing?'checked':'')+' onchange="tgPPOn()" style="accent-color:var(--gn);width:16px;height:16px"> Contributions ongoing</label><div class="fh">Uncheck if no longer contributing (deferred pension)</div></div>';
  } else {
    h+='<input type="hidden" id="ppInf" value="1"><input type="hidden" id="ppOn" value="1">';
  }
  h+='</div>';
  document.getElementById('acMB').innerHTML=h;
  document.getElementById('acM').classList.add('o');
  document.getElementById('acMSB').setAttribute('onclick','sPfPot()');
  setTimeout(function(){document.getElementById('ppName').focus();tgPPOnLabel()},100);
}
function tgPP(){
  var t=document.getElementById('ppType').value;
  document.getElementById('ppDC').style.display=t==='DC'?'':'none';
  document.getElementById('ppDB').style.display=t==='DB'?'':'none';
  document.getElementById('ppSP').style.display=t==='SP'?'':'none';
  document.getElementById('ppDBSPOpts').style.display=t==='DC'?'none':'';
  // Rebuild options area for SP vs DB
  var optsEl=document.getElementById('ppDBSPOpts');
  if(t==='SP'){
    optsEl.innerHTML='<input type="hidden" id="ppInf" value="1"><input type="hidden" id="ppOn" value="1">';
  } else if(t==='DB'){
    optsEl.innerHTML='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppInf" style="accent-color:var(--bl);width:16px;height:16px"> Inflation-linked (CPI)</label><div class="fh">Adjusts with inflation (~'+(penCfg.inflationRate||UK_CPI_AVG)+'% p.a.)</div></div><div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppOn" checked onchange="tgPPOn()" style="accent-color:var(--gn);width:16px;height:16px"> Contributions ongoing</label><div class="fh">Uncheck if no longer contributing (deferred pension)</div></div>';
  } else {
    optsEl.innerHTML='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppInf" style="accent-color:var(--bl);width:16px;height:16px"> Inflation-linked (CPI)</label><div class="fh">Adjusts with inflation (~'+(penCfg.inflationRate||UK_CPI_AVG)+'% p.a.)</div></div><div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="ppOn" checked onchange="tgPPOn()" style="accent-color:var(--gn);width:16px;height:16px"> Contributions ongoing</label><div class="fh">Uncheck if no longer contributing</div></div>';
  }
  tgPPOn();tgPPOnLabel();
}
function tgPPOn(){var onEl=document.getElementById('ppOn');var on=onEl?(onEl.type==='hidden'?true:onEl.checked):true;var w=document.getElementById('ppStopWrap');if(w)w.style.display=on?'none':'';tgPPOnLabel()}
function tgPPOnLabel(){
  var onEl=document.getElementById('ppOn');var on=onEl?(onEl.type==='hidden'?true:onEl.checked):true;
  var lbl=document.getElementById('ppDBILabel');var hint=document.getElementById('ppDBIHint');
  if(lbl){lbl.textContent=on?'Annual Pension Income at Retirement':'Annual Pension Income When Stopped'}
  if(hint){hint.textContent=on?'Projected annual pension from this scheme at retirement':'Annual pension accrued at the date you stopped contributing'}
}
function sPfPot(){
  var name=document.getElementById('ppName').value.trim();if(!name){alert('Enter pot name');return}
  var type=document.getElementById('ppType').value;
  var infEl=document.getElementById('ppInf');
  var onEl=document.getElementById('ppOn');
  var pot={name:name,type:type,inflLinked:infEl?(infEl.type==='hidden'?true:infEl.checked):false,ongoing:onEl?(onEl.type==='hidden'?true:onEl.checked):true};
  if(type==='DC'){pot.value=+(document.getElementById('ppVal').value)||0;pot.growth=+(document.getElementById('ppGr').value)||5;pot.dbIncome=0}
  else if(type==='DB'){pot.dbIncome=+(document.getElementById('ppDBI').value)||0;pot.value=0;pot.growth=0;if(!pot.ongoing){pot.stoppedYear=+(document.getElementById('ppStop').value)||new Date().getFullYear()}}
  else if(type==='SP'){
    pot.spWeekly=+(document.getElementById('ppSPW').value)||221.20;
    pot.spYears=Math.min(35,Math.max(0,+(document.getElementById('ppSPY').value)||35));
    pot.spAge=+(document.getElementById('ppSPA').value)||67;
    pot.dbIncome=(pot.spWeekly*52)*(pot.spYears/35);
    pot.inflLinked=true;pot.ongoing=true;pot.value=0;pot.growth=0;
  }
  if(pfEditIdx>=0)penCfg.pots[pfEditIdx]=pot;else penCfg.pots.push(pot);
  svPenCfg();cAcM();document.getElementById('acMSB').setAttribute('onclick','sAcct()');rPF();
}
function delPot(i){if(!confirm('Delete '+penCfg.pots[i].name+'?'))return;penCfg.pots.splice(i,1);svPenCfg();rPF()}
function pfU(){penCfg.currentAge=+(document.getElementById('pfAge').value)||30;penCfg.retireAge=+(document.getElementById('pfRet').value)||67;penCfg.drawdownRate=+(document.getElementById('pfDr').value)||4;penCfg.inflationRate=+(document.getElementById('pfInf').value)||UK_CPI_AVG;var lump=+(document.getElementById('pfLump').value);penCfg.lumpSumPct=isNaN(lump)?25:Math.min(25,Math.max(0,lump));svPenCfg();rPF()}

// ═══ SHIFT CALENDAR & HOLIDAY TRACKER ═══
var holidays=[];
function ldHolidays(){try{var s=localStorage.getItem('st7-holidays');if(s)holidays=JSON.parse(s)}catch(e){}if(!holidays||!Array.isArray(holidays))holidays=[]}
function svHolidays(){try{localStorage.setItem('st7-holidays',JSON.stringify(holidays))}catch(e){}}
ldHolidays();

var calMonth2=new Date().getMonth();
var calYear2=new Date().getFullYear();
var holCfg={};
function ldHolCfg(){try{var s=localStorage.getItem('st7-holcfg');if(s)holCfg=JSON.parse(s)}catch(e){}if(!holCfg||typeof holCfg!=='object')holCfg={};if(!holCfg.entitlement)holCfg.entitlement=28;if(!holCfg.unit)holCfg.unit='days';if(holCfg.lastKnownRate===undefined)holCfg.lastKnownRate=0;if(holCfg.lastKnownUnit===undefined)holCfg.lastKnownUnit='day';if(holCfg.useLastKnownRate===undefined)holCfg.useLastKnownRate=false}
function svHolCfg(){try{localStorage.setItem('st7-holcfg',JSON.stringify(holCfg))}catch(e){}}
ldHolCfg();

// Holiday pay calc: HMRC 52-week reference period
// Average hourly rate = total gross (incl SA, OT, extras) / total hours worked
// Uplift per hour = average hourly rate - base hourly rate
function calcHolPayRate(){
  var baseHourly=cfg.payBasis==='hourly'?(cfg.hourlyRate||0):cfg.sal/52/(cfg.shw||39);
  // Override: always use last known rate if enabled
  if(holCfg.useLastKnownRate&&holCfg.lastKnownRate>0){
    return{weeks:0,source:'override',avgHourly:holCfg.lastKnownRate,baseHourly:baseHourly,upliftHourly:Math.max(0,holCfg.lastKnownRate-baseHourly),weeklyAvg:0,dailyAvg:0};
  }
  var allWeeklyGross=[];
  var allWeeklyHours=[];
  Object.keys(years).sort().forEach(function(yr){
    var yrData=years[yr];if(!yrData.periods)return;
    var savedCfg2=cfg,savedTax2=tax;
    cfg=yrData.cfg;tax=yrData.tax;
    yrData.periods.forEach(function(p,i){
      if(i===0)return;
      if(p.start&&p.end){
        var calc=cM(p,i);
        if(calc.gP>0){
          var wks=p.mW||4;
          // Total gross per week for holiday pay: use pre-deduction gross (before pension & sacrifice)
          allWeeklyGross.push((calc.grossForHol||calc.gP)/wks);
          // Total working hours per week
          allWeeklyHours.push(calc.hW/wks);
        }
      }
    });
    cfg=savedCfg2;tax=savedTax2;
  });
  var refGross=allWeeklyGross.slice(-52);
  var refHours=allWeeklyHours.slice(-52);

  if(refGross.length===0){
    if(holCfg.lastKnownRate>0){
      return{weeks:0,source:'manual',avgHourly:holCfg.lastKnownRate,baseHourly:baseHourly,upliftHourly:Math.max(0,holCfg.lastKnownRate-baseHourly),weeklyAvg:0,dailyAvg:0};
    }
    return{weeks:0,source:'salary',avgHourly:baseHourly,baseHourly:baseHourly,upliftHourly:0,weeklyAvg:cfg.sal/52,dailyAvg:cfg.sal/52/5};
  }
  var totalGross=refGross.reduce(function(s,v){return s+v},0);
  var totalHours=refHours.reduce(function(s,v){return s+v},0);
  var weeklyAvg=totalGross/refGross.length;
  var dailyAvg=weeklyAvg/5;
  var avgHoursPerWeek=totalHours/refHours.length;
  var avgHourly=avgHoursPerWeek>0?weeklyAvg/avgHoursPerWeek:baseHourly;
  var upliftHourly=Math.max(0,avgHourly-baseHourly);
  return{weeks:refGross.length,source:'calculated',avgHourly:avgHourly,baseHourly:baseHourly,upliftHourly:upliftHourly,weeklyAvg:weeklyAvg,dailyAvg:dailyAvg,avgHoursPerWeek:avgHoursPerWeek};
}

function getShiftForDate(dateStr){
  if(!cfg.patternStart||!cfg.sp.length)return null;
  var ps=new Date(cfg.patternStart+'T00:00:00');
  var p=dateStr.split('-'),d=new Date(+p[0],+p[1]-1,+p[2]);
  var ds=Math.round((d-ps)/864e5),cl=cfg.sp.length;
  var pos=((ds%cl)+cl)%cl;
  return cfg.sp[pos];
}

function isHoliday(dateStr){
  for(var i=0;i<holidays.length;i++){
    if(holidays[i].date===dateStr)return holidays[i];
    if(holidays[i].startDate&&holidays[i].endDate){
      if(dateStr>=holidays[i].startDate&&dateStr<=holidays[i].endDate)return holidays[i];
    }
  }
  return null;
}

function addHoliday(startDate,endDate,desc,duration,hoursOff){
  var id='hol_'+Date.now();
  // duration: 'full', 'half-am', 'half-pm', 'hours'
  var fraction=1;
  if(duration==='half-am'||duration==='half-pm')fraction=0.5;
  else if(duration==='hours'&&hoursOff){
    var sh0=getShiftForDate(startDate);
    var st0=sh0?getShiftType(sh0.t):null;
    var paidH=st0?(st0.totalHours||12)-(cfg.unpaidBreak!==undefined?cfg.unpaidBreak:0.5):11.5;
    fraction=Math.min(1,hoursOff/paidH);
  }
  var hol={id:id,startDate:startDate,endDate:endDate||startDate,desc:desc||'Holiday',date:startDate,duration:duration||'full',fraction:fraction,hoursOff:hoursOff||0};
  holidays.push(hol);
  svHolidays();
  addHolidayToPay(hol);
  rCal();
}

function addHolidayToPay(hol){
  var hp=calcHolPayRate();
  var start=hol.startDate,end=hol.endDate||hol.startDate;
  var fraction=hol.fraction!==undefined?hol.fraction:1;
  // Count paid hours off for each working day in the range
  var cur=new Date(start+'T00:00:00'),ed2=new Date(end+'T00:00:00');
  var totalHoursOff=0;
  var workDaysFrac=0;
  while(cur<=ed2){
    var ds2=cur.getFullYear()+'-'+String(cur.getMonth()+1).padStart(2,'0')+'-'+String(cur.getDate()).padStart(2,'0');
    var sh=getShiftForDate(ds2);
    if(sh&&sh.t!=='off'){
      var st=getShiftType(sh.t);
      var paidH=st?(st.totalHours||12)-(cfg.unpaidBreak!==undefined?cfg.unpaidBreak:0.5):11.5;
      totalHoursOff+=paidH*fraction;
      workDaysFrac+=fraction;
    }
    cur.setDate(cur.getDate()+1);
  }
  if(totalHoursOff===0)return;
  // Uplift = hours off x (avg hourly rate - base hourly rate)
  var uplift=totalHoursOff*hp.upliftHourly;
  var dayLabel=workDaysFrac===1?'1 day':workDaysFrac===0.5?'\u00BD day':fmtNum2(workDaysFrac)+' days';
  var durLabel=hol.duration==='half-am'?' (AM)':hol.duration==='half-pm'?' (PM)':hol.duration==='hours'?' ('+fmtNum2(hol.hoursOff)+'h)':'';
  // Find the period and add uplift as extras entry
  var periods=years[aYr].periods;
  for(var pi=0;pi<periods.length;pi++){
    var p=periods[pi];
    if(p.start&&p.end&&start>=p.start&&start<=p.end){
      if(!p.extras)p.extras=[];
      p.extras.push({type:'bonus',amount:uplift,desc:'Holiday uplift: '+(hol.desc||'Annual leave')+' '+dayLabel+durLabel+' ('+fmtNum2(totalHoursOff)+'h @ '+fmt(hp.upliftHourly)+'/h)',holidayId:hol.id});
      save();
      return;
    }
  }
}

function delHoliday(id){
  holidays=holidays.filter(function(h){return h.id!==id});
  svHolidays();
  // Remove from pay periods
  years[aYr].periods.forEach(function(p){
    if(p.extras)p.extras=p.extras.filter(function(e){return e.holidayId!==id});
  });
  save();rCal();
}

function exportCalICS(){
  if(!cfg.patternStart||!cfg.sp.length){alert('Set up shift pattern and start date first');return}
  var lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SalaryTracker//ShiftCalendar//EN','CALSCALE:GREGORIAN'];
  // Export 6 months of shifts
  var ps=new Date(cfg.patternStart+'T00:00:00');
  var now=new Date();
  var end=new Date(now);end.setMonth(end.getMonth()+6);
  var cur2=new Date(now);
  while(cur2<=end){
    var ds=Math.round((cur2-ps)/864e5),cl=cfg.sp.length;
    var pos=((ds%cl)+cl)%cl;
    var sh=cfg.sp[pos];
    if(sh&&sh.t!=='off'){
      var st=getShiftType(sh.t);
      var dStr=cur2.getFullYear()+String(cur2.getMonth()+1).padStart(2,'0')+String(cur2.getDate()).padStart(2,'0');
      lines.push('BEGIN:VEVENT');
      lines.push('DTSTART;VALUE=DATE:'+dStr);
      lines.push('DTEND;VALUE=DATE:'+dStr);
      lines.push('SUMMARY:'+(st?st.label:sh.t.charAt(0).toUpperCase()+sh.t.slice(1))+' Shift'+(sh.h?' ('+sh.h+'h)':''));
      lines.push('UID:shift-'+dStr+'-'+pos+'@salarytracker');
      lines.push('END:VEVENT');
    }
    // Add holidays
    var holDs=cur2.getFullYear()+'-'+String(cur2.getMonth()+1).padStart(2,'0')+'-'+String(cur2.getDate()).padStart(2,'0');
    var hol2=isHoliday(holDs);
    if(hol2){
      var dStr2=cur2.getFullYear()+String(cur2.getMonth()+1).padStart(2,'0')+String(cur2.getDate()).padStart(2,'0');
      lines.push('BEGIN:VEVENT');
      lines.push('DTSTART;VALUE=DATE:'+dStr2);
      lines.push('DTEND;VALUE=DATE:'+dStr2);
      lines.push('SUMMARY:\uD83C\uDFD6 '+(hol2.desc||'Holiday'));
      lines.push('UID:holiday-'+dStr2+'@salarytracker');
      lines.push('END:VEVENT');
    }
    cur2.setDate(cur2.getDate()+1);
  }
  lines.push('END:VCALENDAR');
  var blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='shifts-'+calYear2+'.ics';a.click();URL.revokeObjectURL(url);
}

function rCal(){
  var moNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  var dayHeaders=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  var h='';
  // Month nav
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">';
  h+='<button class="btn bg bs" onclick="calNav(-1)">&laquo; Prev</button>';
  h+='<div style="text-align:center"><span style="font-weight:700;font-size:15px">'+moNames[calMonth2]+' '+calYear2+'</span>';
  h+='<div style="font-size:9px;color:var(--tx3)"><a href="javascript:calGoNow()" style="color:var(--bl2)">Today</a></div></div>';
  h+='<button class="btn bg bs" onclick="calNav(1)">Next &raquo;</button></div>';

  // Calendar grid
  h+='<div class="cd cd-bl"><h3 style="justify-content:space-between"><span style="display:flex;align-items:center;gap:10px"><span class="ic-accent">'+ICO.cal+'</span> Shift Calendar</span>';
  h+='<div style="display:flex;gap:4px"><button class="btn bp bx" onclick="oHolM()">'+ICO.plus+' Holiday</button>';
  h+='<button class="btn bg bx" onclick="exportCalICS()" title="Export to .ics (Google Calendar, Outlook)">'+ICO.dl+'</button></div></h3>';

  if(!cfg.patternStart||!cfg.sp.length){
    h+='<div class="ib w">Set your shift pattern start date and pattern in Settings to see the calendar.</div>';
  } else {
    // Build calendar grid
    var firstDay=new Date(calYear2,calMonth2,1);
    var lastDay=new Date(calYear2,calMonth2+1,0);
    var startDow=(firstDay.getDay()+6)%7; // Mon=0
    var today=new Date();today.setHours(0,0,0,0);

    h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:14px">';
    // Headers
    dayHeaders.forEach(function(dh){h+='<div style="text-align:center;font-size:10px;font-weight:700;color:var(--tx3);padding:4px">'+dh+'</div>'});
    // Empty cells before first day
    for(var e=0;e<startDow;e++){h+='<div style="padding:6px;min-height:50px"></div>'}
    // Days
    for(var d=1;d<=lastDay.getDate();d++){
      var dateStr=calYear2+'-'+String(calMonth2+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      var sh2=getShiftForDate(dateStr);
      var isToday=(today.getDate()===d&&today.getMonth()===calMonth2&&today.getFullYear()===calYear2);
      var hol3=isHoliday(dateStr);
      var st2=sh2?getShiftType(sh2.t):null;
      var bgCol='var(--s2)';var txCol='var(--tx)';var label='';
      if(hol3){var holFrac3=hol3.fraction!==undefined?hol3.fraction:1;if(holFrac3<1){bgCol='rgba(34,197,94,.12)';txCol='var(--gn)';label='\uD83C\uDFD6'+(holFrac3===0.5?' \u00BD':' '+fmtNum2(holFrac3))}else{bgCol='rgba(34,197,94,.15)';txCol='var(--gn)';label='\uD83C\uDFD6'}}
      else if(sh2&&sh2.t==='off'){bgCol='var(--s2)';txCol='var(--tx3)';label='Off'}
      else if(st2){bgCol=st2.color.indexOf('--gn')>=0?'rgba(34,197,94,.08)':st2.color.indexOf('--bl')>=0?'rgba(99,102,241,.08)':st2.color.indexOf('--or')>=0?'rgba(245,158,11,.08)':'rgba(167,139,250,.08)';label=st2.label+(sh2.h?' '+sh2.h+'h':'')}
      else if(sh2){label=sh2.t;bgCol='var(--s2)'}
      h+='<div style="padding:4px;min-height:50px;border-radius:6px;background:'+bgCol+';border:'+(isToday?'2px solid var(--bl)':'1px solid var(--bd)')+';cursor:pointer;font-size:10px;position:relative" onclick="calDayClick(\''+dateStr+'\')">';
      h+='<div style="font-weight:'+(isToday?'800':'600')+';font-size:11px;color:'+(isToday?'var(--bl2)':txCol)+'">'+d+'</div>';
      h+='<div style="font-size:9px;font-weight:600;color:'+txCol+';margin-top:2px;line-height:1.2">'+label+'</div>';
      if(hol3)h+='<div style="font-size:8px;color:var(--gn);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(hol3.desc||'')+'</div>';
      h+='</div>';
    }
    h+='</div>';
    // Shift type legend
    h+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">';
    (cfg.shiftTypes||[]).forEach(function(st3){
      h+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600;background:'+(st3.id==='off'?'var(--glass2)':st3.color.indexOf('--gn')>=0?'rgba(34,197,94,.1)':st3.color.indexOf('--bl')>=0?'rgba(99,102,241,.1)':st3.color.indexOf('--or')>=0?'rgba(245,158,11,.1)':'rgba(167,139,250,.1)')+';color:'+(st3.id==='off'?'var(--tx3)':st3.color.replace('var(','').replace(')','').indexOf('--gn')>=0?'var(--gn)':'var(--bl2)')+'">'+st3.label+'</span>';
    });
    h+='<span style="font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600;background:rgba(34,197,94,.15);color:var(--gn)">\uD83C\uDFD6 Holiday</span>';
    h+='</div>';
  }
  h+='</div>';

  // Holiday tracker
  var sy=parseInt(aYr.split('/')[0]);
  var yrHols=holidays.filter(function(hh){
    var y=parseInt(hh.startDate.split('-')[0]),m=parseInt(hh.startDate.split('-')[1]);
    // Check if in current tax year (Apr-Mar)
    return(y===sy&&m>=4)||(y===sy+1&&m<=3);
  });
  var usedDays=0;
  yrHols.forEach(function(hh){
    var frac=hh.fraction!==undefined?hh.fraction:1;
    var s3=new Date(hh.startDate+'T00:00:00'),e3=new Date((hh.endDate||hh.startDate)+'T00:00:00');
    var c3=new Date(s3);
    while(c3<=e3){
      var sh3=getShiftForDate(c3.getFullYear()+'-'+String(c3.getMonth()+1).padStart(2,'0')+'-'+String(c3.getDate()).padStart(2,'0'));
      if(sh3&&sh3.t!=='off')usedDays+=frac;
      c3.setDate(c3.getDate()+1);
    }
  });
  var remaining=Math.max(0,(holCfg.entitlement||28)-usedDays);
  var usedLabel=usedDays%1===0?usedDays:usedDays.toFixed(1);
  var remLabel=remaining%1===0?remaining:remaining.toFixed(1);

  h+='<div class="cd cd-gn"><h3><span class="ic-accent-gn">'+ICO.chart+'</span> Holiday Tracker '+aYr+'</h3>';
  h+='<div class="sg" style="margin-bottom:14px">';
  h+='<div class="st" style="border-left:3px solid var(--gn)"><div class="st-l">Entitlement</div><div class="st-v" style="font-size:18px;color:var(--gn)">'+(holCfg.entitlement||28)+'</div><div class="st-s">days/year</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--or)"><div class="st-l">Used</div><div class="st-v" style="font-size:18px;color:var(--or)">'+usedLabel+'</div><div class="st-s">days</div></div>';
  h+='<div class="st" style="border-left:3px solid var(--bl)"><div class="st-l">Remaining</div><div class="st-v" style="font-size:18px;color:var(--bl2)">'+remLabel+'</div><div class="st-s">days left</div></div>';
  var holPay=calcHolPayRate();
  h+='<div class="st" style="border-left:3px solid var(--pu)"><div class="st-l">Uplift</div><div class="st-v" style="font-size:16px;color:var(--pu)">'+fmt(holPay.upliftHourly||0)+'</div><div class="st-s">/hr above base</div></div></div>';
  // Progress bar
  var pctUsed=holCfg.entitlement>0?usedDays/holCfg.entitlement*100:0;
  h+='<div style="background:var(--s3);height:8px;border-radius:4px;overflow:hidden;margin-bottom:14px"><div style="height:100%;width:'+Math.min(100,pctUsed)+'%;background:'+(pctUsed>90?'var(--rd)':pctUsed>70?'var(--or)':'var(--gn)')+';border-radius:4px;transition:.3s"></div></div>';

  // Holiday pay info
  h+='<div style="padding:10px;background:var(--glass2);border:1px solid var(--bd);border-radius:var(--rs);font-size:11px;margin-bottom:14px">';
  h+='<div style="font-weight:600;margin-bottom:4px">Holiday Pay \u2014 How It Works</div>';
  h+='<div style="color:var(--tx3)">When you take holiday your <strong>base pay continues</strong> as normal. SA &amp; compulsory OT are removed for the hours off, replaced by an <strong>uplift</strong> based on your average hourly rate over the last 52 paid weeks.</div>';
  if(holPay.weeks>0){
    h+='<div style="margin-top:6px">';
    h+='<div>Base hourly: <strong>'+fmt(holPay.baseHourly||0)+'</strong> \u00B7 Avg hourly: <strong>'+fmt(holPay.avgHourly||0)+'</strong></div>';
    h+='<div style="margin-top:2px">Uplift: <strong style="color:var(--gn)">'+fmt(holPay.upliftHourly||0)+'</strong>/hr \u00B7 Weekly avg: <strong>'+fmt(holPay.weeklyAvg||0)+'</strong></div>';
    h+='<div style="margin-top:2px;color:var(--tx3)">('+holPay.weeks+'-week reference period)</div>';
    h+='</div>';
  }

  // Settings
  h+='<div class="g2" style="margin-bottom:14px">';
  h+='<div class="fg"><label class="fl">Annual Entitlement</label><div class="iw"><input type="number" class="fi" value="'+(holCfg.entitlement||28)+'" min="0" step="0.5" onchange="holCfg.entitlement=+this.value||28;svHolCfg();rCal()"><span class="is">days</span></div></div>';
  h+='<div class="fg"><label class="fl">Known Avg Hourly Rate</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" value="'+(holCfg.lastKnownRate||'')+'" step=".01" placeholder="0" onchange="holCfg.lastKnownRate=+this.value||0;svHolCfg();rCal()"><span class="is">/hr</span></div><div class="fh">Your average hourly rate including SA, OT etc</div></div>';
  h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" '+(holCfg.useLastKnownRate?'checked':'')+' onchange="holCfg.useLastKnownRate=this.checked;svHolCfg();rCal()" style="accent-color:var(--bl);width:16px;height:16px"> Always use known rate</label><div class="fh">Override the 52-week calculation and use the rate above for all holiday uplift</div></div>';
  h+='</div>';

  // Holiday list
  if(yrHols.length){
    h+='<div style="margin-top:10px">';
    yrHols.forEach(function(hh){
      var s4=hh.startDate,e4=hh.endDate||hh.startDate;
      var durLabel='';
      if(hh.duration==='half-am')durLabel=' (½ AM)';
      else if(hh.duration==='half-pm')durLabel=' (½ PM)';
      else if(hh.duration==='hours')durLabel=' ('+fmtNum2(hh.hoursOff||0)+'h)';
      h+='<div class="ei"><span class="tg" style="background:rgba(34,197,94,.1);color:var(--gn)">HOLIDAY</span>';
      h+='<span style="font-size:12px">'+(hh.desc||'Annual leave')+durLabel+'</span>';
      h+='<span style="font-size:10px;color:var(--tx3)">'+fd(s4)+(s4!==e4?' \u2013 '+fd(e4):'')+'</span>';
      h+='<button class="db" onclick="delHoliday(\''+hh.id+'\')" style="background:0 0;border:none;color:var(--tx3);cursor:pointer;padding:2px">'+ICO.x+'</button></div>';
    });
    h+='</div>';
  }
  h+='</div>';

  document.getElementById('c-cal').innerHTML=h;
}

function calNav(d2){calMonth2+=d2;if(calMonth2>11){calMonth2=0;calYear2++}if(calMonth2<0){calMonth2=11;calYear2--}rCal()}
function calGoNow(){calMonth2=new Date().getMonth();calYear2=new Date().getFullYear();rCal()}
function calDayClick(dateStr){
  var sh4=getShiftForDate(dateStr);
  var hol4=isHoliday(dateStr);
  if(hol4){
    var durInfo=hol4.duration&&hol4.duration!=='full'?' ('+hol4.duration+')':'';
    if(confirm('Remove holiday on '+fd(dateStr)+'?\n\n"'+(hol4.desc||'Holiday')+'"'+durInfo)){delHoliday(hol4.id)}
    return;
  }
  if(sh4&&sh4.t!=='off'){
    // Open the holiday modal then pre-fill dates
    oHolM();
    setTimeout(function(){
      var startEl=document.getElementById('holStart');
      var endEl=document.getElementById('holEnd');
      if(startEl)startEl.value=dateStr;
      if(endEl)endEl.value=dateStr;
    },50);
  }
}
function oHolM(){
  var today2=new Date();var ts=today2.getFullYear()+'-'+String(today2.getMonth()+1).padStart(2,'0')+'-'+String(today2.getDate()).padStart(2,'0');
  var h2='<div class="fg"><label class="fl">Start Date</label><div class="iw"><input type="date" class="fi" id="holStart" value="'+ts+'" onchange="uHolPreview()"></div></div>';
  h2+='<div class="fg"><label class="fl">End Date</label><div class="iw"><input type="date" class="fi" id="holEnd" value="'+ts+'" onchange="uHolPreview()"></div><div class="fh">Same as start for single day</div></div>';
  h2+='<div class="fg"><label class="fl">Duration</label><select class="sf" id="holDuration" onchange="uHolDurChange()">';
  h2+='<option value="full">Full day(s)</option>';
  h2+='<option value="half-am">Half day (AM)</option>';
  h2+='<option value="half-pm">Half day (PM)</option>';
  h2+='<option value="hours">Custom hours</option>';
  h2+='</select></div>';
  h2+='<div class="fg" id="holHoursRow" style="display:none"><label class="fl">Hours off</label><div class="iw"><input type="number" class="fi" id="holHoursOff" value="4" min="0.5" max="12" step="0.5" onchange="uHolPreview()"><span class="is">hrs</span></div></div>';
  h2+='<div class="fg"><label class="fl">Description</label><div class="iw"><input type="text" class="fi" id="holDesc" value="Annual leave" placeholder="e.g. Family holiday"></div></div>';
  var holPay2=calcHolPayRate();
  h2+='<div id="holPreview" class="ib">';
  h2+=buildHolPreview(holPay2,'full',0);
  h2+='</div>';
  document.getElementById('eMT').textContent='Add Holiday';
  document.getElementById('eMSB').textContent='Add Holiday';
  document.getElementById('eMSB').setAttribute('onclick','sHolFromModal()');
  document.getElementById('eMB').innerHTML=h2;
  document.getElementById('eM').classList.add('o');
}
function buildHolPreview(hp,dur,hoursOff){
  var upliftH=hp.upliftHourly||0;
  var r='<div style="font-weight:600;margin-bottom:4px">Holiday Uplift (HMRC 52-week avg)</div>';
  r+='<div style="color:var(--tx3);font-size:11px">Base pay continues. SA &amp; compulsory OT removed for holiday hours, replaced by uplift based on your average hourly rate.</div>';
  r+='<div style="margin-top:6px;font-size:12px">';
  r+='Base: <strong>'+fmt(hp.baseHourly||0)+'</strong>/h \u00B7 Avg: <strong>'+fmt(hp.avgHourly||0)+'</strong>/h \u00B7 ';
  r+='<span style="color:var(--gn)">Uplift: <strong>'+fmt(upliftH)+'</strong>/h</span>';
  if(dur==='half-am'||dur==='half-pm')r+=' (est. '+fmt(upliftH*5.75)+' for \u00BD day)';
  else if(dur==='hours'&&hoursOff>0)r+=' (est. '+fmt(upliftH*hoursOff)+' for '+hoursOff+'h)';
  else r+=' (est. '+fmt(upliftH*11.5)+' per full day)';
  r+='</div>';
  if(hp.weeks>0)r+='<div style="margin-top:4px;font-size:11px;color:var(--tx3)">Based on '+hp.weeks+'-week reference period</div>';
  return r;
}
function uHolDurChange(){
  var dur=document.getElementById('holDuration').value;
  document.getElementById('holHoursRow').style.display=dur==='hours'?'':'none';
  // If half day or hours, lock end date = start date
  if(dur!=='full'){
    document.getElementById('holEnd').value=document.getElementById('holStart').value;
    document.getElementById('holEnd').disabled=true;
  } else {
    document.getElementById('holEnd').disabled=false;
  }
  uHolPreview();
}
function uHolPreview(){
  var hp=calcHolPayRate();
  var dur=document.getElementById('holDuration').value;
  var hoursOff=+(document.getElementById('holHoursOff')||{}).value||0;
  var el=document.getElementById('holPreview');
  if(el)el.innerHTML=buildHolPreview(hp,dur,hoursOff);
}
function sHolFromModal(){
  var s5=document.getElementById('holStart').value;
  var e5=document.getElementById('holEnd').value||s5;
  var desc5=document.getElementById('holDesc').value||'Annual leave';
  var dur=document.getElementById('holDuration').value;
  var hoursOff=dur==='hours'?+(document.getElementById('holHoursOff').value)||0:0;
  if(!s5){alert('Enter start date');return}
  if(dur!=='full')e5=s5; // half/hours only apply to single day
  if(e5<s5)e5=s5;
  addHoliday(s5,e5,desc5,dur,hoursOff);
  cEM();
  document.getElementById('eMSB').setAttribute('onclick','sEP()');
}

// ═══ SETUP WIZARD ═══
var wzStep=0,wzData={};
function wzOpen(){wzStep=0;wzData={profile:cfg.profile||'shift-rotating',payBasis:cfg.payBasis||'salaried',payFreq:cfg.payFreq||'monthly',payMode:cfg.payMode||'arrears',taxRegion:cfg.taxRegion||'england',sal:cfg.sal||0,shw:cfg.shw||39,hourlyRate:cfg.hourlyRate||0,hasOT:cfg.otRules&&cfg.otRules.some(function(r){return r.hours>0}),hasSA:cfg.shiftTypes&&cfg.shiftTypes.some(function(s){return s.allowancePct>0}),studentLoans:cfg.studentLoans||[],sacrifices:cfg.sacrifices||[],penPct:0};document.getElementById('wzM').classList.add('o');wzRender()}
function wzClose(){document.getElementById('wzM').classList.remove('o')}
function wzRender(){
  var h='',steps=['Work Type','Pay Details','Shift Pattern','Tax & Deductions','Review'];
  // Progress bar
  h+='<div style="display:flex;gap:4px;margin-bottom:16px">';
  steps.forEach(function(s,i){h+='<div style="flex:1;height:4px;border-radius:2px;background:'+(i<=wzStep?'var(--bl)':'var(--s3)')+'"></div>'});
  h+='</div><div style="font-size:10px;color:var(--tx3);margin-bottom:14px;text-transform:uppercase;letter-spacing:.5px;font-weight:600">Step '+(wzStep+1)+' of '+steps.length+': '+steps[wzStep]+'</div>';

  if(wzStep===0){
    // Work type
    h+='<div class="fg"><label class="fl">What best describes your work pattern?</label>';
    var profs=[{v:'shift-rotating',l:'Rotating shifts',d:'Repeating cycle (e.g. 4-on/4-off, 3-shift rotation, continental)'},{v:'shift-fixed',l:'Fixed shifts',d:'Same shift every week (e.g. permanent nights, fixed earlies)'},{v:'office-regular',l:'Regular hours',d:'Mon-Fri fixed hours (e.g. 9-5 office, standard working week)'},{v:'variable',l:'Variable / Zero hours',d:'No fixed pattern — hours vary week to week'},{v:'compressed',l:'Compressed hours',d:'Full-time hours in fewer days (e.g. 4x10h, 9-day fortnight)'}];
    profs.forEach(function(p){
      h+='<div onclick="wzData.profile=\''+p.v+'\';wzRender()" style="padding:12px;margin-bottom:8px;border:2px solid '+(wzData.profile===p.v?'var(--bl)':'var(--bd)')+';border-radius:var(--rs);cursor:pointer;background:'+(wzData.profile===p.v?'rgba(99,102,241,.06)':'var(--s2)')+'">';
      h+='<div style="font-weight:700;font-size:13px">'+p.l+'</div>';
      h+='<div style="font-size:11px;color:var(--tx3);margin-top:2px">'+p.d+'</div></div>';
    });
    h+='</div>';
    h+='<div class="g2">';
    h+='<div class="fg"><label class="fl">Pay Basis</label><select class="sf" onchange="wzData.payBasis=this.value;wzRender()"><option value="salaried"'+(wzData.payBasis==='salaried'?' selected':'')+'>Annual salary</option><option value="hourly"'+(wzData.payBasis==='hourly'?' selected':'')+'>Hourly rate</option></select></div>';
    h+='<div class="fg"><label class="fl">Pay Mode</label><select class="sf" onchange="wzData.payMode=this.value"><option value="arrears"'+(wzData.payMode==='arrears'?' selected':'')+'>Arrears (period based)</option><option value="current"'+(wzData.payMode==='current'?' selected':'')+'>Current month</option></select>';
    h+='<div class="fh">Arrears: pay based on shift period dates. Current: everything paid in the calendar month.</div></div>';
    h+='</div>';
  } else if(wzStep===1){
    // Pay details
    if(wzData.payBasis==='salaried'){
      h+='<div class="fg"><label class="fl">Annual Salary</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="wzSal" value="'+(wzData.sal||'')+'" step=".01" placeholder="e.g. 30000" onchange="wzData.sal=+this.value"></div></div>';
    } else {
      h+='<div class="fg"><label class="fl">Hourly Rate</label><div class="iw"><span class="ip">'+P+'</span><input type="number" class="fi" id="wzHR" value="'+(wzData.hourlyRate||'')+'" step=".01" placeholder="e.g. 12.50" onchange="wzData.hourlyRate=+this.value"></div></div>';
    }
    h+='<div class="fg"><label class="fl">Contracted Hours / Week</label><div class="iw"><input type="number" class="fi" id="wzShw" value="'+(wzData.shw||39)+'" step=".5" onchange="wzData.shw=+this.value"><span class="is">hrs</span></div></div>';
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="wzHasOT" '+(wzData.hasOT?'checked':'')+' onchange="wzData.hasOT=this.checked" style="accent-color:var(--bl);width:16px;height:16px"> Compulsory overtime built into shifts</label>';
    h+='<div class="fh">Tick if your shifts include mandatory overtime hours (common in shift work)</div></div>';
    h+='<div class="fg"><label class="fl" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="wzHasSA" '+(wzData.hasSA?'checked':'')+' onchange="wzData.hasSA=this.checked" style="accent-color:var(--bl);width:16px;height:16px"> Shift allowance / unsocial hours enhancement</label>';
    h+='<div class="fh">Extra pay for working shifts, nights, weekends, etc.</div></div>';
  } else if(wzStep===2){
    // Shift pattern
    var isShift=wzData.profile.indexOf('shift')>=0||wzData.profile==='compressed';
    if(isShift){
      h+='<div class="ib" style="margin-top:0;margin-bottom:14px">Define your shift cycle. This repeats continuously from your start date. You can always adjust individual days later.</div>';
      h+='<p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Common patterns:</p>';
      var presets=[
        {l:'4-on/4-off (Day/Night)',d:'D D N N Off Off Off Off',sp:[{t:'day',h:11.25},{t:'day',h:11.25},{t:'night',h:11.25},{t:'night',h:11},{t:'off'},{t:'off'},{t:'off'},{t:'off'}]},
        {l:'3-shift weekly rotation',d:'E E E E E Off Off | A A A A A Off Off | N N N N N Off Off',sp:[{t:'early',h:8},{t:'early',h:8},{t:'early',h:8},{t:'early',h:8},{t:'early',h:8},{t:'off'},{t:'off'},{t:'afternoon',h:8},{t:'afternoon',h:8},{t:'afternoon',h:8},{t:'afternoon',h:8},{t:'afternoon',h:8},{t:'off'},{t:'off'},{t:'night',h:8},{t:'night',h:8},{t:'night',h:8},{t:'night',h:8},{t:'night',h:8},{t:'off'},{t:'off'}]},
        {l:'2-2-3 Continental',d:'D D Off Off D D D Off Off N N Off Off N N N Off Off Off Off',sp:[{t:'day',h:12},{t:'day',h:12},{t:'off'},{t:'off'},{t:'day',h:12},{t:'day',h:12},{t:'day',h:12},{t:'off'},{t:'off'},{t:'night',h:12},{t:'night',h:12},{t:'off'},{t:'off'},{t:'night',h:12},{t:'night',h:12},{t:'night',h:12},{t:'off'},{t:'off'},{t:'off'},{t:'off'}]},
        {l:'Mon-Fri (5 on / 2 off)',d:'W W W W W Off Off',sp:[{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'off'},{t:'off'}]},
        {l:'4-day compressed',d:'W W W W Off Off Off',sp:[{t:'day',h:10},{t:'day',h:10},{t:'day',h:10},{t:'day',h:10},{t:'off'},{t:'off'},{t:'off'}]}
      ];
      presets.forEach(function(pr){
        h+='<div onclick="wzApplyPreset('+JSON.stringify(pr.sp).replace(/"/g,'&quot;')+')" style="padding:10px;margin-bottom:6px;border:1px solid var(--bd);border-radius:var(--rs);cursor:pointer;background:var(--s2)">';
        h+='<div style="font-weight:700;font-size:12px">'+pr.l+'</div>';
        h+='<div style="font-size:10px;color:var(--tx3);margin-top:2px;font-family:\'Geist Mono\',monospace">'+pr.d+'</div></div>';
      });
      h+='<div class="fh" style="margin-top:10px">You can customise the exact pattern in Settings after completing setup.</div>';
    } else {
      h+='<div class="ib" style="margin-top:0">For regular hours, the default Mon-Fri pattern will be used. You can adjust this in Settings.</div>';
      wzData.preset=[{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'day',h:8},{t:'off'},{t:'off'}];
    }
  } else if(wzStep===3){
    // Tax & deductions
    h+='<div class="fg"><label class="fl">Pension Sacrifice %</label><div class="iw"><input type="number" class="fi" value="'+(wzData.penPct||0)+'" min="0" max="50" step="1" onchange="wzData.penPct=+this.value" placeholder="e.g. 6"><span class="is">%</span></div><div class="fh">Your pension sacrifice percentage. Set to 0 if none or if you\'ll configure later.</div></div>';
    h+='<div class="fg"><label class="fl">Tax Region</label><select class="sf" onchange="wzData.taxRegion=this.value"><option value="england"'+(wzData.taxRegion==='england'?' selected':'')+'>England / Wales / NI</option><option value="scotland"'+(wzData.taxRegion==='scotland'?' selected':'')+'>Scotland</option></select></div>';
    h+='<div class="fg"><label class="fl">Student Loans (select all that apply)</label>';
    var slLabels={plan1:'Plan 1 (pre-2012)',plan2:'Plan 2 (post-2012)',plan4:'Plan 4 (Scottish)',plan5:'Plan 5 (post-2023)',postgrad:'Postgraduate'};
    ['plan1','plan2','plan4','plan5','postgrad'].forEach(function(p){
      var active=wzData.studentLoans.indexOf(p)>=0;
      h+='<label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;margin-bottom:6px"><input type="checkbox" '+(active?'checked':'')+' onchange="var i=wzData.studentLoans.indexOf(\''+p+'\');if(i>=0)wzData.studentLoans.splice(i,1);else wzData.studentLoans.push(\''+p+'\')" style="accent-color:var(--bl);width:16px;height:16px"> '+slLabels[p]+'</label>';
    });
    h+='</div>';
  } else if(wzStep===4){
    // Review
    h+='<div style="font-size:14px;font-weight:700;margin-bottom:12px;color:var(--gn)">Review Your Setup</div>';
    h+='<div class="sg2" style="font-size:13px">';
    h+='<span class="sl">Work pattern:</span><span class="sv">'+(wzData.profile||'').replace(/-/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase()})+'</span>';
    h+='<span class="sl">Pay basis:</span><span class="sv">'+(wzData.payBasis==='hourly'?'Hourly ('+fmt(wzData.hourlyRate)+'/hr)':'Salaried ('+fmt(wzData.sal)+'/yr)')+'</span>';
    h+='<span class="sl">Hours/week:</span><span class="sv">'+wzData.shw+'h</span>';
    h+='<span class="sl">Pay mode:</span><span class="sv">'+(wzData.payMode==='current'?'Current month':'Arrears')+'</span>';
    h+='<span class="sl">Tax region:</span><span class="sv">'+(wzData.taxRegion==='scotland'?'Scotland':'England/Wales/NI')+'</span>';
    h+='<span class="sl">Compulsory OT:</span><span class="sv">'+(wzData.hasOT?'Yes':'No')+'</span>';
    h+='<span class="sl">Shift allowance:</span><span class="sv">'+(wzData.hasSA?'Yes':'No')+'</span>';
    if(wzData.penPct>0)h+='<span class="sl">Pension sacrifice:</span><span class="sv">'+wzData.penPct+'%</span>';
    if(wzData.studentLoans.length)h+='<span class="sl">Student loans:</span><span class="sv">'+wzData.studentLoans.join(', ')+'</span>';
    h+='</div>';
    h+='<div class="ib" style="margin-top:14px">Hit Apply to save. All settings can be fine-tuned afterwards in the Settings panel.</div>';
  }
  document.getElementById('wzMB').innerHTML=h;
  // Footer buttons
  var fh='';
  if(wzStep>0)fh+='<button class="btn bg" onclick="wzStep--;wzRender()">\u2190 Back</button>';
  if(wzStep<4)fh+='<button class="btn bp" onclick="wzNext()">Next \u2192</button>';
  else fh+='<button class="btn bp" onclick="wzApply()" style="background:var(--gng)">\u2713 Apply Setup</button>';
  document.getElementById('wzMF').innerHTML=fh;
}
function wzNext(){wzStep++;wzRender()}
function wzApplyPreset(sp){wzData.preset=sp;wzData.presetApplied=true;wzNext()}
function wzApply(){
  // Apply wizard settings to cfg
  cfg.profile=wzData.profile;
  cfg.payBasis=wzData.payBasis;
  cfg.payMode=wzData.payMode;
  cfg.taxRegion=wzData.taxRegion;
  cfg.studentLoans=wzData.studentLoans;
  if(wzData.payBasis==='salaried'){cfg.sal=wzData.sal;cfg.hourlyRate=0}
  else{cfg.hourlyRate=wzData.hourlyRate;cfg.sal=wzData.hourlyRate*wzData.shw*52}
  cfg.shw=wzData.shw;
  // Shift types based on pattern
  if(wzData.preset){
    cfg.sp=JSON.parse(JSON.stringify(wzData.preset));
    // Auto-detect shift types needed
    var typeSet={};cfg.sp.forEach(function(s){if(s.t)typeSet[s.t]=true});
    var newTypes=[];
    Object.keys(typeSet).forEach(function(t){
      if(t==='off'){newTypes.push({id:'off',label:'Off',hours:0,totalHours:0,allowancePct:0,color:'var(--tx3)'})}
      else if(t==='day'){var h0=cfg.sp.filter(function(s){return s.t==='day'})[0].h||8;newTypes.push({id:'day',label:'Day',hours:h0,totalHours:h0+0.5,allowancePct:wzData.hasSA?33.33:0,color:'var(--gn)'})}
      else if(t==='night'){var h1=cfg.sp.filter(function(s){return s.t==='night'})[0].h||8;newTypes.push({id:'night',label:'Night',hours:h1,totalHours:h1+0.5,allowancePct:wzData.hasSA?33.33:0,color:'var(--bl)'})}
      else if(t==='early'){newTypes.push({id:'early',label:'Early',hours:8,totalHours:8.5,allowancePct:0,color:'var(--gn)'})}
      else if(t==='afternoon'){newTypes.push({id:'afternoon',label:'Afternoon',hours:8,totalHours:8.5,allowancePct:wzData.hasSA?20:0,color:'var(--or)'})}
      else{newTypes.push({id:t,label:t.charAt(0).toUpperCase()+t.slice(1),hours:8,totalHours:8.5,allowancePct:wzData.hasSA?20:0,color:'var(--pu)'})}
    });
    cfg.shiftTypes=newTypes;
  }
  // OT rules based on setting
  if(!wzData.hasOT){cfg.otRules=[{days:[0,1,2,3,4,5,6],hours:0,rate:1,label:'None'}]}
  cfg.setupDone=true;
  // Auto-hide tabs not relevant to work pattern
  if(wzData.profile==='office-regular'||wzData.profile==='variable'){
    // Office/variable workers don't need periods tab usually
    hiddenTabs=hiddenTabs.filter(function(t){return t!=='per'});
    // Don't auto-hide, but suggest
  }
  // Apply pension sacrifice to all periods
  if(wzData.penPct>0){
    var pctVal=wzData.penPct/100;
    years[aYr].periods.forEach(function(p){p.penPct=pctVal});
  }
  save();wzClose();rAll();sw(aTab);if(document.getElementById('sDw').classList.contains('o'))rS();
}

init();

// ═══ PWA SERVICE WORKER ═══
if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('sw.js').then(function(reg){
      console.log('SW registered',reg.scope);
    }).catch(function(err){
      console.log('SW registration failed',err);
    });
  });
}
</script>
</body>
</html>
